import re
import logging
import asyncio
from datetime import datetime, timedelta
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import Application, CommandHandler, CallbackQueryHandler, MessageHandler, filters, CallbackContext
from telegram.error import TimedOut, BadRequest, Forbidden
import database as db
import os
import pytz
import httpx

# ================== –ù–ê–°–¢–†–û–ô–ö–ê –õ–û–ì–ò–†–û–í–ê–ù–ò–Ø ==================
logging.basicConfig(format='%(asctime)s - %(name)s - %(levelname)s - %(message)s', level=logging.INFO)
logger = logging.getLogger(__name__)

# ================== –ö–≠–®–ò–†–û–í–ê–ù–ò–ï –¢–ï–•–†–ï–ñ–ò–ú–ê ==================
_maintenance_cache = {'enabled': False, 'until': None, 'message': None, 'last_check': datetime.min}
MAINTENANCE_CACHE_TTL = 60  # —Å–µ–∫—É–Ω–¥

TOKEN = os.environ.get('BOT_TOKEN')
if not TOKEN:
    print("–û–®–ò–ë–ö–ê: –¢–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω! –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è BOT_TOKEN")
    exit(1)

# ================== –ù–ê–°–¢–†–û–ô–ö–ê –ò–ò (Groq Free) ==================
GROQ_API_KEY = os.environ.get('GROQ_API_KEY')
GROQ_MODEL = "llama-3.1-8b-instant"  # –ë—ã—Å—Ç—Ä–∞—è –∏ –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–∞—è –º–æ–¥–µ–ª—å
if GROQ_API_KEY:
    GPT_AVAILABLE = True
    logger.info(f"‚úÖ –ò–ò-–ø–æ–º–æ—â–Ω–∏–∫ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω (Groq: {GROQ_MODEL})")
else:
    GPT_AVAILABLE = False
    logger.warning("‚ö†Ô∏è GROQ_API_KEY –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω. –ò–ò –±—É–¥–µ—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.")

# ================== –ù–ê–°–¢–†–û–ô–ö–ò ==================
ADMIN_IDS = [516406248]
REQUEST_TIMEOUT = 30.0
TEACHER_IDS = {
    '–ö–æ—Ä–æ—Ç—á–∏–∫–æ–≤–∞ –õ.–í.': 1665763898,
    '–í–µ—Ä–≥–µ–π—á–∏–∫ –í.–õ.': 1970780275,
    '–ù–µ—á–∞–µ–≤–∞ –ï.–Ø.': 0,
    '–õ–µ–±–µ–¥–µ–≤—Å–∫–∞—è –ú.–ü.': 0,
    '–°–∏–≤—ã–π –ê.–í.': 0,
    '–ü–∏–Ω—á—É–∫ –ê.–í.': 0,
    '–Æ–Ω–∞—Ö –¢.–í.': 0,
    '–ë–µ–ª—å—Å–∫–∏–π –°.–í.': 0,
    '–ù–∞–∑–∞—Ä–µ–Ω–∫–æ –¢.–ö.': 0,
    '–ë—Ä–µ–ª—å –Æ.–í.': 0,
    '–®–∞—Ç–∏–ª–æ –ù.–ò.': 0,
    '–ö–æ–≤–∞–ª—å—á—É–∫ –ö.–†.': 0,
    '–¢–∏—Ö–æ–Ω–µ–Ω–∫–æ –û.–ê.': 0,
    '–ú–µ–ª–µ–∂ –ê.–ì.': 0,
    '–ú–∏—Ö–∞—Å—ë–≤ –í.–ê.': 0,
    '–ü—Ä–∏—Ö–∞—á –ï.–í.': 967925839,
    '–ú–∏—Ö–∞–ª–∫–æ –ï.–ü.': 0,
    '–Ø–≤–æ—à –°.–í.': 0,
    '–ì–∞–ø–æ–Ω–µ–Ω–∫–æ –Æ.–í.': 0,
    '–ü—Ä–∏—Ö–æ–¥—å–∫–æ –ò.–ù.': 0,
    '–ì—É–¥ –Æ.–ü.': 516406248,
    '–°–º–æ–ª—å—Å–∫–∏–π –°.–ú.': 0,
    '–°—Ç–∏—à–µ–Ω–æ–∫ –ù.–ò.': 0,
    '–ê–Ω–∏—Å–∫–æ–≤–µ—Ü –ù.–í.': 0,
    '–ê–Ω–∏—Å–µ–Ω–∫–æ –°.–í.': 0,
    '–ö–æ—Ä–æ–ª—ë–≤–∞ –ñ.–í.': 0,
    '–ì—Ä–∏—Ü–∫–µ–≤–∏—á –õ.–í.': 0,
    '–î–∞–Ω–∏–ª–µ–Ω–∫–æ –ê.–ê.': 0,
    '–ó—É–±–æ–∫ –°.–ù.': 0,
    '–ö–∞–Ω—É–Ω–æ–≤–∞ –í.–ì.': 0,
    '–ö–æ—Ä–æ–ª—å—á—É–∫ –û.–ì.': 0,
    '–õ–µ–æ–Ω–æ–≤–∞ –î.–ê.': 7241182510,
    '–õ—É–∫—å—è–Ω–µ–Ω–∫–æ –õ.–ò.': 0,
    '–®—Ç—ã—Ö–Ω–æ–≤–∞ –õ.–ì.': 0,
    '–ê—Ä—Ç—é—Ö –ú.–ü.': 0,
    '–•–æ—Ä–æ—à–∫–æ –¢.–ê.': 0
}
ALL_CLASSES = ['5–∞', '5–±', '5–≤', '6–∞', '6–±', '6–≤', '7–∞', '7–±', '7–≤', '8–∞', '8–±', '9–∞', '9–±', '10–∞', '10–±', '11']
SUBJECTS = [
    "–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞", "–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞(–ø—Ä–æ—Ñ.)", "–†—É—Å—Å–∫–∏–π —è–∑—ã–∫", "–†—É—Å—Å–∫–∏–π —è–∑—ã–∫(–ø—Ä–æ—Ñ.)",
    "–ë–µ–ª–æ—Ä—É—Å—Å–∫–∏–π —è–∑—ã–∫", "–ë–µ–ª–æ—Ä—É—Å—Å–∫–∏–π —è–∑—ã–∫(–ø—Ä–æ—Ñ.)", "–†—É—Å—Å–∫–∞—è –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞",
    "–ë–µ–ª–æ—Ä—É—Å—Å–∫–∞—è –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞", "–§–∏–∑–∏–∫–∞", "–ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–∫–∞",
    "–ê–Ω–≥–ª–∏–π—Å–∫–∏–π —è–∑—ã–∫", "–ê–Ω–≥–ª–∏–π—Å–∫–∏–π —è–∑—ã–∫(–ø—Ä–æ—Ñ.)", "–•–∏–º–∏—è", "–•–∏–º–∏—è(–ø—Ä–æ—Ñ.)",
    "–ë–∏–æ–ª–æ–≥–∏—è", "–ë–∏–æ–ª–æ–≥–∏—è(–ø—Ä–æ—Ñ.)", "–û–±—â–µ—Å—Ç–≤–æ–≤–µ–¥–µ–Ω–∏–µ", "–û–±—â–µ—Å—Ç–≤–æ–≤–µ–¥–µ–Ω–∏–µ(–ø—Ä–æ—Ñ.)",
    "–ò—Å—Ç–æ—Ä–∏—è", "–ì–µ–æ–≥—Ä–∞—Ñ–∏—è", "–§–∏–∑–∫—É–ª—å—Ç—É—Ä–∞", "–û–ë–ñ", "–¢—Ä—É–¥–æ–≤–æ–µ –æ–±—É—á–µ–Ω–∏–µ",
    "–ò—Å–∫—É—Å—Å—Ç–≤–æ", "–ê—Å—Ç—Ä–æ–Ω–æ–º–∏—è", "–ß–ó–°", "–ß–µ—Ä—á–µ–Ω–∏–µ", "–î–ü", "–ú–ü", "–ß–µ–ª–æ–≤–µ–∫ –∏ –º–∏—Ä"
]
DAYS_OF_WEEK = ["–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫", "–í—Ç–æ—Ä–Ω–∏–∫", "–°—Ä–µ–¥–∞", "–ß–µ—Ç–≤–µ—Ä–≥", "–ü—è—Ç–Ω–∏—Ü–∞"]
BELLS_SCHEDULE_HTML = """
üïí –†–ê–°–ü–ò–°–ê–ù–ò–ï –ó–í–û–ù–ö–û–í –ò –ü–ò–¢–ê–ù–ò–Ø
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
üîî 1 —É—Ä–æ–∫:    08:00 ‚Äì 08:45
üîî 2 —É—Ä–æ–∫:    09:00 ‚Äì 09:45
üîî 3 —É—Ä–æ–∫:    10:00 ‚Äì 10:45
üçΩÔ∏è –û–±–µ–¥ –¥–ª—è 5-7 –∫–ª–∞—Å—Å–æ–≤
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
üîî 4 —É—Ä–æ–∫:    11:00 ‚Äì 11:45
üçΩÔ∏è –û–±–µ–¥ –¥–ª—è 8-11 –∫–ª–∞—Å—Å–æ–≤
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
üîî 5 —É—Ä–æ–∫:    12:00 ‚Äì 12:45
üîî 6 —É—Ä–æ–∫:    12:55 ‚Äì 13:40
üçé –ü–æ–ª–¥–Ω–∏–∫ –¥–ª—è –≤—Å–µ—Ö
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
üîî 7 —É—Ä–æ–∫:    14:00 ‚Äì 14:45
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
"""

# ================== –°–¢–†–£–ö–¢–£–†–ò–†–û–í–ê–ù–ù–û–ï –†–ê–°–ü–ò–°–ê–ù–ò–ï ==================
SCHEDULE_STRUCTURED = {
    '5–∞': {
        '–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫': [
            (1, '–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞', '–ö–æ—Ä–æ—Ç—á–∏–∫–æ–≤–∞ –õ.–í.'),
            (2, '–§–∏–∑–∫—É–ª—å—Ç—É—Ä–∞', '–í–µ—Ä–≥–µ–π—á–∏–∫ –í.–õ.'),
            (3, '–ê–Ω–≥–ª–∏–π—Å–∫–∏–π —è–∑—ã–∫', '–ù–µ—á–∞–µ–≤–∞ –ï.–Ø./–ü—Ä–∏—Ö–æ–¥—å–∫–æ –ò.–ù.'),
            (4, '–ë–µ–ª–æ—Ä—É—Å—Å–∫–∏–π —è–∑—ã–∫', '–õ–µ–±–µ–¥–µ–≤—Å–∫–∞—è –ú.–ü.'),
            (5, '–ò—Å—Ç–æ—Ä–∏—è', '–°–∏–≤—ã–π –ê.–í.'),
        ],
        '–í—Ç–æ—Ä–Ω–∏–∫': [
            (1, '–†—É—Å. –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞', '–ü–∏–Ω—á—É–∫ –ê.–í.'),
            (2, '–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞', '–ö–æ—Ä–æ—Ç—á–∏–∫–æ–≤–∞ –õ.–í.'),
            (3, '–†—É—Å—Å–∫–∏–π —è–∑—ã–∫', '–ü–∏–Ω—á—É–∫ –ê.–í.'),
            (4, '–§–∏–∑–∫—É–ª—å—Ç—É—Ä–∞', '–í–µ—Ä–≥–µ–π—á–∏–∫ –í.–õ.'),
            (5, '–ê–Ω–≥–ª–∏–π—Å–∫–∏–π —è–∑—ã–∫', '–ù–µ—á–∞–µ–≤–∞ –ï.–Ø./–ü—Ä–∏—Ö–æ–¥—å–∫–æ –ò.–ù.'),
        ],
        '–°—Ä–µ–¥–∞': [
            (1, '–û–ë–ñ', '–Æ–Ω–∞—Ö –¢.–í.'),
            (2, '–†—É—Å—Å–∫–∏–π —è–∑—ã–∫', '–ü–∏–Ω—á—É–∫ –ê.–í.'),
            (3, '–¢—Ä—É–¥–æ–≤–æ–µ –æ–±—É—á–µ–Ω–∏–µ', '–ú–µ–ª–µ–∂ –ê.–ì./–ú–∏—Ö–∞—Å—ë–≤ –í.–ê.'),
            (4, '–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞', '–ö–æ—Ä–æ—Ç—á–∏–∫–æ–≤–∞ –õ.–í.'),
            (5, '–ê–Ω–≥–ª–∏–π—Å–∫–∏–π —è–∑—ã–∫', '–ù–µ—á–∞–µ–≤–∞ –ï.–Ø./–ü—Ä–∏—Ö–æ–¥—å–∫–æ –ò.–ù.'),
            (6, '–ê–Ω–≥–ª–∏–π—Å–∫–∏–π —è–∑—ã–∫', '–ü—Ä–∏—Ö–æ–¥—å–∫–æ –ò.–ù.'),
        ],
        '–ß–µ—Ç–≤–µ—Ä–≥': [
            (1, '–ë–µ–ª. –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞', '–õ–µ–±–µ–¥–µ–≤—Å–∫–∞—è –ú.–ü.'),
            (2, '–†—É—Å—Å–∫–∏–π —è–∑—ã–∫', '–ü–∏–Ω—á—É–∫ –ê.–í.'),
            (3, '–ë–µ–ª–æ—Ä—É—Å—Å–∫–∏–π —è–∑—ã–∫', '–õ–µ–±–µ–¥–µ–≤—Å–∫–∞—è –ú.–ü.'),
            (4, '–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞', '–ö–æ—Ä–æ—Ç—á–∏–∫–æ–≤–∞ –õ.–í.'),
            (5, '–ò—Å—Ç–æ—Ä–∏—è', '–°–∏–≤—ã–π –ê.–í.'),
        ],
        '–ü—è—Ç–Ω–∏—Ü–∞': [
            (1, '–†—É—Å. –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞', '–ü–∏–Ω—á—É–∫ –ê.–í.'),
            (2, '–ë–µ–ª–æ—Ä—É—Å—Å–∫–∏–π —è–∑—ã–∫', '–õ–µ–±–µ–¥–µ–≤—Å–∫–∞—è –ú.–ü.'),
            (3, '–ò—Å–∫—É—Å—Å—Ç–≤–æ', '–ë–µ–ª—å—Å–∫–∏–π –°.–í.'),
            (4, '–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞', '–ö–æ—Ä–æ—Ç—á–∏–∫–æ–≤–∞ –õ.–í.'),
            (5, '–ß–µ–ª–æ–≤–µ–∫ –∏ –º–∏—Ä', '–ë–µ–ª—å—Å–∫–∏–π –°.–í.'),
            (6, '–§–∏–∑–∫—É–ª—å—Ç—É—Ä–∞', '–í–µ—Ä–≥–µ–π—á–∏–∫ –í.–õ.'),
        ]
    },
    '5–±': {
        '–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫': [
            (1, '–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞', '–ù–∞–∑–∞—Ä–µ–Ω–∫–æ –¢.–ö.'),
            (2, '–†—É—Å—Å–∫–∏–π —è–∑—ã–∫', '–®–∞—Ç–∏–ª–æ –ù.–ò.'),
            (3, '–ê–Ω–≥–ª–∏–π—Å–∫–∏–π —è–∑—ã–∫', '–ö–æ–≤–∞–ª—å—á—É–∫ –ö.–†./–¢–∏—Ö–æ–Ω–µ–Ω–∫–æ –û.–ê.'),
            (4, '–§–∏–∑–∫—É–ª—å—Ç—É—Ä–∞', '–í–µ—Ä–≥–µ–π—á–∏–∫ –í.–õ.'),
            (5, '–û–ë–ñ', '–Æ–Ω–∞—Ö –¢.–í.'),
        ],
        '–í—Ç–æ—Ä–Ω–∏–∫': [
            (1, '–ë–µ–ª. –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞', '–ë—Ä–µ–ª—å –Æ.–í.'),
            (2, '–ë–µ–ª–æ—Ä—É—Å—Å–∫–∏–π —è–∑—ã–∫', '–ë—Ä–µ–ª—å –Æ.–í.'),
            (3, '–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞', '–ù–∞–∑–∞—Ä–µ–Ω–∫–æ –¢.–ö.'),
            (4, '–ê–Ω–≥–ª–∏–π—Å–∫–∏–π —è–∑—ã–∫', '–ö–æ–≤–∞–ª—å—á—É–∫ –ö.–†./–¢–∏—Ö–æ–Ω–µ–Ω–∫–æ –û.–ê.'),
            (5, '–†—É—Å. –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞', '–®–∞—Ç–∏–ª–æ –ù.–ò.'),
            (6, '–ß–µ–ª–æ–≤–µ–∫ –∏ –º–∏—Ä', '–ë–µ–ª—å—Å–∫–∏–π –°.–í.'),
        ],
        '–°—Ä–µ–¥–∞': [
            (1, '–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞', '–ù–∞–∑–∞—Ä–µ–Ω–∫–æ –¢.–ö.'),
            (2, '–§–∏–∑–∫—É–ª—å—Ç—É—Ä–∞', '–í–µ—Ä–≥–µ–π—á–∏–∫ –í.–õ.'),
            (3, '–†—É—Å—Å–∫–∏–π —è–∑—ã–∫', '–®–∞—Ç–∏–ª–æ –ù.–ò.'),
            (4, '–ò—Å–∫—É—Å—Å—Ç–≤–æ', '–ë–µ–ª—å—Å–∫–∏–π –°.–í.'),
            (5, '–ò—Å—Ç–æ—Ä–∏—è', '–°–∏–≤—ã–π –ê.–í.'),
        ],
        '–ß–µ—Ç–≤–µ—Ä–≥': [
            (1, '–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞', '–ù–∞–∑–∞—Ä–µ–Ω–∫–æ –¢.–ö.'),
            (2, '–ê–Ω–≥–ª–∏–π—Å–∫–∏–π —è–∑—ã–∫', '–ö–æ–≤–∞–ª—å—á—É–∫ –ö.–†./–¢–∏—Ö–æ–Ω–µ–Ω–∫–æ –û.–ê.'),
            (3, '–†—É—Å—Å–∫–∏–π —è–∑—ã–∫', '–®–∞—Ç–∏–ª–æ –ù.–ò.'),
            (4, '–†—É—Å. –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞', '–®–∞—Ç–∏–ª–æ –ù.–ò.'),
            (5, '–ë–µ–ª–æ—Ä—É—Å—Å–∫–∏–π —è–∑—ã–∫', '–ë—Ä–µ–ª—å –Æ.–í.'),
            (6, '–¢—Ä—É–¥–æ–≤–æ–µ –æ–±—É—á–µ–Ω–∏–µ', '–ú–µ–ª–µ–∂ –ê.–ì./–ú–∏—Ö–∞—Å—ë–≤ –í.–ê.'),
        ],
        '–ü—è—Ç–Ω–∏—Ü–∞': [
            (1, '–§–∏–∑–∫—É–ª—å—Ç—É—Ä–∞', '–í–µ—Ä–≥–µ–π—á–∏–∫ –í.–õ.'),
            (2, '–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞', '–ù–∞–∑–∞—Ä–µ–Ω–∫–æ –¢.–ö.'),
            (3, '–ò—Å—Ç–æ—Ä–∏—è', '–°–∏–≤—ã–π –ê.–í.'),
            (4, '–ë–µ–ª–æ—Ä—É—Å—Å–∫–∏–π —è–∑—ã–∫', '–ë—Ä–µ–ª—å –Æ.–í.'),
            (5, '–ë–µ–ª. –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞', '–ë—Ä–µ–ª—å –Æ.–í.'),
        ]
    },
    '5–≤': {
        '–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫': [
            (1, '–†—É—Å—Å–∫–∏–π —è–∑—ã–∫', '–ú–∏—Ö–∞–ª–∫–æ –ï.–ü.'),
            (2, '–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞', '–ü—Ä–∏—Ö–∞—á –ï.–í.'),
            (3, '–ò—Å—Ç–æ—Ä–∏—è', '–°–∏–≤—ã–π –ê.–í.'),
            (4, '–ê–Ω–≥–ª–∏–π—Å–∫–∏–π —è–∑—ã–∫', '–ö–æ–≤–∞–ª—å—á—É–∫ –ö.–†./–¢–∏—Ö–æ–Ω–µ–Ω–∫–æ –û.–ê.'),
            (5, '–§–∏–∑–∫—É–ª—å—Ç—É—Ä–∞', '–Ø–≤–æ—à –°.–í.'),
            (6, '–†—É—Å. –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞', '–ú–∏—Ö–∞–ª–∫–æ –ï.–ü.'),
        ],
        '–í—Ç–æ—Ä–Ω–∏–∫': [
            (1, '–§–∏–∑–∫—É–ª—å—Ç—É—Ä–∞', '–Ø–≤–æ—à –°.–í.'),
            (2, '–†—É—Å—Å–∫–∏–π —è–∑—ã–∫', '–ú–∏—Ö–∞–ª–∫–æ –ï.–ü.'),
            (3, '–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞', '–ü—Ä–∏—Ö–∞—á –ï.–í.'),
            (4, '–ß–µ–ª–æ–≤–µ–∫ –∏ –º–∏—Ä', '–ë–µ–ª—å—Å–∫–∏–π –°.–í.'),
            (5, '–†—É—Å. –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞', '–ú–∏—Ö–∞–ª–∫–æ –ï.–ü.'),
        ],
        '–°—Ä–µ–¥–∞': [
            (1, '–ë–µ–ª. –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞', '–ì–∞–ø–æ–Ω–µ–Ω–∫–æ –Æ.–í.'),
            (2, '–ê–Ω–≥–ª–∏–π—Å–∫–∏–π —è–∑—ã–∫', '–ö–æ–≤–∞–ª—å—á—É–∫ –ö.–†./–¢–∏—Ö–æ–Ω–µ–Ω–∫–æ –û.–ê.'),
            (3, '–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞', '–ü—Ä–∏—Ö–∞—á –ï.–í.'),
            (4, '–ë–µ–ª–æ—Ä—É—Å—Å–∫–∏–π —è–∑—ã–∫', '–ì–∞–ø–æ–Ω–µ–Ω–∫–æ –Æ.–í.'),
            (5, '–ò—Å–∫—É—Å—Å—Ç–≤–æ', '–ë–µ–ª—å—Å–∫–∏–π –°.–í.'),
        ],
        '–ß–µ—Ç–≤–µ—Ä–≥': [
            (1, '–¢—Ä—É–¥–æ–≤–æ–µ –æ–±—É—á–µ–Ω–∏–µ', '–ú–µ–ª–µ–∂ –ê.–ì./–ú–∏—Ö–∞—Å—ë–≤ –í.–ê.'),
            (2, '–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞', '–ü—Ä–∏—Ö–∞—á –ï.–í.'),
            (3, '–†—É—Å—Å–∫–∏–π —è–∑—ã–∫', '–ú–∏—Ö–∞–ª–∫–æ –ï.–ü.'),
            (4, '–ê–Ω–≥–ª–∏–π—Å–∫–∏–π —è–∑—ã–∫', '–ö–æ–≤–∞–ª—å—á—É–∫ –ö.–†./–¢–∏—Ö–æ–Ω–µ–Ω–∫–æ –û.–ê.'),
            (5, '–ë–µ–ª–æ—Ä—É—Å—Å–∫–∏–π —è–∑—ã–∫', '–ì–∞–ø–æ–Ω–µ–Ω–∫–æ –Æ.–í.'),
            (6, '–ë–µ–ª. –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞', '–ì–∞–ø–æ–Ω–µ–Ω–∫–æ –Æ.–í.'),
        ],
        '–ü—è—Ç–Ω–∏—Ü–∞': [
            (1, '–û–ë–ñ', '–Æ–Ω–∞—Ö –¢.–í.'),
            (2, '–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞', '–ü—Ä–∏—Ö–∞—á –ï.–í.'),
            (3, '–§–∏–∑–∫—É–ª—å—Ç—É—Ä–∞', '–Ø–≤–æ—à –°.–í.'),
            (4, '–ò—Å—Ç–æ—Ä–∏—è', '–°–∏–≤—ã–π –ê.–í.'),
            (5, '–ë–µ–ª–æ—Ä—É—Å—Å–∫–∏–π —è–∑—ã–∫', '–ì–∞–ø–æ–Ω–µ–Ω–∫–æ –Æ.–í.'),
        ]
    },
    '6–∞': {
        '–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫': [
            (1, '–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞', '–ü—Ä–∏—Ö–∞—á –ï.–í.'),
            (2, '–§–∏–∑–∫—É–ª—å—Ç—É—Ä–∞', '–Ø–≤–æ—à –°.–í.'),
            (3, '–ë–µ–ª–æ—Ä—É—Å—Å–∫–∏–π —è–∑—ã–∫', '–ì–∞–ø–æ–Ω–µ–Ω–∫–æ –Æ.–í.'),
            (4, '–ò—Å—Ç–æ—Ä–∏—è', '–°–∏–≤—ã–π –ê.–í.'),
            (5, '–ê–Ω–≥–ª–∏–π—Å–∫–∏–π —è–∑—ã–∫', '–ü—Ä–∏—Ö–æ–¥—å–∫–æ –ò.–ù./–¢–∏—Ö–æ–Ω–µ–Ω–∫–æ –û.–ê.'),
            (6, '–¢—Ä—É–¥–æ–≤–æ–µ –æ–±—É—á–µ–Ω–∏–µ', '–°—Ç–∏—à–µ–Ω–æ–∫ –ù.–ò./–ú–∏—Ö–∞—Å—ë–≤ –í.–ê.'),
        ],
        '–í—Ç–æ—Ä–Ω–∏–∫': [
            (1, '–ê–Ω–≥–ª–∏–π—Å–∫–∏–π —è–∑—ã–∫', '–ü—Ä–∏—Ö–æ–¥—å–∫–æ –ò.–ù./–¢–∏—Ö–æ–Ω–µ–Ω–∫–æ –û.–ê.'),
            (2, '–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞', '–ü—Ä–∏—Ö–∞—á –ï.–í.'),
            (3, '–ë–µ–ª. –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞', '–ì–∞–ø–æ–Ω–µ–Ω–∫–æ –Æ.–í.'),
            (4, '–†—É—Å—Å–∫–∏–π —è–∑—ã–∫', '–ú–∏—Ö–∞–ª–∫–æ –ï.–ü.'),
            (5, '–ë–µ–ª–æ—Ä—É—Å—Å–∫–∏–π —è–∑—ã–∫', '–ì–∞–ø–æ–Ω–µ–Ω–∫–æ –Æ.–í.'),
            (6, '–†—É—Å. –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞', '–ú–∏—Ö–∞–ª–∫–æ –ï.–ü.'),
        ],
        '–°—Ä–µ–¥–∞': [
            (1, '–§–∏–∑–∫—É–ª—å—Ç—É—Ä–∞', '–Ø–≤–æ—à –°.–í.'),
            (2, '–†—É—Å—Å–∫–∏–π —è–∑—ã–∫', '–ú–∏—Ö–∞–ª–∫–æ –ï.–ü.'),
            (3, '–ì–µ–æ–≥—Ä–∞—Ñ–∏—è', '–Æ–Ω–∞—Ö –¢.–í.'),
            (4, '–ê–Ω–≥–ª–∏–π—Å–∫–∏–π —è–∑—ã–∫', '–ü—Ä–∏—Ö–æ–¥—å–∫–æ –ò.–ù./–¢–∏—Ö–æ–Ω–µ–Ω–∫–æ –û.–ê.'),
            (5, '–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞', '–ü—Ä–∏—Ö–∞—á –ï.–í.'),
            (6, '–†—É—Å—Å–∫–∞—è –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞', '–ú–∏—Ö–∞–ª–∫–æ –ï.–ü.'),
        ],
        '–ß–µ—Ç–≤–µ—Ä–≥': [
            (1, '–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞', '–ü—Ä–∏—Ö–∞—á –ï.–í.'),
            (2, '–ò—Å–∫—É—Å—Å—Ç–≤–æ', '–ú–µ–ª–µ–∂ –ê.–ì.'),
            (3, '–ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–∫–∞', '–ì—É–¥ –Æ.–ü./–ü—Ä–∏—Ö–∞—á –ï.–í.'),
            (4, '–ë–µ–ª. –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞', '–ì–∞–ø–æ–Ω–µ–Ω–∫–æ –Æ.–í.'),
            (5, '–ë–∏–æ–ª–æ–≥–∏—è', '–î–∞–Ω–∏–ª–µ–Ω–∫–æ –ê.–ê.'),
        ],
        '–ü—è—Ç–Ω–∏—Ü–∞': [
            (1, '–†—É—Å—Å–∫–∏–π —è–∑—ã–∫', '–ú–∏—Ö–∞–ª–∫–æ –ï.–ü.'),
            (2, '–ò—Å—Ç–æ—Ä–∏—è', '–°–∏–≤—ã–π –ê.–í.'),
            (3, '–¢—Ä—É–¥–æ–≤–æ–µ –æ–±—É—á–µ–Ω–∏–µ', '–°—Ç–∏—à–µ–Ω–æ–∫ –ù.–ò./–ú–∏—Ö–∞—Å—ë–≤ –í.–ê.'),
            (4, '–§–∏–∑–∫—É–ª—å—Ç—É—Ä–∞', '–Ø–≤–æ—à –°.–í.'),
            (5, '–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞', '–ü—Ä–∏—Ö–∞—á –ï.–í.'),
            (6, '–ë–µ–ª–æ—Ä—É—Å—Å–∫–∏–π —è–∑—ã–∫', '–ì–∞–ø–æ–Ω–µ–Ω–∫–æ –Æ.–í.'),
        ]
    },
    '6–±': {
        '–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫': [
            (1, '–ê–Ω–≥–ª–∏–π—Å–∫–∏–π —è–∑—ã–∫', '–ü—Ä–∏—Ö–æ–¥—å–∫–æ –ò.–ù./–ö–æ–≤–∞–ª—å—á—É–∫ –ö.–†.'),
            (2, '–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞', '–ê–Ω–∏—Å–∫–æ–≤–µ—Ü –ù.–í.'),
            (3, '–¢—Ä—É–¥–æ–≤–æ–µ –æ–±—É—á–µ–Ω–∏–µ', '–°—Ç–∏—à–µ–Ω–æ–∫ –ù.–ò./–ú–∏—Ö–∞—Å—ë–≤ –í.–ê.'),
            (4, '–§–∏–∑–∫—É–ª—å—Ç—É—Ä–∞', '–Ø–≤–æ—à –°.–í.'),
            (5, '–†—É—Å—Å–∫–∏–π —è–∑—ã–∫', '–ú–∏—Ö–∞–ª–∫–æ –ï.–ü.'),
        ],
        '–í—Ç–æ—Ä–Ω–∏–∫': [
            (1, '–†—É—Å. –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞', '–ú–∏—Ö–∞–ª–∫–æ –ï.–ü.'),
            (2, '–ò—Å–∫—É—Å—Å—Ç–≤–æ', '–ú–µ–ª–µ–∂ –ê.–ì.'),
            (3, '–ê–Ω–≥–ª–∏–π—Å–∫–∏–π —è–∑—ã–∫', '–ü—Ä–∏—Ö–æ–¥—å–∫–æ –ò.–ù./–ö–æ–≤–∞–ª—å—á—É–∫ –ö.–†.'),
            (4, '–ë–µ–ª–æ—Ä—É—Å—Å–∫–∏–π —è–∑—ã–∫', '–ê–Ω–∏—Å–µ–Ω–∫–æ –°.–í.'),
            (5, '–ë–µ–ª. –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞', '–ê–Ω–∏—Å–µ–Ω–∫–æ –°.–í.'),
            (6, '–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞', '–ê–Ω–∏—Å–∫–æ–≤–µ—Ü –ù.–í.'),
        ],
        '–°—Ä–µ–¥–∞': [
            (1, '–†—É—Å. –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞', '–ú–∏—Ö–∞–ª–∫–æ –ï.–ü.'),
            (2, '–ë–µ–ª–æ—Ä—É—Å—Å–∫–∏–π —è–∑—ã–∫', '–ê–Ω–∏—Å–µ–Ω–∫–æ –°.–í.'),
            (3, '–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞', '–ê–Ω–∏—Å–∫–æ–≤–µ—Ü –ù.–í.'),
            (4, '–§–∏–∑–∫—É–ª—å—Ç—É—Ä–∞', '–Ø–≤–æ—à –°.–í.'),
            (5, '–†—É—Å—Å–∫–∏–π —è–∑—ã–∫', '–ú–∏—Ö–∞–ª–∫–æ –ï.–ü.'),
            (6, '–ò—Å—Ç–æ—Ä–∏—è', '–ö–æ—Ä–æ–ª—ë–≤–∞ –ñ.–í.'),
        ],
        '–ß–µ—Ç–≤–µ—Ä–≥': [
            (1, '–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞', '–ê–Ω–∏—Å–∫–æ–≤–µ—Ü –ù.–í.'),
            (2, '–ë–µ–ª. –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞', '–ê–Ω–∏—Å–µ–Ω–∫–æ –°.–í.'),
            (3, '–ë–µ–ª–æ—Ä—É—Å—Å–∫–∏–π —è–∑—ã–∫', '–ê–Ω–∏—Å–µ–Ω–∫–æ –°.–í.'),
            (4, '–ë–∏–æ–ª–æ–≥–∏—è', '–î–∞–Ω–∏–ª–µ–Ω–∫–æ –ê.–ê.'),
            (5, '–ò—Å—Ç–æ—Ä–∏—è', '–ö–æ—Ä–æ–ª—ë–≤–∞ –ñ.–í.'),
            (6, '–ì–µ–æ–≥—Ä–∞—Ñ–∏—è', '–Æ–Ω–∞—Ö –¢.–í.'),
        ],
        '–ü—è—Ç–Ω–∏—Ü–∞': [
            (1, '–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞', '–ê–Ω–∏—Å–∫–æ–≤–µ—Ü –ù.–í.'),
            (2, '–ê–Ω–≥–ª–∏–π—Å–∫–∏–π —è–∑—ã–∫', '–ü—Ä–∏—Ö–æ–¥—å–∫–æ –ò.–ù./–ö–æ–≤–∞–ª—å—á—É–∫ –ö.–†.'),
            (3, '–†—É—Å—Å–∫–∏–π —è–∑—ã–∫', '–ú–∏—Ö–∞–ª–∫–æ –ï.–ü.'),
            (4, '–ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–∫–∞', '–ì—É–¥ –Æ.–ü./–ü—Ä–∏—Ö–∞—á –ï.–í.'),
            (5, '–§–∏–∑–∫—É–ª—å—Ç—É—Ä–∞', '–Ø–≤–æ—à –°.–í.'),
            (6, '–¢—Ä—É–¥–æ–≤–æ–µ –æ–±—É—á–µ–Ω–∏–µ', '–°—Ç–∏—à–µ–Ω–æ–∫ –ù.–ò./–ú–∏—Ö–∞—Å—ë–≤ –í.–ê.'),
        ]
    },
    '6–≤': {
        '–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫': [
            (1, '–†—É—Å—Å–∫–∏–π —è–∑—ã–∫', '–®–∞—Ç–∏–ª–æ –ù.–ò.'),
            (2, '–§–∏–∑–∫—É–ª—å—Ç—É—Ä–∞', '–°–º–æ–ª—å—Å–∫–∏–π –°.–ú.'),
            (3, '–ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–∫–∞', '–ì—É–¥ –Æ.–ü./–ü—Ä–∏—Ö–∞—á –ï.–í.'),
            (4, '–†—É—Å. –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞', '–®–∞—Ç–∏–ª–æ –ù.–ò.'),
            (5, '–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞', '–ù–∞–∑–∞—Ä–µ–Ω–∫–æ –¢.–ö.'),
            (6, '–ê–Ω–≥–ª–∏–π—Å–∫–∏–π —è–∑—ã–∫', '–ù–µ—á–∞–µ–≤–∞ –ï.–Ø./–®—Ç—ã—Ö–Ω–æ–≤–∞ –õ.–ì.'),
        ],
        '–í—Ç–æ—Ä–Ω–∏–∫': [
            (1, '–ò—Å—Ç–æ—Ä–∏—è', '–ö–æ—Ä–æ–ª—ë–≤–∞ –ñ.–í.'),
            (2, '–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞', '–ù–∞–∑–∞—Ä–µ–Ω–∫–æ –¢.–ö.'),
            (3, '–†—É—Å—Å–∫–∏–π —è–∑—ã–∫', '–®–∞—Ç–∏–ª–æ –ù.–ò.'),
            (4, '–ë–µ–ª. –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞', '–ì—Ä–∏—Ü–∫–µ–≤–∏—á –õ.–í.'),
            (5, '–ë–µ–ª–æ—Ä—É—Å—Å–∫–∏–π —è–∑—ã–∫', '–ì—Ä–∏—Ü–∫–µ–≤–∏—á –õ.–í.'),
            (6, '–ò—Å–∫—É—Å—Å—Ç–≤–æ', '–ú–µ–ª–µ–∂ –ê.–ì.'),
        ],
        '–°—Ä–µ–¥–∞': [
            (1, '–ê–Ω–≥–ª–∏–π—Å–∫–∏–π —è–∑—ã–∫', '–ù–µ—á–∞–µ–≤–∞ –ï.–Ø./–®—Ç—ã—Ö–Ω–æ–≤–∞ –õ.–ì.'),
            (2, '–ë–µ–ª. –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞', '–ì—Ä–∏—Ü–∫–µ–≤–∏—á –õ.–í.'),
            (3, '–ë–µ–ª–æ—Ä—É—Å—Å–∫–∏–π —è–∑—ã–∫', '–ì—Ä–∏—Ü–∫–µ–≤–∏—á –õ.–í.'),
            (4, '–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞', '–ù–∞–∑–∞—Ä–µ–Ω–∫–æ –¢.–ö.'),
            (5, '–ë–∏–æ–ª–æ–≥–∏—è', '–î–∞–Ω–∏–ª–µ–Ω–∫–æ –ê.–ê.'),
        ],
        '–ß–µ—Ç–≤–µ—Ä–≥': [
            (1, '–†—É—Å. –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞', '–®–∞—Ç–∏–ª–æ –ù.–ò.'),
            (2, '–†—É—Å—Å–∫–∏–π —è–∑—ã–∫', '–®–∞—Ç–∏–ª–æ –ù.–ò.'),
            (3, '–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞', '–ù–∞–∑–∞—Ä–µ–Ω–∫–æ –¢.–ö.'),
            (4, '–ò—Å—Ç–æ—Ä–∏—è', '–ö–æ—Ä–æ–ª—ë–≤–∞ –ñ.–í.'),
            (5, '–§–∏–∑–∫—É–ª—å—Ç—É—Ä–∞', '–°–º–æ–ª—å—Å–∫–∏–π –°.–ú.'),
            (6, '–ë–µ–ª–æ—Ä—É—Å—Å–∫–∏–π —è–∑—ã–∫', '–ì—Ä–∏—Ü–∫–µ–≤–∏—á –õ.–í.'),
        ],
        '–ü—è—Ç–Ω–∏—Ü–∞': [
            (1, '–§–∏–∑–∫—É–ª—å—Ç—É—Ä–∞', '–°–º–æ–ª—å—Å–∫–∏–π –°.–ú.'),
            (2, '–¢—Ä—É–¥–æ–≤–æ–µ –æ–±—É—á–µ–Ω–∏–µ', '–ú–∏—Ö–∞—Å—ë–≤ –í.–ê./–°—Ç–∏—à–µ–Ω–æ–∫ –ù.–ò.'),
            (3, '–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞', '–ù–∞–∑–∞—Ä–µ–Ω–∫–æ –¢.–ö.'),
            (4, '–ê–Ω–≥–ª–∏–π—Å–∫–∏–π —è–∑—ã–∫', '–ù–µ—á–∞–µ–≤–∞ –ï.–Ø./–®—Ç—ã—Ö–Ω–æ–≤–∞ –õ.–ì.'),
            (5, '–¢—Ä—É–¥–æ–≤–æ–µ –æ–±—É—á–µ–Ω–∏–µ', '–ú–∏—Ö–∞—Å—ë–≤ –í.–ê./–°—Ç–∏—à–µ–Ω–æ–∫ –ù.–ò.'),
            (6, '–ì–µ–æ–≥—Ä–∞—Ñ–∏—è', '–Æ–Ω–∞—Ö –¢.–í.'),
        ]
    },
    '7–∞': {
        '–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫': [
            (1, '–¢—Ä—É–¥–æ–≤–æ–µ –æ–±—É—á–µ–Ω–∏–µ', '–ú–µ–ª–µ–∂ –ê.–ì./–ú–∏—Ö–∞—Å—ë–≤ –í.–ê.'),
            (2, '–†—É—Å—Å–∫–∏–π —è–∑—ã–∫', '–õ–µ–æ–Ω–æ–≤–∞ –î.–ê.'),
            (3, '–ë–∏–æ–ª–æ–≥–∏—è', '–î–∞–Ω–∏–ª–µ–Ω–∫–æ –ê.–ê.'),
            (4, '–ì–µ–æ–≥—Ä–∞—Ñ–∏—è', '–Æ–Ω–∞—Ö –¢.–í.'),
            (5, '–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞', '–ê–Ω–∏—Å–∫–æ–≤–µ—Ü –ù.–í.'),
            (6, '–§–∏–∑–∫—É–ª—å—Ç—É—Ä–∞', '–°–º–æ–ª—å—Å–∫–∏–π –°.–ú.'),
            (7, '–ò—Å—Ç–æ—Ä–∏—è', '–ö–æ—Ä–æ–ª—ë–≤–∞ –ñ.–í.'),
        ],
        '–í—Ç–æ—Ä–Ω–∏–∫': [
            (1, '–§–∏–∑–∫—É–ª—å—Ç—É—Ä–∞', '–°–º–æ–ª—å—Å–∫–∏–π –°.–ú.'),
            (2, '–†—É—Å. –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞', '–õ–µ–æ–Ω–æ–≤–∞ –î.–ê.'),
            (3, '–§–∏–∑–∏–∫–∞', '–ó—É–±–æ–∫ –°.–ù.'),
            (4, '–ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–∫–∞', '–ì—É–¥ –Æ.–ü./–ù–∞–∑–∞—Ä–µ–Ω–∫–æ –¢.–ö.'),
            (5, '–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞', '–ê–Ω–∏—Å–∫–æ–≤–µ—Ü –ù.–í.'),
            (6, '–ê–Ω–≥–ª–∏–π—Å–∫–∏–π —è–∑—ã–∫', '–ù–µ—á–∞–µ–≤–∞ –ï.–Ø./–ö–æ–≤–∞–ª—å—á—É–∫ –ö.–†.'),
        ],
        '–°—Ä–µ–¥–∞': [
            (1, '–ë–µ–ª–æ—Ä—É—Å—Å–∫–∏–π —è–∑—ã–∫', '–ê–Ω–∏—Å–µ–Ω–∫–æ –°.–í.'),
            (2, '–§–∏–∑–∏–∫–∞', '–ó—É–±–æ–∫ –°.–ù.'),
            (3, '–§–∏–∑–∫—É–ª—å—Ç—É—Ä–∞', '–°–º–æ–ª—å—Å–∫–∏–π –°.–ú.'),
            (4, '–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞', '–ê–Ω–∏—Å–∫–æ–≤–µ—Ü –ù.–í.'),
            (5, '–¢—Ä—É–¥–æ–≤–æ–µ –æ–±—É—á–µ–Ω–∏–µ', '–ú–µ–ª–µ–∂ –ê.–ì./–ú–∏—Ö–∞—Å—ë–≤ –í.–ê.'),
            (6, '–•–∏–º–∏—è', '–ö–æ—Ä–æ–ª—å—á—É–∫ –û.–ì.'),
            (7, '–ê–Ω–≥–ª–∏–π—Å–∫–∏–π —è–∑—ã–∫', '–ö–æ–≤–∞–ª—å—á—É–∫ –ö.–†.'),
        ],
        '–ß–µ—Ç–≤–µ—Ä–≥': [
            (1, '–ë–µ–ª. –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞', '–ê–Ω–∏—Å–µ–Ω–∫–æ –°.–í.'),
            (2, '–ò—Å—Ç–æ—Ä–∏—è', '–ö–æ—Ä–æ–ª—ë–≤–∞ –ñ.–í.'),
            (3, '–ë–∏–æ–ª–æ–≥–∏—è', '–î–∞–Ω–∏–ª–µ–Ω–∫–æ –ê.–ê.'),
            (4, '–†—É—Å—Å–∫–∏–π —è–∑—ã–∫', '–õ–µ–æ–Ω–æ–≤–∞ –î.–ê.'),
            (5, '–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞', '–ê–Ω–∏—Å–∫–æ–≤–µ—Ü –ù.–í.'),
            (6, '–ê–Ω–≥–ª–∏–π—Å–∫–∏–π —è–∑—ã–∫', '–ù–µ—á–∞–µ–≤–∞ –ï.–Ø./–ö–æ–≤–∞–ª—å—á—É–∫ –ö.–†.'),
        ],
        '–ü—è—Ç–Ω–∏—Ü–∞': [
            (1, '–ë–µ–ª. –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞', '–ê–Ω–∏—Å–µ–Ω–∫–æ –°.–í.'),
            (2, '–ë–µ–ª–æ—Ä—É—Å—Å–∫–∏–π —è–∑—ã–∫', '–ê–Ω–∏—Å–µ–Ω–∫–æ –°.–í.'),
            (3, '–ò—Å–∫—É—Å—Å—Ç–≤–æ', '–ú–µ–ª–µ–∂ –ê.–ì.'),
            (4, '–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞', '–ê–Ω–∏—Å–∫–æ–≤–µ—Ü –ù.–í.'),
            (5, '–ê–Ω–≥–ª–∏–π—Å–∫–∏–π —è–∑—ã–∫', '–ù–µ—á–∞–µ–≤–∞ –ï.–Ø./–ö–æ–≤–∞–ª—å—á—É–∫ –ö.–†.'),
            (6, '–ò—Å—Ç–æ—Ä–∏—è', '–ö–æ—Ä–æ–ª—ë–≤–∞ –ñ.–í.'),
        ]
    },
    '7–±': {
        '–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫': [
            (1, '–ë–µ–ª. –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞', '–ì–∞–ø–æ–Ω–µ–Ω–∫–æ –Æ.–í.'),
            (2, '–¢—Ä—É–¥–æ–≤–æ–µ –æ–±—É—á–µ–Ω–∏–µ', '–ú–µ–ª–µ–∂ –ê.–ì./–ú–∏—Ö–∞—Å—ë–≤ –í.–ê.'),
            (3, '–ì–µ–æ–≥—Ä–∞—Ñ–∏—è', '–Æ–Ω–∞—Ö –¢.–í.'),
            (4, '–ë–µ–ª–æ—Ä—É—Å—Å–∫–∏–π —è–∑—ã–∫', '–ì–∞–ø–æ–Ω–µ–Ω–∫–æ –Æ.–í.'),
            (5, '–ë–∏–æ–ª–æ–≥–∏—è', '–ö–∞–Ω—É–Ω–æ–≤–∞ –í.–ì.'),
            (6, '–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞', '–ü—Ä–∏—Ö–∞—á –ï.–í.'),
        ],
        '–í—Ç–æ—Ä–Ω–∏–∫': [
            (1, '–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞', '–ü—Ä–∏—Ö–∞—á –ï.–í.'),
            (2, '–§–∏–∑–∏–∫–∞', '–ó—É–±–æ–∫ –°.–ù.'),
            (3, '–†—É—Å—Å–∫–∏–π —è–∑—ã–∫', '–ú–∏—Ö–∞–ª–∫–æ –ï.–ü.'),
            (4, '–ò—Å–∫—É—Å—Å—Ç–≤–æ', '–ú–µ–ª–µ–∂ –ê.–ì.'),
            (5, '–ë–∏–æ–ª–æ–≥–∏—è', '–ö–∞–Ω—É–Ω–æ–≤–∞ –í.–ì.'),
            (6, '–ë–µ–ª. –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞', '–ì–∞–ø–æ–Ω–µ–Ω–∫–æ –Æ.–í.'),
        ],
        '–°—Ä–µ–¥–∞': [
            (1, '–ê–Ω–≥–ª–∏–π—Å–∫–∏–π —è–∑—ã–∫', '–ü—Ä–∏—Ö–æ–¥—å–∫–æ –ò.–ù./–ö–æ–≤–∞–ª—å—á—É–∫ –ö.–†.'),
            (2, '–ë–µ–ª–æ—Ä—É—Å—Å–∫–∏–π —è–∑—ã–∫', '–ì–∞–ø–æ–Ω–µ–Ω–∫–æ –Æ.–í.'),
            (3, '–§–∏–∑–∏–∫–∞', '–ó—É–±–æ–∫ –°.–ù.'),
            (4, '–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞', '–ü—Ä–∏—Ö–∞—á –ï.–í.'),
            (5, '–§–∏–∑–∫—É–ª—å—Ç—É—Ä–∞', '–í–µ—Ä–≥–µ–π—á–∏–∫ –í.–õ.'),
            (6, '–¢—Ä—É–¥–æ–≤–æ–µ –æ–±—É—á–µ–Ω–∏–µ', '–ú–µ–ª–µ–∂ –ê.–ì./–ú–∏—Ö–∞—Å—ë–≤ –í.–ê.'),
        ],
        '–ß–µ—Ç–≤–µ—Ä–≥': [
            (1, '–ê–Ω–≥–ª–∏–π—Å–∫–∏–π —è–∑—ã–∫', '–ü—Ä–∏—Ö–æ–¥—å–∫–æ –ò.–ù./–ö–æ–≤–∞–ª—å—á—É–∫ –ö.–†.'),
            (2, '–†—É—Å—Å–∫–∏–π —è–∑—ã–∫', '–ú–∏—Ö–∞–ª–∫–æ –ï.–ü.'),
            (3, '–•–∏–º–∏—è', '–ö–∞–Ω—É–Ω–æ–≤–∞ –í.–ì.'),
            (4, '–ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–∫–∞', '–ì—É–¥ –Æ.–ü./–ù–∞–∑–∞—Ä–µ–Ω–∫–æ –¢.–ö.'),
            (5, '–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞', '–ü—Ä–∏—Ö–∞—á –ï.–í.'),
            (6, '–ò—Å—Ç–æ—Ä–∏—è', '–ö–æ—Ä–æ–ª—ë–≤–∞ –ñ.–í.'),
            (7, '–§–∏–∑–∫—É–ª—å—Ç—É—Ä–∞', '–í–µ—Ä–≥–µ–π—á–∏–∫ –í.–õ.'),
        ],
        '–ü—è—Ç–Ω–∏—Ü–∞': [
            (1, '–ê–Ω–≥–ª–∏–π—Å–∫–∏–π —è–∑—ã–∫', '–ü—Ä–∏—Ö–æ–¥—å–∫–æ –ò.–ù./–ö–æ–≤–∞–ª—å—á—É–∫ –ö.–†.'),
            (2, '–†—É—Å. –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞', '–ú–∏—Ö–∞–ª–∫–æ –ï.–ü.'),
            (3, '–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞', '–ü—Ä–∏—Ö–∞—á –ï.–í.'),
            (4, '–ò—Å—Ç–æ—Ä–∏—è', '–ö–æ—Ä–æ–ª—ë–≤–∞ –ñ.–í.'),
            (5, '–§–∏–∑–∫—É–ª—å—Ç—É—Ä–∞', '–í–µ—Ä–≥–µ–π—á–∏–∫ –í.–õ.'),
        ]
    },
    '7–≤': {
        '–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫': [
            (1, '–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞', '–ì—É–¥ –Æ.–ü.'),
            (2, '–ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–∫–∞', '–ì—É–¥ –Æ.–ü./–ù–∞–∑–∞—Ä–µ–Ω–∫–æ –¢.–ö.'),
            (3, '–§–∏–∑–∫—É–ª—å—Ç—É—Ä–∞', '–°–º–æ–ª—å—Å–∫–∏–π –°.–ú.'),
            (4, '–•–∏–º–∏—è', '–ö–∞–Ω—É–Ω–æ–≤–∞ –í.–ì.'),
            (5, '–ê–Ω–≥–ª–∏–π—Å–∫–∏–π —è–∑—ã–∫', '–ö–æ–≤–∞–ª—å—á—É–∫ –ö.–†./–®—Ç—ã—Ö–Ω–æ–≤–∞ –õ.–ì.'),
            (6, '–ë–∏–æ–ª–æ–≥–∏—è', '–î–∞–Ω–∏–ª–µ–Ω–∫–æ –ê.–ê.'),
        ],
        '–í—Ç–æ—Ä–Ω–∏–∫': [
            (1, '–†—É—Å—Å–∫–∏–π —è–∑—ã–∫', '–õ–µ–æ–Ω–æ–≤–∞ –î.–ê.'),
            (2, '–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞', '–ì—É–¥ –Æ.–ü.'),
            (3, '–¢—Ä—É–¥–æ–≤–æ–µ –æ–±—É—á–µ–Ω–∏–µ', '–ú–µ–ª–µ–∂ –ê.–ì./–ú–∏—Ö–∞—Å—ë–≤ –í.–ê.'),
            (4, '–§–∏–∑–∏–∫–∞', '–ó—É–±–æ–∫ –°.–ù.'),
            (5, '–ò—Å–∫—É—Å—Å—Ç–≤–æ', '–ú–µ–ª–µ–∂ –ê.–ì.'),
            (6, '–§–∏–∑–∫—É–ª—å—Ç—É—Ä–∞', '–°–º–æ–ª—å—Å–∫–∏–π –°.–ú.'),
        ],
        '–°—Ä–µ–¥–∞': [
            (1, '–§–∏–∑–∏–∫–∞', '–ó—É–±–æ–∫ –°.–ù.'),
            (2, '–ë–µ–ª. –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞', '–õ–µ–±–µ–¥–µ–≤—Å–∫–∞—è –ú.–ü.'),
            (3, '–ë–∏–æ–ª–æ–≥–∏—è', '–î–∞–Ω–∏–ª–µ–Ω–∫–æ –ê.–ê.'),
            (4, '–ê–Ω–≥–ª–∏–π—Å–∫–∏–π —è–∑—ã–∫', '–ö–æ–≤–∞–ª—å—á—É–∫ –ö.–†./–®—Ç—ã—Ö–Ω–æ–≤–∞ –õ.–ì.'),
            (5, '–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞', '–ì—É–¥ –Æ.–ü.'),
            (6, '–ò—Å—Ç–æ—Ä–∏—è', '–°–∏–≤—ã–π –ê.–í.'),
        ],
        '–ß–µ—Ç–≤–µ—Ä–≥': [
            (1, '–ò—Å—Ç–æ—Ä–∏—è', '–°–∏–≤—ã–π –ê.–í.'),
            (2, '–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞', '–ì—É–¥ –Æ.–ü.'),
            (3, '–ì–µ–æ–≥—Ä–∞—Ñ–∏—è', '–Æ–Ω–∞—Ö –¢.–í.'),
            (4, '–¢—Ä—É–¥–æ–≤–æ–µ –æ–±—É—á–µ–Ω–∏–µ', '–ú–µ–ª–µ–∂ –ê.–ì./–ú–∏—Ö–∞—Å—ë–≤ –í.–ê.'),
            (5, '–ë–µ–ª–æ—Ä—É—Å—Å–∫–∏–π —è–∑—ã–∫', '–õ–µ–±–µ–¥–µ–≤—Å–∫–∞—è –ú.–ü.'),
            (6, '–ë–µ–ª. –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞', '–õ–µ–±–µ–¥–µ–≤—Å–∫–∞—è –ú.–ü.'),
        ],
        '–ü—è—Ç–Ω–∏—Ü–∞': [
            (1, '–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞', '–ì—É–¥ –Æ.–ü.'),
            (2, '–§–∏–∑–∫—É–ª—å—Ç—É—Ä–∞', '–°–º–æ–ª—å—Å–∫–∏–π –°.–ú.'),
            (3, '–ê–Ω–≥–ª–∏–π—Å–∫–∏–π —è–∑—ã–∫', '–ö–æ–≤–∞–ª—å—á—É–∫ –ö.–†./–®—Ç—ã—Ö–Ω–æ–≤–∞ –õ.–ì.'),
            (4, '–†—É—Å—Å–∫–∏–π —è–∑—ã–∫', '–õ–µ–æ–Ω–æ–≤–∞ –î.–ê.'),
            (5, '–ë–µ–ª–æ—Ä—É—Å—Å–∫–∏–π —è–∑—ã–∫', '–õ–µ–±–µ–¥–µ–≤—Å–∫–∞—è –ú.–ü.'),
            (6, '–†—É—Å. –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞', '–õ–µ–æ–Ω–æ–≤–∞ –î.–ê.'),
        ]
    },
    '8–∞': {
        '–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫': [
            (1, '–§–∏–∑–∫—É–ª—å—Ç—É—Ä–∞', '–Ø–≤–æ—à –°.–í.'),
            (2, '–ì–µ–æ–≥—Ä–∞—Ñ–∏—è', '–Æ–Ω–∞—Ö –¢.–í.'),
            (3, '–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞', '–ö–æ—Ä–æ—Ç—á–∏–∫–æ–≤–∞ –õ.–í.'),
            (4, '–ê–Ω–≥–ª–∏–π—Å–∫–∏–π —è–∑—ã–∫', '–ù–µ—á–∞–µ–≤–∞ –ï.–Ø./–®—Ç—ã—Ö–Ω–æ–≤–∞ –õ.–ì.'),
            (5, '–†—É—Å—Å–∫–∏–π —è–∑—ã–∫', '–®–∞—Ç–∏–ª–æ –ù.–ò.'),
            (6, '–†—É—Å. –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞', '–®–∞—Ç–∏–ª–æ –ù.–ò.'),
        ],
        '–í—Ç–æ—Ä–Ω–∏–∫': [
            (1, '–ë–µ–ª. –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞', '–ì—Ä–∏—Ü–∫–µ–≤–∏—á –õ.–í.'),
            (2, '–§–∏–∑–∫—É–ª—å—Ç—É—Ä–∞', '–Ø–≤–æ—à –°.–í.'),
            (3, '–ë–∏–æ–ª–æ–≥–∏—è', '–ö–∞–Ω—É–Ω–æ–≤–∞ –í.–ì.'),
            (4, '–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞', '–ö–æ—Ä–æ—Ç—á–∏–∫–æ–≤–∞ –õ.–í.'),
            (5, '–•–∏–º–∏—è', '–ö–æ—Ä–æ–ª—å—á—É–∫ –û.–ì.'),
            (6, '–ë–µ–ª–æ—Ä—É—Å—Å–∫–∏–π —è–∑—ã–∫', '–ì—Ä–∏—Ü–∫–µ–≤–∏—á –õ.–í.'),
            (7, '–ê–Ω–≥–ª–∏–π—Å–∫–∏–π —è–∑—ã–∫', '–ù–µ—á–∞–µ–≤–∞ –ï.–Ø.'),
        ],
        '–°—Ä–µ–¥–∞': [
            (1, '–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞', '–ö–æ—Ä–æ—Ç—á–∏–∫–æ–≤–∞ –õ.–í.'),
            (2, '–¢—Ä—É–¥–æ–≤–æ–µ –æ–±—É—á–µ–Ω–∏–µ', '–ú–µ–ª–µ–∂ –ê.–ì./–ú–∏—Ö–∞—Å—ë–≤ –í.–ê.'),
            (3, '–ê–Ω–≥–ª–∏–π—Å–∫–∏–π —è–∑—ã–∫', '–ù–µ—á–∞–µ–≤–∞ –ï.–Ø./–®—Ç—ã—Ö–Ω–æ–≤–∞ –õ.–ì.'),
            (4, '–†—É—Å—Å–∫–∏–π —è–∑—ã–∫', '–®–∞—Ç–∏–ª–æ –ù.–ò.'),
            (5, '–§–∏–∑–∏–∫–∞', '–°—Ç–∏—à–µ–Ω–æ–∫ –ù.–ò.'),
            (6, '–ò—Å–∫—É—Å—Å—Ç–≤–æ', '–ë–µ–ª—å—Å–∫–∏–π –°.–í.'),
            (7, '–ò—Å—Ç–æ—Ä–∏—è', '–°–∏–≤—ã–π –ê.–í.'),
        ],
        '–ß–µ—Ç–≤–µ—Ä–≥': [
            (1, '–ë–∏–æ–ª–æ–≥–∏—è', '–ö–∞–Ω—É–Ω–æ–≤–∞ –í.–ì.'),
            (2, '–ò—Å—Ç–æ—Ä–∏—è', '–°–∏–≤—ã–π –ê.–í.'),
            (3, '–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞', '–ö–æ—Ä–æ—Ç—á–∏–∫–æ–≤–∞ –õ.–í.'),
            (4, '–•–∏–º–∏—è', '–ö–æ—Ä–æ–ª—å—á—É–∫ –û.–ì.'),
            (5, '–ë–µ–ª–æ—Ä—É—Å—Å–∫–∏–π —è–∑—ã–∫', '–ì—Ä–∏—Ü–∫–µ–≤–∏—á –õ.–í.'),
            (6, '–†—É—Å. –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞', '–®–∞—Ç–∏–ª–æ –ù.–ò.'),
        ],
        '–ü—è—Ç–Ω–∏—Ü–∞': [
            (1, '–ê–Ω–≥–ª–∏–π—Å–∫–∏–π —è–∑—ã–∫', '–ù–µ—á–∞–µ–≤–∞ –ï.–Ø./–®—Ç—ã—Ö–Ω–æ–≤–∞ –õ.–ì.'),
            (2, '–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞', '–ö–æ—Ä–æ—Ç—á–∏–∫–æ–≤–∞ –õ.–í.'),
            (3, '–ì–µ–æ–≥—Ä–∞—Ñ–∏—è', '–Æ–Ω–∞—Ö –¢.–í.'),
            (4, '–§–∏–∑–∏–∫–∞', '–°—Ç–∏—à–µ–Ω–æ–∫ –ù.–ò.'),
            (5, '–ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–∫–∞', '–ù–∞–∑–∞—Ä–µ–Ω–∫–æ –¢.–ö./–ì—É–¥ –Æ.–ü.'),
            (6, '–§–∏–∑–∫—É–ª—å—Ç—É—Ä–∞', '–Ø–≤–æ—à –°.–í.'),
        ]
    },
    '8–±': {
        '–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫': [
            (1, '–ì–µ–æ–≥—Ä–∞—Ñ–∏—è', '–Æ–Ω–∞—Ö –¢.–í.'),
            (2, '–†—É—Å—Å–∫–∏–π —è–∑—ã–∫', '–ú–∏—Ö–∞–ª–∫–æ –ï.–ü.'),
            (3, '–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞', '–ê–Ω–∏—Å–∫–æ–≤–µ—Ü –ù.–í.'),
            (4, '–ò—Å—Ç–æ—Ä–∏—è', '–ë–µ–ª—å—Å–∫–∏–π –°.–í.'),
            (5, '–ë–µ–ª. –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞', '–ë—Ä–µ–ª—å –Æ.–í.'),
            (6, '–ê–Ω–≥–ª–∏–π—Å–∫–∏–π —è–∑—ã–∫', '–ü—Ä–∏—Ö–æ–¥—å–∫–æ –ò.–ù./–¢–∏—Ö–æ–Ω–µ–Ω–∫–æ –û.–ê.'),
        ],
        '–í—Ç–æ—Ä–Ω–∏–∫': [
            (1, '–¢—Ä—É–¥–æ–≤–æ–µ –æ–±—É—á–µ–Ω–∏–µ', '–ú–µ–ª–µ–∂ –ê.–ì./–ú–∏—Ö–∞—Å—ë–≤ –í.–ê.'),
            (2, '–§–∏–∑–∫—É–ª—å—Ç—É—Ä–∞', '–í–µ—Ä–≥–µ–π—á–∏–∫ –í.–õ.'),
            (3, '–ë–µ–ª–æ—Ä—É—Å—Å–∫–∏–π —è–∑—ã–∫', '–ë—Ä–µ–ª—å –Æ.–í.'),
            (4, '–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞', '–ê–Ω–∏—Å–∫–æ–≤–µ—Ü –ù.–í.'),
            (5, '–ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–∫–∞', '–ì—É–¥ –Æ.–ü./–ù–∞–∑–∞—Ä–µ–Ω–∫–æ –¢.–ö.'),
            (6, '–ê–Ω–≥–ª–∏–π—Å–∫–∏–π —è–∑—ã–∫', '–ü—Ä–∏—Ö–æ–¥—å–∫–æ –ò.–ù./–¢–∏—Ö–æ–Ω–µ–Ω–∫–æ –û.–ê.'),
        ],
        '–°—Ä–µ–¥–∞': [
            (1, '–§–∏–∑–∫—É–ª—å—Ç—É—Ä–∞', '–í–µ—Ä–≥–µ–π—á–∏–∫ –í.–õ.'),
            (2, '–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞', '–ê–Ω–∏—Å–∫–æ–≤–µ—Ü –ù.–í.'),
            (3, '–ò—Å—Ç–æ—Ä–∏—è', '–ë–µ–ª—å—Å–∫–∏–π –°.–í.'),
            (4, '–§–∏–∑–∏–∫–∞', '–°—Ç–∏—à–µ–Ω–æ–∫ –ù.–ò.'),
            (5, '–•–∏–º–∏—è', '–ö–æ—Ä–æ–ª—å—á—É–∫ –û.–ì.'),
            (6, '–ë–∏–æ–ª–æ–≥–∏—è', '–ö–∞–Ω—É–Ω–æ–≤–∞ –í.–ì.'),
            (7, '–ò—Å–∫—É—Å—Å—Ç–≤–æ', '–ë–µ–ª—å—Å–∫–∏–π –°.–í.'),
        ],
        '–ß–µ—Ç–≤–µ—Ä–≥': [
            (1, '–†—É—Å—Å–∫–∏–π —è–∑—ã–∫', '–ú–∏—Ö–∞–ª–∫–æ –ï.–ü.'),
            (2, '–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞', '–ê–Ω–∏—Å–∫–æ–≤–µ—Ü –ù.–í.'),
            (3, '–§–∏–∑–∏–∫–∞', '–°—Ç–∏—à–µ–Ω–æ–∫ –ù.–ò.'),
            (4, '–†—É—Å. –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞', '–ú–∏—Ö–∞–ª–∫–æ –ï.–ü.'),
            (5, '–ê–Ω–≥–ª–∏–π—Å–∫–∏–π —è–∑—ã–∫', '–ü—Ä–∏—Ö–æ–¥—å–∫–æ –ò.–ù./–¢–∏—Ö–æ–Ω–µ–Ω–∫–æ –û.–ê.'),
            (6, '–ë–µ–ª–æ—Ä—É—Å—Å–∫–∏–π —è–∑—ã–∫', '–ë—Ä–µ–ª—å –Æ.–í.'),
        ],
        '–ü—è—Ç–Ω–∏—Ü–∞': [
            (1, '–ë–∏–æ–ª–æ–≥–∏—è', '–ö–∞–Ω—É–Ω–æ–≤–∞ –í.–ì.'),
            (2, '–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞', '–ê–Ω–∏—Å–∫–æ–≤–µ—Ü –ù.–í.'),
            (3, '–§–∏–∑–∫—É–ª—å—Ç—É—Ä–∞', '–í–µ—Ä–≥–µ–π—á–∏–∫ –í.–õ.'),
            (4, '–†—É—Å. –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞', '–ú–∏—Ö–∞–ª–∫–æ –ï.–ü.'),
            (5, '–ì–µ–æ–≥—Ä–∞—Ñ–∏—è', '–Æ–Ω–∞—Ö –¢.–í.'),
            (6, '–•–∏–º–∏—è', '–ö–æ—Ä–æ–ª—å—á—É–∫ –û.–ì.'),
        ]
    },
    '9–∞': {
        '–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫': [
            (1, '–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞', '–ê–Ω–∏—Å–∫–æ–≤–µ—Ü –ù.–í.'),
            (2, '–ê–Ω–≥–ª–∏–π—Å–∫–∏–π —è–∑—ã–∫', '–ù–µ—á–∞–µ–≤–∞ –ï.–Ø./–ü—Ä–∏—Ö–æ–¥—å–∫–æ –ò.–ù.'),
            (3, '–•–∏–º–∏—è', '–ö–∞–Ω—É–Ω–æ–≤–∞ –í.–ì.'),
            (4, '–†—É—Å—Å–∫–∏–π —è–∑—ã–∫', '–ü–∏–Ω—á—É–∫ –ê.–í.'),
            (5, '–ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–∫–∞', '–ì—É–¥ –Æ.–ü./–ü—Ä–∏—Ö–∞—á –ï.–í.'),
            (6, '–†—É—Å. –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞', '–ü–∏–Ω—á—É–∫ –ê.–í.'),
            (7, '–§–∏–∑–∫—É–ª—å—Ç—É—Ä–∞', '–í–µ—Ä–≥–µ–π—á–∏–∫ –í.–õ.'),
        ],
        '–í—Ç–æ—Ä–Ω–∏–∫': [
            (1, '–§–∏–∑–∏–∫–∞', '–ó—É–±–æ–∫ –°.–ù.'),
            (2, '–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞', '–ê–Ω–∏—Å–∫–æ–≤–µ—Ü –ù.–í.'),
            (3, '–ò—Å—Ç–æ—Ä–∏—è', '–ö–æ—Ä–æ–ª—ë–≤–∞ –ñ.–í.'),
            (4, '–ë–µ–ª. –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞', '–õ—É–∫—å—è–Ω–µ–Ω–∫–æ –õ.–ò.'),
            (5, '–ë–µ–ª–æ—Ä—É—Å—Å–∫–∏–π —è–∑—ã–∫', '–õ—É–∫—å—è–Ω–µ–Ω–∫–æ –õ.–ò.'),
            (6, '–û–±—â–µ—Å—Ç–≤–æ–≤–µ–¥–µ–Ω–∏–µ', '–°–∏–≤—ã–π –ê.–í.'),
        ],
        '–°—Ä–µ–¥–∞': [
            (1, '–ë–∏–æ–ª–æ–≥–∏—è', '–î–∞–Ω–∏–ª–µ–Ω–∫–æ –ê.–ê.'),
            (2, '–ê–Ω–≥–ª–∏–π—Å–∫–∏–π —è–∑—ã–∫', '–ù–µ—á–∞–µ–≤–∞ –ï.–Ø./–ü—Ä–∏—Ö–æ–¥—å–∫–æ –ò.–ù.'),
            (3, '–•–∏–º–∏—è', '–ö–∞–Ω—É–Ω–æ–≤–∞ –í.–ì.'),
            (4, '–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞', '–ê–Ω–∏—Å–∫–æ–≤–µ—Ü –ù.–í.'),
            (5, '–ë–µ–ª. –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞', '–õ—É–∫—å—è–Ω–µ–Ω–∫–æ –õ.–ò.'),
            (6, '–ì–µ–æ–≥—Ä–∞—Ñ–∏—è', '–Æ–Ω–∞—Ö –¢.–í.'),
            (7, '–ê–Ω–≥–ª–∏–π—Å–∫–∏–π —è–∑—ã–∫', '–ù–µ—á–∞–µ–≤–∞ –ï.–Ø.'),
        ],
        '–ß–µ—Ç–≤–µ—Ä–≥': [
            (1, '–ë–µ–ª–æ—Ä—É—Å—Å–∫–∏–π —è–∑—ã–∫', '–õ—É–∫—å—è–Ω–µ–Ω–∫–æ –õ.–ò.'),
            (2, '–ì–µ–æ–≥—Ä–∞—Ñ–∏—è', '–Æ–Ω–∞—Ö –¢.–í.'),
            (3, '–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞', '–ê–Ω–∏—Å–∫–æ–≤–µ—Ü –ù.–í.'),
            (4, '–ê–Ω–≥–ª–∏–π—Å–∫–∏–π —è–∑—ã–∫', '–ù–µ—á–∞–µ–≤–∞ –ï.–Ø./–ü—Ä–∏—Ö–æ–¥—å–∫–æ –ò.–ù.'),
            (5, '–¢—Ä—É–¥–æ–≤–æ–µ –æ–±—É—á–µ–Ω–∏–µ', '–ú–µ–ª–µ–∂ –ê.–ì./–ú–∏—Ö–∞—Å—ë–≤ –í.–ê.'),
            (6, '–§–∏–∑–∫—É–ª—å—Ç—É—Ä–∞', '–í–µ—Ä–≥–µ–π—á–∏–∫ –í.–õ.'),
            (7, '–ë–∏–æ–ª–æ–≥–∏—è', '–î–∞–Ω–∏–ª–µ–Ω–∫–æ –ê.–ê.'),
        ],
        '–ü—è—Ç–Ω–∏—Ü–∞': [
            (1, '–§–∏–∑–∏–∫–∞', '–ó—É–±–æ–∫ –°.–ù.'),
            (2, '–§–∏–∑–∫—É–ª—å—Ç—É—Ä–∞', '–í–µ—Ä–≥–µ–π—á–∏–∫ –í.–õ.'),
            (3, '–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞', '–ê–Ω–∏—Å–∫–æ–≤–µ—Ü –ù.–í.'),
            (4, '–†—É—Å—Å–∫–∏–π —è–∑—ã–∫', '–ü–∏–Ω—á—É–∫ –ê.–í.'),
            (5, '–ò—Å—Ç–æ—Ä–∏—è', '–ö–æ—Ä–æ–ª—ë–≤–∞ –ñ.–í.'),
            (6, '–ê–Ω–≥–ª–∏–π—Å–∫–∏–π —è–∑—ã–∫', '–ù–µ—á–∞–µ–≤–∞ –ï.–Ø.'),
        ]
    },
    '9–±': {
        '–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫': [
            (1, '–•–∏–º–∏—è', '–ö–∞–Ω—É–Ω–æ–≤–∞ –í.–ì.'),
            (2, '–ë–µ–ª. –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞', '–ë—Ä–µ–ª—å –Æ.–í.'),
            (3, '–ë–µ–ª–æ—Ä—É—Å—Å–∫–∏–π —è–∑—ã–∫', '–ë—Ä–µ–ª—å –Æ.–í.'),
            (4, '–§–∏–∑–∫—É–ª—å—Ç—É—Ä–∞', '–°–º–æ–ª—å—Å–∫–∏–π –°.–ú.'),
            (5, '–ë–∏–æ–ª–æ–≥–∏—è', '–î–∞–Ω–∏–ª–µ–Ω–∫–æ –ê.–ê.'),
            (6, '–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞', '–ì—É–¥ –Æ.–ü.'),
        ],
        '–í—Ç–æ—Ä–Ω–∏–∫': [
            (1, '–•–∏–º–∏—è', '–ö–∞–Ω—É–Ω–æ–≤–∞ –í.–ì.'),
            (2, '–ê–Ω–≥–ª–∏–π—Å–∫–∏–π —è–∑—ã–∫', '–ö–æ–≤–∞–ª—å—á—É–∫ –ö.–†./–¢–∏—Ö–æ–Ω–µ–Ω–∫–æ –û.–ê.'),
            (3, '–†—É—Å—Å–∫–∏–π —è–∑—ã–∫', '–õ–µ–æ–Ω–æ–≤–∞ –î.–ê.'),
            (4, '–ë–µ–ª. –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞', '–ë—Ä–µ–ª—å –Æ.–í.'),
            (5, '–ò—Å—Ç–æ—Ä–∏—è', '–ë–µ–ª—å—Å–∫–∏–π –°.–í.'),
            (6, '–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞', '–ì—É–¥ –Æ.–ü.'),
            (7, '–û–±—â–µ—Å—Ç–≤–æ–≤–µ–¥–µ–Ω–∏–µ', '–°–∏–≤—ã–π –ê.–í.'),
        ],
        '–°—Ä–µ–¥–∞': [
            (1, '–ë–µ–ª–æ—Ä—É—Å—Å–∫–∏–π —è–∑—ã–∫', '–ë—Ä–µ–ª—å –Æ.–í.'),
            (2, '–ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–∫–∞', '–ì—É–¥ –Æ.–ü./–ü—Ä–∏—Ö–∞—á –ï.–í.'),
            (3, '–§–∏–∑–∏–∫–∞', '–°—Ç–∏—à–µ–Ω–æ–∫ –ù.–ò.'),
            (4, '–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞', '–ì—É–¥ –Æ.–ü.'),
            (5, '–§–∏–∑–∫—É–ª—å—Ç—É—Ä–∞', '–°–º–æ–ª—å—Å–∫–∏–π –°.–ú.'),
            (6, '–ê–Ω–≥–ª–∏–π—Å–∫–∏–π —è–∑—ã–∫', '–ö–æ–≤–∞–ª—å—á—É–∫ –ö.–†./–¢–∏—Ö–æ–Ω–µ–Ω–∫–æ –û.–ê.'),
        ],
        '–ß–µ—Ç–≤–µ—Ä–≥': [
            (1, '–§–∏–∑–∫—É–ª—å—Ç—É—Ä–∞', '–°–º–æ–ª—å—Å–∫–∏–π –°.–ú.'),
            (2, '–ë–∏–æ–ª–æ–≥–∏—è', '–î–∞–Ω–∏–ª–µ–Ω–∫–æ –ê.–ê.'),
            (3, '–¢—Ä—É–¥–æ–≤–æ–µ –æ–±—É—á–µ–Ω–∏–µ', '–ú–µ–ª–µ–∂ –ê.–ì./–ú–∏—Ö–∞—Å—ë–≤ –í.–ê.'),
            (4, '–ì–µ–æ–≥—Ä–∞—Ñ–∏—è', '–Æ–Ω–∞—Ö –¢.–í.'),
            (5, '–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞', '–ì—É–¥ –Æ.–ü.'),
            (6, '–ò—Å—Ç–æ—Ä–∏—è', '–ë–µ–ª—å—Å–∫–∏–π –°.–í.'),
        ],
        '–ü—è—Ç–Ω–∏—Ü–∞': [
            (1, '–§–∏–∑–∏–∫–∞', '–°—Ç–∏—à–µ–Ω–æ–∫ –ù.–ò.'),
            (2, '–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞', '–ì—É–¥ –Æ.–ü.'),
            (3, '–†—É—Å. –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞', '–õ–µ–æ–Ω–æ–≤–∞ –î.–ê.'),
            (4, '–ê–Ω–≥–ª–∏–π—Å–∫–∏–π —è–∑—ã–∫', '–ö–æ–≤–∞–ª—å—á—É–∫ –ö.–†./–¢–∏—Ö–æ–Ω–µ–Ω–∫–æ –û.–ê.'),
            (5, '–†—É—Å—Å–∫–∏–π —è–∑—ã–∫', '–õ–µ–æ–Ω–æ–≤–∞ –î.–ê.'),
            (6, '–ò—Å—Ç–æ—Ä–∏—è', '–ë–µ–ª—å—Å–∫–∏–π –°.–í.'),
        ]
    },
    '10–∞': {
        '–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫': [
            (1, '–§–∏–∑–∫—É–ª—å—Ç—É—Ä–∞', '–í–µ—Ä–≥–µ–π—á–∏–∫ –í.–õ./–°–º–æ–ª—å—Å–∫–∏–π –°.–ú.'),
            (2, '–ê–Ω–≥–ª–∏–π—Å–∫–∏–π —è–∑—ã–∫', '–ê—Ä—Ç—é—Ö –ú.–ü./–¢–∏—Ö–æ–Ω–µ–Ω–∫–æ –û.–ê.'),
            (3, '–•–∏–º–∏—è', '–ö–æ—Ä–æ–ª—å—á—É–∫ –û.–ì.'),
            (4, '–ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–∫–∞', '–ì—É–¥ –Æ.–ü./–ù–∞–∑–∞—Ä–µ–Ω–∫–æ –¢.–ö.'),
            (5, '–§–∏–∑–∏–∫–∞', '–°—Ç–∏—à–µ–Ω–æ–∫ –ù.–ò.'),
            (6, '–ë–µ–ª. —è–∑—ã–∫', '–ë—Ä–µ–ª—å –Æ.–í./–ê–Ω–∏—Å–µ–Ω–∫–æ –°.–í.'),
        ],
        '–í—Ç–æ—Ä–Ω–∏–∫': [
            (1, '–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞', '–ö–æ—Ä–æ—Ç—á–∏–∫–æ–≤–∞ –õ.–í./–ù–∞–∑–∞—Ä–µ–Ω–∫–æ –¢.–ö.'),
            (2, '–§–∏–∑–∫—É–ª—å—Ç—É—Ä–∞', '–°–º–æ–ª—å—Å–∫–∏–π –°.–ú.'),
            (3, '–•–∏–º–∏—è', '–ö–æ—Ä–æ–ª—å—á—É–∫ –û.–ì.'),
            (4, '–ë–∏–æ–ª–æ–≥–∏—è', '–ö–∞–Ω—É–Ω–æ–≤–∞ –í.–ì.'),
            (5, '–ò—Å—Ç–æ—Ä–∏—è', '–°–∏–≤—ã–π –ê.–í.'),
            (6, '–ë–µ–ª. —è–∑—ã–∫(–ø—Ä–æ—Ñ)', '–ê–Ω–∏—Å–µ–Ω–∫–æ –°.–í.'),
        ],
        '–°—Ä–µ–¥–∞': [
            (1, '–†—É—Å—Å–∫–∏–π —è–∑—ã–∫', '–ü–∏–Ω—á—É–∫ –ê.–í.'),
            (2, '–î–ü/–ú–ü', '–î–∞–Ω–∏–ª–µ–Ω–∫–æ –ê.–ê./–°–º–æ–ª—å—Å–∫–∏–π –°.–ú.'),
            (3, '–ë–µ–ª. –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞', '–ê–Ω–∏—Å–µ–Ω–∫–æ –°.–í.'),
            (4, '–§–∏–∑–∫—É–ª—å—Ç—É—Ä–∞', '–í–µ—Ä–≥–µ–π—á–∏–∫ –í.–õ./–°–º–æ–ª—å—Å–∫–∏–π –°.–ú.'),
            (5, '–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞', '–ö–æ—Ä–æ—Ç—á–∏–∫–æ–≤–∞ –õ.–í./–ù–∞–∑–∞—Ä–µ–Ω–∫–æ –¢.–ö.'),
            (6, '–§–∏–∑–∏–∫–∞', '–°—Ç–∏—à–µ–Ω–æ–∫ –ù.–ò.'),
            (7, '–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞(–ø—Ä–æ—Ñ)', '–ö–æ—Ä–æ—Ç—á–∏–∫–æ–≤–∞ –õ.–í.'),
        ],
        '–ß–µ—Ç–≤–µ—Ä–≥': [
            (1, '–†—É—Å. –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞', '–ü–∏–Ω—á—É–∫ –ê.–í.'),
            (2, '–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞', '–ö–æ—Ä–æ—Ç—á–∏–∫–æ–≤–∞ –õ.–í./–ù–∞–∑–∞—Ä–µ–Ω–∫–æ –¢.–ö.'),
            (3, '–†—É—Å—Å–∫–∏–π —è–∑—ã–∫', '–ü–∏–Ω—á—É–∫ –ê.–í.'),
            (4, '–ò—Å—Ç–æ—Ä–∏—è', '–°–∏–≤—ã–π –ê.–í.'),
            (5, '–ì–µ–æ–≥—Ä–∞—Ñ–∏—è', '–Æ–Ω–∞—Ö –¢.–í.'),
            (6, '–û–±—â–µ—Å—Ç–≤–æ–≤–µ–¥–µ–Ω–∏–µ', '–°–∏–≤—ã–π –ê.–í.'),
        ],
        '–ü—è—Ç–Ω–∏—Ü–∞': [
            (1, '–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞', '–ö–æ—Ä–æ—Ç—á–∏–∫–æ–≤–∞ –õ.–í./–ù–∞–∑–∞—Ä–µ–Ω–∫–æ –¢.–ö.'),
            (2, '–ë–∏–æ–ª–æ–≥–∏—è', '–ö–∞–Ω—É–Ω–æ–≤–∞ –í.–ì.'),
            (3, '–ë–µ–ª. —è–∑—ã–∫/–ú–∞—Ç–µ–º(–ø—Ä–æ—Ñ)', '–ë—Ä–µ–ª—å –Æ.–í./–ö–æ—Ä–æ—Ç—á–∏–∫–æ–≤–∞ –õ.–í.'),
            (4, '–ß–µ—Ä—á–µ–Ω–∏–µ', '–ú–∏—Ö–∞—Å—ë–≤ –í.–ê.'),
            (5, '–ê–Ω–≥–ª–∏–π—Å–∫–∏–π —è–∑—ã–∫', '–ê—Ä—Ç—é—Ö –ú.–ü./–¢–∏—Ö–æ–Ω–µ–Ω–∫–æ –û.–ê.'),
            (6, '–ë–µ–ª. —è–∑—ã–∫(–ø—Ä–æ—Ñ)', '–ê–Ω–∏—Å–µ–Ω–∫–æ –°.–í.'),
        ]
    },
    '10–±': {
        '–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫': [
            (1, '–†—É—Å. –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞', '–õ–µ–æ–Ω–æ–≤–∞ –î.–ê.'),
            (2, '–ë–∏–æ–ª–æ–≥–∏—è/–•–∏–º–∏—è', '–î–∞–Ω–∏–ª–µ–Ω–∫–æ –ê.–ê./–ö–æ—Ä–æ–ª—å—á—É–∫ –û.–ì.'),
            (3, '–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞', '–ù–∞–∑–∞—Ä–µ–Ω–∫–æ –¢.–ö.'),
            (4, '–ê–Ω–≥–ª. —è–∑—ã–∫/–•–∏–º–∏—è', '–ü—Ä–∏—Ö–æ–¥—å–∫–æ –ò.–ù./–ö–æ—Ä–æ–ª—å—á—É–∫ –û.–ì.'),
            (5, '–§–∏–∑–∫—É–ª—å—Ç—É—Ä–∞', '–°–º–æ–ª—å—Å–∫–∏–π –°.–ú./–í–µ—Ä–≥–µ–π—á–∏–∫ –í.–õ.'),
            (6, '–ò—Å—Ç–æ—Ä–∏—è', '–ö–æ—Ä–æ–ª—ë–≤–∞ –ñ.–í./–°–∏–≤—ã–π –ê.–í.'),
            (7, '–±–∏–æ–ª–æ–≥–∏—è/–∞–Ω–≥–ª–∏–π—Å–∫–∏–π —è–∑—ã–∫', '–î–∞–Ω–∏–ª–µ–Ω–∫–æ –ê.–ê./–ü—Ä–∏—Ö–æ–¥—å–∫–æ –ò.–ù.'),
        ],
        '–í—Ç–æ—Ä–Ω–∏–∫': [
            (1, '–ë–µ–ª. –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞', '–õ–µ–±–µ–¥–µ–≤—Å–∫–∞—è –ú.–ü.'),
            (2, '–ë–∏–æ–ª–æ–≥–∏—è/–•–∏–º–∏—è', '–ö–∞–Ω—É–Ω–æ–≤–∞ –í.–ì./–ö–æ—Ä–æ–ª—å—á—É–∫ –û.–ì.'),
            (3, '–§–∏–∑–∏–∫–∞', '–ö–æ—Ä–æ—Ç—á–∏–∫–æ–≤–∞ –õ.–í.'),
            (4, '–ê–Ω–≥–ª–∏–π—Å–∫–∏–π —è–∑—ã–∫/–•–∏–º–∏—è', '–ü—Ä–∏—Ö–æ–¥—å–∫–æ –ò.–ù./–ö–æ—Ä–æ–ª—å—á—É–∫ –û.–ì.'),
            (5, '–§–∏–∑–∫—É–ª—å—Ç—É—Ä–∞', '–°–º–æ–ª—å—Å–∫–∏–π –°.–ú./–í–µ—Ä–≥–µ–π—á–∏–∫ –í.–õ.'),
            (6, '–ë–∏–æ–ª–æ–≥–∏—è(–ø—Ä–æ—Ñ)', '–î–∞–Ω–∏–ª–µ–Ω–∫–æ –ê.–ê.'),
        ],
        '–°—Ä–µ–¥–∞': [
            (1, '–ë–µ–ª–æ—Ä—É—Å—Å–∫–∏–π —è–∑—ã–∫', '–õ–µ–±–µ–¥–µ–≤—Å–∫–∞—è –ú.–ü.'),
            (2, '–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞', '–ù–∞–∑–∞—Ä–µ–Ω–∫–æ –¢.–ö.'),
            (3, '–ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–∫–∞', '–ì—É–¥ –Æ.–ü./–ù–∞–∑–∞—Ä–µ–Ω–∫–æ –¢.–ö.'),
            (4, '–ò—Å—Ç–æ—Ä–∏—è', '–ö–æ—Ä–æ–ª—ë–≤–∞ –ñ.–í./–°–∏–≤—ã–π –ê.–í.'),
            (5, '–ê–Ω–≥–ª. —è–∑—ã–∫/–ò—Å—Ç–æ—Ä–∏—è', '–¢–∏—Ö–æ–Ω–µ–Ω–∫–æ –û.–ê./–ö–æ—Ä–æ–ª—ë–≤–∞ –ñ.–í.'),
            (6, '–†—É—Å—Å–∫–∏–π —è–∑—ã–∫', '–õ–µ–æ–Ω–æ–≤–∞ –î.–ê.'),
            (7, '–ë–∏–æ–ª–æ–≥–∏—è/—Ö–∏–º–∏—è', '–î–∞–Ω–∏–ª–µ–Ω–∫–æ –ê.–ê./–ö–æ—Ä–æ–ª—å—á—É–∫ –û.–ì.'),
        ],
        '–ß–µ—Ç–≤–µ—Ä–≥': [
            (1, '–ì–µ–æ–≥—Ä–∞—Ñ–∏—è', '–Æ–Ω–∞—Ö –¢.–í.'),
            (2, '–ë–µ–ª–æ—Ä—É—Å—Å–∫–∏–π —è–∑—ã–∫', '–õ–µ–±–µ–¥–µ–≤—Å–∫–∞—è –ú.–ü.'),
            (3, '–†—É—Å. –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞', '–õ–µ–æ–Ω–æ–≤–∞ –î.–ê.'),
            (4, '–§–∏–∑–∫—É–ª—å—Ç—É—Ä–∞', '–°–º–æ–ª—å—Å–∫–∏–π –°.–ú.'),
            (5, '–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞', '–ù–∞–∑–∞—Ä–µ–Ω–∫–æ –¢.–ö.'),
            (6, '–î–ü/–ú–ü', '–î–∞–Ω–∏–ª–µ–Ω–∫–æ –ê.–ê./–°–º–æ–ª—å—Å–∫–∏–π –°.–ú.'),
            (7, '–ê–Ω–≥–ª–∏–π—Å–∫–∏–π —è–∑—ã–∫', '–ü—Ä–∏—Ö–æ–¥—å–∫–æ –ò.–ù.'),
        ],
        '–ü—è—Ç–Ω–∏—Ü–∞': [
            (1, '–ß–µ—Ä—á–µ–Ω–∏–µ', '–ú–∏—Ö–∞—Å—ë–≤ –í.–ê.'),
            (2, '–ê–Ω–≥–ª. —è–∑—ã–∫/–ò—Å—Ç–æ—Ä–∏—è', '–¢–∏—Ö–æ–Ω–µ–Ω–∫–æ –û.–ê./–ö–æ—Ä–æ–ª—ë–≤–∞ –ñ.–í.'),
            (3, '–§–∏–∑–∏–∫–∞', '–ö–æ—Ä–æ—Ç—á–∏–∫–æ–≤–∞ –õ.–í.'),
            (4, '–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞', '–ù–∞–∑–∞—Ä–µ–Ω–∫–æ –¢.–ö.'),
            (5, '–ë–∏–æ–ª–æ–≥–∏—è/–•–∏–º–∏—è', '–ö–∞–Ω—É–Ω–æ–≤–∞ –í.–ì./–ö–æ—Ä–æ–ª—å—á—É–∫ –û.–ì.'),
            (6, '–û–±—â–µ—Å—Ç–≤–æ–≤–µ–¥–µ–Ω–∏–µ', '–°–∏–≤—ã–π –ê.–í.'),
        ]
    },
    '11': {
        '–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫': [
            (1, '–ë–∏–æ–ª–æ–≥–∏—è/–•–∏–º–∏—è', '–î–∞–Ω–∏–ª–µ–Ω–∫–æ –ê.–ê./–ö–æ—Ä–æ–ª—å—á—É–∫ –û.–ì.'),
            (2, '–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞', '–ö–æ—Ä–æ—Ç—á–∏–∫–æ–≤–∞ –õ.–í.'),
            (3, '–û–±—â–µ—Å—Ç–≤–æ–≤–µ–¥–µ–Ω–∏–µ', '–ö–æ—Ä–æ–ª—ë–≤–∞ –ñ.–í.'),
            (4, '–§–∏–∑–∏–∫–∞', '–°—Ç–∏—à–µ–Ω–æ–∫ –ù.–ò.'),
            (5, '–ò—Å—Ç–æ—Ä–∏—è', '–ö–æ—Ä–æ–ª—ë–≤–∞ –ñ.–í.'),
            (6, '–§–∏–∑–∫—É–ª—å—Ç—É—Ä–∞', '–í–µ—Ä–≥–µ–π—á–∏–∫ –í.–õ./–Ø–≤–æ—à –°.–í.'),
            (7, '–ê–Ω–≥–ª. —è–∑/–†—É—Å. —è–∑', '–¢–∏—Ö–æ–Ω–µ–Ω–∫–æ –û.–ê./–ü–∏–Ω—á—É–∫ –ê.–í.'),
        ],
        '–í—Ç–æ—Ä–Ω–∏–∫': [
            (1, '–ë–µ–ª. –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞', '–õ—É–∫—å—è–Ω–µ–Ω–∫–æ –õ.–ò.'),
            (2, '–ò—Å—Ç–æ—Ä–∏—è', '–ö–æ—Ä–æ–ª—ë–≤–∞ –ñ.–í.'),
            (3, '–§–∏–∑–∫—É–ª—å—Ç—É—Ä–∞', '–í–µ—Ä–≥–µ–π—á–∏–∫ –í.–õ./–Ø–≤–æ—à –°.–í.'),
            (4, '–ê–Ω–≥–ª. —è–∑/–†—É—Å. —è–∑', '–•–æ—Ä–æ—à–∫–æ –¢.–ê./–ü–∏–Ω—á—É–∫ –ê.–í.'),
            (5, '–ê–Ω–≥–ª. —è–∑/–†—É—Å. —è–∑', '–¢–∏—Ö–æ–Ω–µ–Ω–∫–æ –û.–ê./–ü–∏–Ω—á—É–∫ –ê.–í.'),
            (6, '–†—É—Å. —è–∑/–•–∏–º–∏—è', '–ü–∏–Ω—á—É–∫ –ê.–í./–ö–æ—Ä–æ–ª—å—á—É–∫ –û.–ì.'),
        ],
        '–°—Ä–µ–¥–∞': [
            (1, '–ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–∫–∞', '–ì—É–¥ –Æ.–ü./–ü—Ä–∏—Ö–∞—á –ï.–í.'),
            (2, '–ì–µ–æ–≥—Ä–∞—Ñ–∏—è', '–Æ–Ω–∞—Ö –¢.–í.'),
            (3, '–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞', '–ö–æ—Ä–æ—Ç—á–∏–∫–æ–≤–∞ –õ.–í.'),
            (4, '–ë–∏–æ–ª–æ–≥–∏—è/–•–∏–º–∏—è', '–î–∞–Ω–∏–ª–µ–Ω–∫–æ –ê.–ê./–ö–æ—Ä–æ–ª—å—á—É–∫ –û.–ì.'),
            (5, '–ë–µ–ª–æ—Ä—É—Å—Å–∫–∏–π —è–∑—ã–∫', '–õ—É–∫—å—è–Ω–µ–Ω–∫–æ –õ.–ò.'),
            (6, '–î–ü/–ú–ü', '–î–∞–Ω–∏–ª–µ–Ω–∫–æ –ê.–ê./–Ø–≤–æ—à –°.–í.'),
        ],
        '–ß–µ—Ç–≤–µ—Ä–≥': [
            (1, '–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞', '–ö–æ—Ä–æ—Ç—á–∏–∫–æ–≤–∞ –õ.–í.'),
            (2, '–ê—Å—Ç—Ä–æ–Ω–æ–º–∏—è', '–°—Ç–∏—à–µ–Ω–æ–∫ –ù.–ò.'),
            (3, '–ë–µ–ª. –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞', '–õ—É–∫—å—è–Ω–µ–Ω–∫–æ –õ.–ò.'),
            (4, '–§–∏–∑–∏–∫–∞', '–°—Ç–∏—à–µ–Ω–æ–∫ –ù.–ò.'),
            (5, '–ë–∏–æ–ª–æ–≥–∏—è/–•–∏–º–∏—è', '–ö–∞–Ω—É–Ω–æ–≤–∞ –í.–ì./–ö–æ—Ä–æ–ª—å—á—É–∫ –û.–ì.'),
            (6, '–ê–Ω–≥–ª. —è–∑/–ë–∏–æ–ª–æ–≥–∏—è', '–¢–∏—Ö–æ–Ω–µ–Ω–∫–æ –û.–ê./–ö–∞–Ω—É–Ω–æ–≤–∞ –í.–ì.'),
        ],
        '–ü—è—Ç–Ω–∏—Ü–∞': [
            (1, '–§–∏–∑–∫—É–ª—å—Ç—É—Ä–∞', '–Ø–≤–æ—à –°.–í.'),
            (2, '–†—É—Å. –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞', '–ü–∏–Ω—á—É–∫ –ê.–í.'),
            (3, '–ê–Ω–≥–ª. —è–∑/–†—É—Å. —è–∑', '–•–æ—Ä–æ—à–∫–æ –¢.–ê./–ü–∏–Ω—á—É–∫ –ê.–í.'),
            (4, '–ë–∏–æ–ª–æ–≥–∏—è/–•–∏–º–∏—è', '–ö–∞–Ω—É–Ω–æ–≤–∞ –í.–ì./–ö–æ—Ä–æ–ª—å—á—É–∫ –û.–ì.'),
            (5, '–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞', '–ö–æ—Ä–æ—Ç—á–∏–∫–æ–≤–∞ –õ.–í.'),
            (6, '–ë–∏–æ–ª–æ–≥–∏—è/–ê–Ω–≥–ª. —è–∑', '–ö–∞–Ω—É–Ω–æ–≤–∞ –í.–ì./–¢–∏—Ö–æ–Ω–µ–Ω–∫–æ –û.–ê.'),
            (7, '–•–∏–º–∏—è(–ø—Ä–æ—Ñ)', '–ö–æ—Ä–æ–ª—å—á—É–∫ –û.–ì.'),
        ]
    }
}

# ================== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ==================
def get_lesson_time(lesson_number):
    lesson_times = {
        1: "08:00-08:45",
        2: "09:00-09:45",
        3: "10:00-10:45",
        4: "11:00-11:45",
        5: "12:00-12:45",
        6: "12:55-13:40",
        7: "14:00-14:45"
    }
    return lesson_times.get(lesson_number, "??:??-??:??")

def get_current_lesson_info():
    tz_minsk = pytz.timezone('Europe/Minsk')
    now = datetime.now(tz_minsk)
    current_minutes = now.hour * 60 + now.minute
    lesson_intervals = [
        (8, 0, 8, 45, 1),
        (9, 0, 9, 45, 2),
        (10, 0, 10, 45, 3),
        (11, 0, 11, 45, 4),
        (12, 0, 12, 45, 5),
        (12, 55, 13, 40, 6),
        (14, 0, 14, 45, 7)
    ]
    for start_h, start_m, end_h, end_m, num in lesson_intervals:
        start_total = start_h * 60 + start_m
        end_total = end_h * 60 + end_m
        if start_total <= current_minutes <= end_total:
            return {
                'status': 'lesson',
                'number': num,
                'time_left': end_total - current_minutes,
                'start_time': f"{start_h:02d}:{start_m:02d}",
                'end_time': f"{end_h:02d}:{end_m:02d}"
            }
    for start_h, start_m, end_h, end_m, num in lesson_intervals:
        start_total = start_h * 60 + start_m
        if current_minutes < start_total:
            return {
                'status': 'break',
                'next_number': num,
                'minutes_until': start_total - current_minutes,
                'start_time': f"{start_h:02d}:{start_m:02d}",
                'end_time': f"{end_h:02d}:{end_m:02d}"
            }
    return {'status': 'finished'}

async def safe_edit_message(query, text, reply_markup=None, parse_mode='HTML', max_len=4096):
    if len(text) > max_len:
        text = text[:max_len-100] + "\n\n... (—Å–æ–æ–±—â–µ–Ω–∏–µ –æ–±—Ä–µ–∑–∞–Ω–æ)"
    try:
        await query.edit_message_text(text, reply_markup=reply_markup, parse_mode=parse_mode)
    except BadRequest as e:
        if "Message is not modified" in str(e):
            await query.answer()
        else:
            raise

async def safe_send_message(context, chat_id, text, reply_markup=None, parse_mode='HTML'):
    try:
        return await context.bot.send_message(chat_id=chat_id, text=text, reply_markup=reply_markup, parse_mode=parse_mode)
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è: {e}")
        return None

# ================== –§–£–ù–ö–¶–ò–ò –î–õ–Ø –†–ê–°–ü–ò–°–ê–ù–ò–Ø –£–ß–ò–¢–ï–õ–ï–ô ==================
def get_teacher_schedule(teacher_name):
    schedule = {}
    for class_name, days in SCHEDULE_STRUCTURED.items():
        for day, lessons in days.items():
            for lesson in lessons:
                if len(lesson) >= 3:
                    current_teacher = lesson[2]
                    teacher_list = [t.strip() for t in current_teacher.split('/')]
                    teacher_list_clean = [re.sub(r'\s*\([^)]*\)\s*', '', t).strip() for t in teacher_list]
                    if teacher_name in teacher_list_clean:
                        if day not in schedule:
                            schedule[day] = []
                        lesson_info = {
                            'class': class_name,
                            'number': lesson[0],
                            'subject': lesson[1],
                            'time': get_lesson_time(lesson[0]),
                            'full_teacher': current_teacher
                        }
                        schedule[day].append(lesson_info)
    for day in schedule:
        schedule[day].sort(key=lambda x: x['number'])
    return schedule

def get_all_teachers():
    teachers = set()
    for class_name, days in SCHEDULE_STRUCTURED.items():
        for day, lessons in days.items():
            for lesson in lessons:
                if len(lesson) >= 3:
                    teacher_name = lesson[2]
                    if teacher_name:
                        teacher_list = [t.strip() for t in teacher_name.split('/')]
                        for teacher in teacher_list:
                            teacher_clean = re.sub(r'\s*\([^)]*\)\s*', '', teacher).strip()
                            if teacher_clean and teacher_clean not in ['', ' ']:
                                teachers.add(teacher_clean)
    return sorted(list(teachers))

ALL_TEACHERS = get_all_teachers()

_teacher_schedule_cache = {}
_teacher_schedule_cache_lock = asyncio.Lock()

def get_cached_teacher_schedule(teacher_name):
    if teacher_name not in _teacher_schedule_cache:
        _teacher_schedule_cache[teacher_name] = get_teacher_schedule(teacher_name)
    return _teacher_schedule_cache[teacher_name]

# ================== –û–°–¢–ê–õ–¨–ù–´–ï –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ==================
async def format_schedule_day(class_name, day, structured_lessons, target_date=None):
    if not structured_lessons:
        return "–ù–∞ —ç—Ç–æ—Ç –¥–µ–Ω—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è –Ω–µ—Ç.", None
        
    structured_lessons.sort(key=lambda x: x[0])
    
    substitutions = []
    if target_date and target_date != 'None' and target_date != 'null' and target_date is not None:
        substitutions = await asyncio.to_thread(
            db.get_substitutions_for_class_date,
            class_name,
            target_date
        )
    
    sub_dict = {}
    for sub in substitutions:
        lesson_num = sub[3]
        sub_dict[lesson_num] = {
            'old_subject': sub[4],
            'new_subject': sub[5],
            'old_teacher': sub[6],
            'new_teacher': sub[7]
        }
    
    result_lines = []
    keyboard = []
    
    header = f"üìÖ <b>{day.upper()} - {class_name.upper()}</b>"
    result_lines.append(header)
    result_lines.append("‚îÄ" * 18)
    
    for lesson_num, subject, teacher in structured_lessons:
        lesson_time = get_lesson_time(lesson_num)
        
        if 1 <= lesson_num <= 7:
            emoji = ["1Ô∏è‚É£", "2Ô∏è‚É£", "3Ô∏è‚É£", "4Ô∏è‚É£", "5Ô∏è‚É£", "6Ô∏è‚É£", "7Ô∏è‚É£"][lesson_num - 1]
            lesson_str = f"{emoji} "
        else:
            lesson_str = f"{lesson_num}. "
        
        # –°–æ–∑–¥–∞—ë–º –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ –¥–ª—è –ø—Ä–µ–¥–º–µ—Ç–∞ –∏ —É—á–∏—Ç–µ–ª—è
        subject_button = InlineKeyboardButton(
            text=subject,
            callback_data='noop_lesson'
        )
        teacher_button = InlineKeyboardButton(
            text=teacher,
            callback_data='noop_teacher'
        )
        
        # –î–æ–±–∞–≤–ª—è–µ–º –≤—Ä–µ–º—è –∫–∞–∫ —Ç–µ–∫—Å—Ç
        result_lines.append(f"{lesson_str} <b>{lesson_time}</b>")
        
        # –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ –≤ –æ–¥–Ω—É —Å—Ç—Ä–æ–∫—É
        keyboard.append([subject_button, teacher_button])
        
        if lesson_num in sub_dict:
            sub = sub_dict[lesson_num]
            result_lines.append(f"   ‚îî‚îÄ üîÑ <b>–ó–ê–ú–ï–ù–ê:</b> {sub['new_subject']} ‚úÖ {sub['new_teacher']}")
    
    result_lines.append("")
    text = "\n".join(result_lines)
    
    return text, InlineKeyboardMarkup(keyboard)

def format_weekly_schedule(class_name):
    if class_name not in SCHEDULE_STRUCTURED:
        return f"–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è –∫–ª–∞—Å—Å–∞ {class_name} –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.", None
        
    result_lines = []
    keyboard = []
    
    result_lines.append(f"üìÖ <b>–†–ê–°–ü–ò–°–ê–ù–ò–ï –ù–ê –ù–ï–î–ï–õ–Æ - {class_name.upper()}</b>")
    result_lines.append("=" * 30)
    
    days_order = ["–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫", "–í—Ç–æ—Ä–Ω–∏–∫", "–°—Ä–µ–¥–∞", "–ß–µ—Ç–≤–µ—Ä–≥", "–ü—è—Ç–Ω–∏—Ü–∞"]
    
    for day in days_order:
        if day in SCHEDULE_STRUCTURED[class_name]:
            lessons = SCHEDULE_STRUCTURED[class_name][day]
            if lessons:
                result_lines.append(f"\n<b>üìå {day.upper()}</b>")
                result_lines.append("‚îÄ" * 18)
                
                for lesson_num, subject, teacher in lessons:
                    lesson_time = get_lesson_time(lesson_num)
                    
                    if 1 <= lesson_num <= 7:
                        emoji = ["1Ô∏è‚É£", "2Ô∏è‚É£", "3Ô∏è‚É£", "4Ô∏è‚É£", "5Ô∏è‚É£", "6Ô∏è‚É£", "7Ô∏è‚É£"][lesson_num - 1]
                        lesson_str = f"{emoji} "
                    else:
                        lesson_str = f"{lesson_num}. "
                    
                    result_lines.append(f"{lesson_str} <b>{lesson_time}</b>")
                    
                    # –ö–Ω–æ–ø–∫–∏ –¥–ª—è –ø—Ä–µ–¥–º–µ—Ç–∞ –∏ —É—á–∏—Ç–µ–ª—è
                    keyboard.append([
                        InlineKeyboardButton(text=subject, callback_data='noop_lesson'),
                        InlineKeyboardButton(text=teacher, callback_data='noop_teacher')
                    ])
    
    result_lines.append("")
    text = "\n".join(result_lines)
    
    return text, InlineKeyboardMarkup(keyboard)

def format_substitution(sub):
    if len(sub) >= 9:
        return (f"‚Ü™Ô∏è {sub[8]} –∫–ª–∞—Å—Å, {sub[3]} —É—Ä–æ–∫:\n"
                f"       `{sub[4]}` ({sub[6]})\n"
                f"   ‚Üí    `{sub[5]}` ({sub[7]})")
    return str(sub)

async def send_substitution_notification(context, teacher_name, substitution_data):
    teacher_name_clean = teacher_name.replace('_', ' ').strip()
    teacher_id = TEACHER_IDS.get(teacher_name_clean)
    logger.info(f"üì® –ü–æ–ø—ã—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —É—á–∏—Ç–µ–ª—é: '{teacher_name_clean}' (ID –≤ —Å–ª–æ–≤–∞—Ä–µ: {teacher_id})")
    if not teacher_id or teacher_id == 0:
        logger.warning(f"‚ùå –£—á–∏—Ç–µ–ª—å '{teacher_name_clean}' –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ TEACHER_IDS –∏–ª–∏ –∏–º–µ–µ—Ç –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π ID=0")
        for admin_id in ADMIN_IDS:
            try:
                await context.bot.send_message(
                    chat_id=admin_id,
                    text=f"‚ö†Ô∏è –ó–∞–º–µ–Ω–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –¥–ª—è '{teacher_name_clean}', –Ω–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ù–ï –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ (–Ω–µ—Ç –≤–∞–ª–∏–¥–Ω–æ–≥–æ Telegram ID)",
                    parse_mode='HTML'
                )
            except Exception as e:
                logger.error(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω—É: {e}")
        return
    try:
        lesson_time = get_lesson_time(substitution_data['lesson'])
        notification_message = (
            f"<b>üîî –í–ê–ú –ù–ê–ó–ù–ê–ß–ï–ù–ê –ó–ê–ú–ï–ù–ê!</b>\n"
            f"<b>üìÖ –î–∞—Ç–∞:</b> {substitution_data['date']}\n"
            f"<b>üìÖ –î–µ–Ω—å –Ω–µ–¥–µ–ª–∏:</b> {substitution_data['day']}\n"
            f"<b>üïê –í—Ä–µ–º—è —É—Ä–æ–∫–∞:</b> {lesson_time}\n"
            f"<b>üî¢ –ù–æ–º–µ—Ä —É—Ä–æ–∫–∞:</b> {substitution_data['lesson']}\n"
            f"<b>üè´ –ö–ª–∞—Å—Å:</b> {substitution_data['class_name']}\n"
            f"<b>üìö –ó–∞–º–µ–Ω–∞:</b> {substitution_data['old_subject']} ({substitution_data['old_teacher']}) ‚Üí "
            f"{substitution_data['new_subject']} (–í—ã)\n"
            f"<i>–ó–∞–º–µ–Ω–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º.</i>"
        )
        await context.bot.send_message(
            chat_id=teacher_id,
            text=notification_message,
            parse_mode='HTML'
        )
        logger.info(f"‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –∑–∞–º–µ–Ω–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —É—á–∏—Ç–µ–ª—é {teacher_name_clean} (ID: {teacher_id})")
    except Exception as e:
        error_msg = str(e)
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —É—á–∏—Ç–µ–ª—é {teacher_name_clean} (ID: {teacher_id}): {error_msg}")
        for admin_id in ADMIN_IDS:
            try:
                await context.bot.send_message(
                    chat_id=admin_id,
                    text=f"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —É—á–∏—Ç–µ–ª—é '{teacher_name_clean}' (ID: {teacher_id}):\n{error_msg[:100]}",
                    parse_mode='HTML'
                )
            except Exception as e2:
                logger.error(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω—É –æ–± –æ—à–∏–±–∫–µ: {e2}")

# ================== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –î–õ–Ø –ö–û–ù–í–ï–†–¢–ê–¶–ò–ò –í–†–ï–ú–ï–ù–ò ==================
def convert_utc_to_minsk(utc_str):
    try:
        utc_dt = datetime.strptime(utc_str, '%Y-%m-%d %H:%M:%S')
        utc_dt = pytz.utc.localize(utc_dt)
        minsk_tz = pytz.timezone('Europe/Minsk')
        minsk_dt = utc_dt.astimezone(minsk_tz)
        return minsk_dt.strftime('%d.%m.%Y %H:%M')
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ –≤—Ä–µ–º–µ–Ω–∏: {e}")
        return utc_str
     # ================== –ò–ò-–ü–û–ú–û–©–ù–ò–ö (Groq Free) ==================
async def ask_gpt(question: str, user_id: int = None) -> str:
    """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –≤–æ–ø—Ä–æ—Å –≤ Groq API (–±–µ—Å–ø–ª–∞—Ç–Ω–æ, –±—ã—Å—Ç—Ä–æ)."""
    if not GROQ_API_KEY:
        return "‚ùå –ò–ò-–ø–æ–º–æ—â–Ω–∏–∫ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω. –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É –Ω—É–∂–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å GROQ_API_KEY."
    
    url = "https://api.groq.com/openai/v1/chat/completions"
    headers = {
        "Authorization": f"Bearer {GROQ_API_KEY}",
        "Content-Type": "application/json"
    }
    
    data = {
        "model": GROQ_MODEL,
        "messages": [
            {
                "role": "system",
                "content": "–¢—ã ‚Äî –ø–æ–ª–µ–∑–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫ –¥–ª—è —à–∫–æ–ª—å–Ω–∏–∫–æ–≤ –±–µ–ª–æ—Ä—É—Å—Å–∫–æ–π —à–∫–æ–ª—ã. –û—Ç–≤–µ—á–∞–π –∫—Ä–∞—Ç–∫–æ, –ø–æ–Ω—è—Ç–Ω–æ, –¥—Ä—É–∂–µ–ª—é–±–Ω–æ. –ò—Å–ø–æ–ª—å–∑—É–π –ø—Ä–∏–º–µ—Ä—ã, –µ—Å–ª–∏ —ç—Ç–æ –ø–æ–º–æ–≥–∞–µ—Ç –ø–æ–Ω—è—Ç—å —Ç–µ–º—É. –ù–µ –¥–∞–≤–∞–π –≥–æ—Ç–æ–≤—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤ –Ω–∞ –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–µ ‚Äî –æ–±—ä—è—Å–Ω—è–π, –∫–∞–∫ —Ä–µ—à–∞—Ç—å. –ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å –Ω–µ –ø–æ —É—á—ë–±–µ ‚Äî –≤–µ–∂–ª–∏–≤–æ –Ω–∞–ø—Ä–∞–≤—å –∫ —É—á–µ–±–Ω—ã–º —Ç–µ–º–∞–º."
            },
            {
                "role": "user",
                "content": question
            }
        ],
        "max_tokens": 500,
        "temperature": 0.7
    }
    
    async with httpx.AsyncClient(timeout=30.0) as client:
        try:
            resp = await client.post(url, json=data, headers=headers)
            
            if resp.status_code == 429:
                return "‚è≥ –ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —á–µ—Ä–µ–∑ –º–∏–Ω—É—Ç—É."
            elif resp.status_code == 401:
                return "‚ùå –û—à–∏–±–∫–∞ API-–∫–ª—é—á–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ GROQ_API_KEY."
            elif resp.status_code >= 400:
                return f"‚ùå –û—à–∏–±–∫–∞ API: {resp.status_code}. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ."
            
            resp.raise_for_status()
            result = resp.json()
            
            answer = result['choices'][0]['message']['content'].strip()
            
            if not answer:
                return "‚ùå –ò–ò –≤–µ—Ä–Ω—É–ª –ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ—Ñ—Ä–∞–∑–∏—Ä–æ–≤–∞—Ç—å –≤–æ–ø—Ä–æ—Å."
            
            if len(answer) > 4000:
                answer = answer[:4000] + "\n\n<em>–û—Ç–≤–µ—Ç –æ–±—Ä–µ–∑–∞–Ω</em>"
            
            return answer
            
        except httpx.TimeoutException:
            logger.error("Groq API: —Ç–∞–π–º–∞—É—Ç")
            return "‚è≥ –ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ."
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ Groq: {e}")
            return f"‚ùå –û—à–∏–±–∫–∞ –ò–ò: {str(e)[:100]}"

# ================== –§–£–ù–ö–¶–ò–ò –î–õ–Ø –ò–ó–ë–†–ê–ù–ù–û–ì–û ==================
async def show_my_menu(query, context):
    user_id = query.from_user.id
    favorites = await asyncio.to_thread(db.get_user_favorites, user_id)
    if not favorites:
        text = "üåü <b>–ú–û—ë</b>\n\n–£ –≤–∞—Å –Ω–µ—Ç –∏–∑–±—Ä–∞–Ω–Ω—ã—Ö –∫–ª–∞—Å—Å–æ–≤ –∏–ª–∏ —É—á–∏—Ç–µ–ª–µ–π.\n–î–æ–±–∞–≤—å—Ç–µ –∏—Ö –∏–∑ –º–µ–Ω—é —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è."
        keyboard = [
            [InlineKeyboardButton("üìö –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ —É—Ä–æ–∫–æ–≤", callback_data='menu_schedule')],
            [InlineKeyboardButton("üë®‚Äçüè´ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ —É—á–∏—Ç–µ–ª–µ–π", callback_data='menu_teacher')],
            [InlineKeyboardButton("üè† –°—Ç–∞—Ä—Ç / –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data='back_to_main')]
        ]
        reply_markup = InlineKeyboardMarkup(keyboard)
        await safe_edit_message(query, text, reply_markup=reply_markup)
        return

    favorite_classes = [val for fav_type, val in favorites if fav_type == 'class']
    favorite_teachers = [val for fav_type, val in favorites if fav_type == 'teacher']

    text = "üåü <b>–ú–û—ë</b>\n\n"
    keyboard = []

    if favorite_classes:
        text += "<b>üìö –ò–∑–±—Ä–∞–Ω–Ω—ã–µ –∫–ª–∞—Å—Å—ã:</b>\n"
        for cls in favorite_classes:
            text += f"‚Ä¢ {cls.upper()}\n"
            keyboard.append([
                InlineKeyboardButton(f"üìÖ {cls.upper()}", callback_data=f'my_class_{cls}'),
                InlineKeyboardButton("üóë –£–¥–∞–ª–∏—Ç—å", callback_data=f'remove_favorite_class_{cls}')
            ])
        text += "\n"

    if favorite_teachers:
        text += "<b>üë®‚Äçüè´ –ò–∑–±—Ä–∞–Ω–Ω—ã–µ —É—á–∏—Ç–µ–ª—è:</b>\n"
        for teacher in favorite_teachers:
            try:
                index = ALL_TEACHERS.index(teacher)
            except ValueError:
                continue
            text += f"‚Ä¢ {teacher}\n"
            keyboard.append([
                InlineKeyboardButton(f"üë®‚Äçüè´ {teacher}", callback_data=f'my_teacher_{index}'),
                InlineKeyboardButton("üóë –£–¥–∞–ª–∏—Ç—å", callback_data=f'remove_favorite_teacher_{index}')
            ])
        text += "\n"

    keyboard.append([InlineKeyboardButton("üè† –°—Ç–∞—Ä—Ç / –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data='back_to_main')])
    reply_markup = InlineKeyboardMarkup(keyboard)
    await safe_edit_message(query, text, reply_markup=reply_markup)

async def show_teacher_schedule_by_name(query, context, teacher_name):
    teacher_schedule = get_cached_teacher_schedule(teacher_name)
    schedule_text = await format_teacher_schedule(teacher_name, teacher_schedule)
    user_id = query.from_user.id
    is_fav = await asyncio.to_thread(db.is_favorite, user_id, 'teacher', teacher_name)
    fav_button_text = "üóë –£–¥–∞–ª–∏—Ç—å –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ" if is_fav else "‚≠ê –î–æ–±–∞–≤–∏—Ç—å –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ"
    fav_callback = f"toggle_favorite_teacher_{ALL_TEACHERS.index(teacher_name)}"

    keyboard = [
        [InlineKeyboardButton(fav_button_text, callback_data=fav_callback)],
        [InlineKeyboardButton("üåü –ú–û—ë", callback_data='menu_my')],
        [InlineKeyboardButton("üë®‚Äçüè´ –í—Å–µ —É—á–∏—Ç–µ–ª—è", callback_data='menu_teacher')],
        [InlineKeyboardButton("üè† –°—Ç–∞—Ä—Ç / –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data='back_to_main')]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    await safe_edit_message(query, schedule_text, reply_markup=reply_markup)

# ================== –§–£–ù–ö–¶–ò–ò –î–õ–Ø –ù–û–í–û–°–¢–ï–ô (–ü–ê–ì–ò–ù–ê–¶–ò–Ø, –ü–†–û–°–ú–û–¢–†–´) ==================
NEWS_PER_PAGE = 5

async def delete_news_messages(context, chat_id, message_ids):
    for msg_id in message_ids:
        try:
            await context.bot.delete_message(chat_id=chat_id, message_id=msg_id)
        except Exception as e:
            logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ {msg_id}: {e}")

async def show_news_menu(query, context, page=0):
    user_id = query.from_user.id
    chat_id = query.message.chat_id
    offset = page * NEWS_PER_PAGE
    news_list = await asyncio.to_thread(db.get_news_page_asc, offset, NEWS_PER_PAGE)
    total_news = await asyncio.to_thread(db.get_total_news_count)
    total_pages = (total_news + NEWS_PER_PAGE - 1) // NEWS_PER_PAGE

    if 'news_message_ids' in context.user_data:
        await delete_news_messages(context, chat_id, context.user_data['news_message_ids'])

    message_ids = []
    if not news_list:
        text = "üì∞ <b>–®–ö–û–õ–¨–ù–´–ï –ù–û–í–û–°–¢–ò</b>\n\nüì≠ –ù–æ–≤–æ—Å—Ç–µ–π –ø–æ–∫–∞ –Ω–µ—Ç."
        msg = await safe_send_message(context, chat_id, text)
        if msg:
            message_ids.append(msg.message_id)
    else:
        for news in news_list:
            news_id, title, content, pub_date, views = news
            pub_date_str = convert_utc_to_minsk(pub_date.strftime('%Y-%m-%d %H:%M:%S') if hasattr(pub_date, 'strftime') else pub_date)
            text = f"üìå <b>{title}</b>\n"
            text += f"<i>üìÖ {pub_date_str}</i>  üëÅ {views}\n\n"
            text += f"{content}\n\n"
            text += "‚îÄ" * 20
            keyboard = []
            if query.from_user.id in ADMIN_IDS:
                admin_row = [
                    InlineKeyboardButton("‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å", callback_data=f'admin_edit_news_{news_id}'),
                    InlineKeyboardButton("üóë –£–¥–∞–ª–∏—Ç—å", callback_data=f'delete_news_{news_id}')
                ]
                keyboard.append(admin_row)
            keyboard.append([InlineKeyboardButton("üìñ –ß–∏—Ç–∞—Ç—å –ø–æ–ª–Ω–æ—Å—Ç—å—é", callback_data=f'news_detail_{news_id}')])
            reply_markup = InlineKeyboardMarkup(keyboard)
            msg = await safe_send_message(context, chat_id, text, reply_markup)
            if msg:
                message_ids.append(msg.message_id)

    nav_row = []
    if page > 0:
        nav_row.append(InlineKeyboardButton("‚óÄÔ∏è –ü—Ä–µ–¥—ã–¥—É—â–∞—è", callback_data=f'news_page_{page-1}'))
    nav_row.append(InlineKeyboardButton(f"{page+1}/{total_pages}", callback_data='noop'))
    if page < total_pages - 1:
        nav_row.append(InlineKeyboardButton("–°–ª–µ–¥—É—é—â–∞—è ‚ñ∂Ô∏è", callback_data=f'news_page_{page+1}'))
    nav_keyboard = [nav_row, [InlineKeyboardButton("üè† –°—Ç–∞—Ä—Ç / –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data='back_to_main')]]
    nav_markup = InlineKeyboardMarkup(nav_keyboard)
    nav_msg = await safe_send_message(context, chat_id, "üì∞ <b>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü–∞–º–∏</b>", nav_markup)
    if nav_msg:
        message_ids.append(nav_msg.message_id)

    context.user_data['news_message_ids'] = message_ids
    context.user_data['news_page'] = page

async def show_news_detail(query, context, news_id):
    user_id = query.from_user.id
    chat_id = query.message.chat_id
    await asyncio.to_thread(db.increment_news_views, news_id, user_id)
    news = await asyncio.to_thread(db.get_news_detail, news_id)
    if not news:
        await query.answer("‚ùå –ù–æ–≤–æ—Å—Ç—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞", show_alert=True)
        return

    pub_date_str = convert_utc_to_minsk(news['published_at'].strftime('%Y-%m-%d %H:%M:%S') if hasattr(news['published_at'], 'strftime') else news['published_at'])
    text = f"üìå <b>{news['title']}</b>\n"
    text += f"<i>üìÖ {pub_date_str}</i>  üëÅ {news['views_count']}\n\n"
    text += f"{news['content']}\n\n"
    text += "‚îÄ" * 20

    keyboard = []
    if query.from_user.id in ADMIN_IDS:
        admin_row = [
            InlineKeyboardButton("‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å", callback_data=f'admin_edit_news_{news_id}'),
            InlineKeyboardButton("üóë –£–¥–∞–ª–∏—Ç—å", callback_data=f'delete_news_{news_id}')
        ]
        keyboard.append(admin_row)
    keyboard.append([InlineKeyboardButton("‚óÄÔ∏è –ö —Å–ø–∏—Å–∫—É –Ω–æ–≤–æ—Å—Ç–µ–π", callback_data=f'news_page_{context.user_data.get("news_page", 0)}')])
    keyboard.append([InlineKeyboardButton("üè† –°—Ç–∞—Ä—Ç / –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data='back_to_main')])

    reply_markup = InlineKeyboardMarkup(keyboard)
    msg = await safe_send_message(context, chat_id, text, reply_markup)
    if msg:
        context.user_data['current_detail_message_id'] = msg.message_id

# ================== –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–ï –ù–û–í–û–°–¢–ï–ô (–ê–î–ú–ò–ù) ==================
async def start_edit_news(query, context, news_id):
    if query.from_user.id not in ADMIN_IDS:
        return
    news = await asyncio.to_thread(db.get_news_detail, news_id)
    if not news:
        await query.answer("‚ùå –ù–æ–≤–æ—Å—Ç—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞", show_alert=True)
        return
    context.user_data['editing_news'] = news_id
    context.user_data['news_step'] = 'title'
    context.user_data['news_title'] = news['title']
    context.user_data['news_content'] = news['content']
    keyboard = [[InlineKeyboardButton("‚ùå –û—Ç–º–µ–Ω–∞", callback_data='cancel_edit_news')]]
    reply_markup = InlineKeyboardMarkup(keyboard)
    await safe_edit_message(
        query,
        f"‚úèÔ∏è <b>–†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–ï –ù–û–í–û–°–¢–ò (ID {news_id})</b>\n\n"
        f"–¢–µ–∫—É—â–∏–π –∑–∞–≥–æ–ª–æ–≤–æ–∫:\n{news['title']}\n\n"
        f"–í–≤–µ–¥–∏—Ç–µ <b>–Ω–æ–≤—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫</b> (–¥–æ 100 —Å–∏–º–≤–æ–ª–æ–≤):",
        reply_markup=reply_markup
    )

async def handle_edit_news_input(update: Update, context: CallbackContext):
    if not context.user_data.get('editing_news'):
        return
    user_id = update.effective_user.id
    if user_id not in ADMIN_IDS:
        context.user_data.clear()
        return

    text = update.message.text.strip()
    step = context.user_data.get('news_step')

    if step == 'title':
        if len(text) > 100:
            await update.message.reply_text("‚ùå –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–π! –ú–∞–∫—Å–∏–º—É–º 100 —Å–∏–º–≤–æ–ª–æ–≤. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞:")
            return
        context.user_data['news_title'] = text
        context.user_data['news_step'] = 'content'
        keyboard = [[InlineKeyboardButton("‚ùå –û—Ç–º–µ–Ω–∞", callback_data='cancel_edit_news')]]
        reply_markup = InlineKeyboardMarkup(keyboard)
        await update.message.reply_text(
            f"‚úÖ –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å–æ—Ö—Ä–∞–Ω—ë–Ω: <b>{text}</b> ({len(text)}/100 —Å–∏–º–≤–æ–ª–æ–≤)\n\n"
            f"–¢–µ–∫—É—â–∏–π —Ç–µ–∫—Å—Ç –Ω–æ–≤–æ—Å—Ç–∏:\n{context.user_data['news_content']}\n\n"
            f"–í–≤–µ–¥–∏—Ç–µ <b>–Ω–æ–≤—ã–π —Ç–µ–∫—Å—Ç –Ω–æ–≤–æ—Å—Ç–∏</b> (–¥–æ 1000 —Å–∏–º–≤–æ–ª–æ–≤):",
            reply_markup=reply_markup,
            parse_mode='HTML'
        )
        return

    if step == 'content':
        if len(text) > 1000:
            await update.message.reply_text("‚ùå –¢–µ–∫—Å—Ç —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–π! –ú–∞–∫—Å–∏–º—É–º 1000 —Å–∏–º–≤–æ–ª–æ–≤. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞:")
            return
        context.user_data['news_content'] = text
        news_id = context.user_data['editing_news']
        title = context.user_data['news_title']
        content = text

        success = await asyncio.to_thread(db.update_news, news_id, title, content)
        if success:
            await update.message.reply_text(
                f"‚úÖ –ù–æ–≤–æ—Å—Ç—å —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∞!\n\n"
                f"<b>{title}</b>\n{content[:200]}{'...' if len(content) > 200 else ''}",
                parse_mode='HTML'
            )
            page = context.user_data.get('news_page', 0)
            keyboard = [[InlineKeyboardButton("üì∞ –ö –Ω–æ–≤–æ—Å—Ç—è–º", callback_data=f'news_page_{page}')]]
            reply_markup = InlineKeyboardMarkup(keyboard)
            await update.message.reply_text("–í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –Ω–æ–≤–æ—Å—Ç—è–º:", reply_markup=reply_markup)
        else:
            await update.message.reply_text("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –Ω–æ–≤–æ—Å—Ç–∏.")
        context.user_data.clear()

async def cancel_edit_news(query, context):
    context.user_data.clear()
    await show_news_menu(query, context, page=context.user_data.get('news_page', 0))

# ================== –ü–£–ë–õ–ò–ö–ê–¶–ò–Ø –ù–û–í–û–°–¢–ï–ô (–ê–î–ú–ò–ù) ==================
async def start_publish_news(query, context):
    if query.from_user.id not in ADMIN_IDS:
        return
    context.user_data['publishing_news'] = True
    context.user_data['news_step'] = 'title'
    keyboard = [[InlineKeyboardButton("‚ùå –û—Ç–º–µ–Ω–∞", callback_data='cancel_publish_news')]]
    reply_markup = InlineKeyboardMarkup(keyboard)
    await safe_edit_message(
        query,
        "üì£ <b>–ü–£–ë–õ–ò–ö–ê–¶–ò–Ø –ù–û–í–û–°–¢–ò</b>\n\n"
        "‚úèÔ∏è –í–≤–µ–¥–∏—Ç–µ <b>–∑–∞–≥–æ–ª–æ–≤–æ–∫</b> –Ω–æ–≤–æ—Å—Ç–∏ (–¥–æ 100 —Å–∏–º–≤–æ–ª–æ–≤):",
        reply_markup=reply_markup
    )

async def handle_news_input(update: Update, context: CallbackContext):
    if not context.user_data.get('publishing_news'):
        return
    user_id = update.effective_user.id
    if user_id not in ADMIN_IDS:
        context.user_data.clear()
        return

    text = update.message.text.strip()

    if context.user_data.get('news_step') == 'title':
        if len(text) > 100:
            await update.message.reply_text(
                "‚ùå –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–π! –ú–∞–∫—Å–∏–º—É–º 100 —Å–∏–º–≤–æ–ª–æ–≤.\n–ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞:",
                parse_mode='HTML'
            )
            return

        context.user_data['news_title'] = text
        context.user_data['news_step'] = 'content'

        keyboard = [[InlineKeyboardButton("‚ùå –û—Ç–º–µ–Ω–∞", callback_data='cancel_publish_news')]]
        reply_markup = InlineKeyboardMarkup(keyboard)
        await update.message.reply_text(
            f"‚úÖ –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å–æ—Ö—Ä–∞–Ω—ë–Ω: <b>{text}</b> ({len(text)}/100 —Å–∏–º–≤–æ–ª–æ–≤)\n\n"
            "‚úèÔ∏è –¢–µ–ø–µ—Ä—å –≤–≤–µ–¥–∏—Ç–µ <b>—Ç–µ–∫—Å—Ç –Ω–æ–≤–æ—Å—Ç–∏</b> (–¥–æ 1000 —Å–∏–º–≤–æ–ª–æ–≤):",
            reply_markup=reply_markup,
            parse_mode='HTML'
        )
        return

    if context.user_data.get('news_step') == 'content':
        if len(text) > 1000:
            await update.message.reply_text(
                "‚ùå –¢–µ–∫—Å—Ç —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–π! –ú–∞–∫—Å–∏–º—É–º 1000 —Å–∏–º–≤–æ–ª–æ–≤.\n–ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞:",
                parse_mode='HTML'
            )
            return

        context.user_data['news_content'] = text

        tz_minsk = pytz.timezone('Europe/Minsk')
        current_time_minsk = datetime.now(tz_minsk).strftime('%d.%m.%Y %H:%M')

        preview = (
            f"üì£ <b>–ü–†–ï–î–ü–†–û–°–ú–û–¢–† –ù–û–í–û–°–¢–ò</b>\n\n"
            f"<b>{context.user_data['news_title']}</b>\n\n"
            f"{context.user_data['news_content']}\n\n"
            f"<i>–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ: {current_time_minsk}</i>"
        )

        keyboard = [
            [InlineKeyboardButton("‚úÖ –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å + –†–ê–ó–û–°–õ–ê–¢–¨ –í–°–ï–ú", callback_data='publish_news_send_all')],
            [InlineKeyboardButton("üì§ –¢–æ–ª—å–∫–æ –æ–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å (–≤ –ª–µ–Ω—Ç—É)", callback_data='publish_news_only')],
            [InlineKeyboardButton("‚ùå –û—Ç–º–µ–Ω–∞", callback_data='cancel_publish_news')]
        ]
        reply_markup = InlineKeyboardMarkup(keyboard)
        await update.message.reply_text(preview, reply_markup=reply_markup, parse_mode='HTML')
        return

async def publish_news(query, context, send_to_all=False):
    title = context.user_data.get('news_title', '').strip()
    content = context.user_data.get('news_content', '').strip()

    if not title or not content:
        await safe_edit_message(
            query,
            "‚ùå –û—à–∏–±–∫–∞: –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø—É–±–ª–∏–∫–∞—Ü–∏–∏.",
            reply_markup=InlineKeyboardMarkup([[InlineKeyboardButton("‚Ü©Ô∏è –í –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å", callback_data='admin_panel')]])
        )
        context.user_data.clear()
        return

    news_id = await asyncio.to_thread(db.add_news, title, content)
    logger.info(f"–ù–æ–≤–æ—Å—Ç—å –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–∞ (ID={news_id}) –∞–¥–º–∏–Ω–æ–º {query.from_user.id}")

    tz_minsk = pytz.timezone('Europe/Minsk')
    current_time_minsk = datetime.now(tz_minsk).strftime('%d.%m.%Y %H:%M')

    success_msg = "‚úÖ <b>–ù–û–í–û–°–¢–¨ –û–ü–£–ë–õ–ò–ö–û–í–ê–ù–ê!</b>\n"
    success_msg += f"<b>{title}</b>\n{content[:200]}{'...' if len(content) > 200 else ''}"

    main_menu_keyboard = [
        [InlineKeyboardButton("‚è∞ –°–µ–π—á–∞—Å", callback_data='menu_now'),
         InlineKeyboardButton("üìö –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ", callback_data='menu_schedule')],
        [InlineKeyboardButton("üîÑ –ó–∞–º–µ–Ω—ã", callback_data='menu_substitutions'),
         InlineKeyboardButton("üì£ –ù–æ–≤–æ—Å—Ç–∏", callback_data='menu_news')],
        [InlineKeyboardButton("üåü –ú–û—ë", callback_data='menu_my'),
         InlineKeyboardButton("üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data='back_to_main')]
    ]
    main_menu_markup = InlineKeyboardMarkup(main_menu_keyboard)

    if send_to_all:
        users = await asyncio.to_thread(db.get_all_users)
        total = len(users)
        sent = 0
        failed = 0

        broadcast_msg = (
            f"üì£ <b>–°–†–û–ß–ù–ê–Ø –ù–û–í–û–°–¢–¨ –®–ö–û–õ–´</b>\n"
            f"<b>{title}</b>\n"
            f"{content}\n"
            f"<i>üìÖ {current_time_minsk}</i>"
        )

        status_msg = await query.edit_message_text(
            f"üì§ <b>–†–ê–°–°–´–õ–ö–ê –ù–û–í–û–°–¢–ò</b>\n"
            f"–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: {total}\n"
            f"–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: 0\n"
            f"–û—à–∏–±–æ–∫: 0\n"
            f"–°—Ç–∞—Ç—É—Å: ‚è≥ –ù–∞—á–∏–Ω–∞–µ–º...",
            parse_mode='HTML'
        )

        for i, (user_id, _, _, _) in enumerate(users):
            try:
                await context.bot.send_message(
                    chat_id=user_id, 
                    text=broadcast_msg, 
                    parse_mode='HTML',
                    reply_markup=main_menu_markup
                )
                sent += 1
            except (Forbidden, BadRequest) as e:
                failed += 1
                logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–æ–≤–æ—Å—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user_id}: {e}")
            except Exception as e:
                failed += 1
                logger.error(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–æ–≤–æ—Å—Ç–∏ {user_id}: {e}")

            if i % 5 == 0 or i == total - 1:
                try:
                    await status_msg.edit_text(
                        f"üì§ <b>–†–ê–°–°–´–õ–ö–ê –ù–û–í–û–°–¢–ò</b>\n"
                        f"–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: {total}\n"
                        f"–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: {sent}\n"
                        f"–û—à–∏–±–æ–∫: {failed}\n"
                        f"–°—Ç–∞—Ç—É—Å: {'‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–æ' if i == total-1 else '‚è≥ –í –ø—Ä–æ—Ü–µ—Å—Å–µ...'}",
                        parse_mode='HTML'
                    )
                except Exception as e:
                    logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å —Ä–∞—Å—Å—ã–ª–∫–∏: {e}")

        success_msg += f"\nüì§ –†–∞—Å—Å—ã–ª–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞:\n‚úÖ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: {sent}\n‚ùå –û—à–∏–±–æ–∫: {failed}"

    keyboard = [
        [InlineKeyboardButton("‚Ü©Ô∏è –í –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å", callback_data='admin_panel')],
        [InlineKeyboardButton("üè† –°—Ç–∞—Ä—Ç / –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data='back_to_main')]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)

    await safe_edit_message(query, success_msg, reply_markup=reply_markup)
    context.user_data.clear()

# ================== –§–£–ù–ö–¶–ò–ò –£–î–ê–õ–ï–ù–ò–Ø –ù–û–í–û–°–¢–ï–ô ==================
async def show_all_news_for_admin(query, context):
    if query.from_user.id not in ADMIN_IDS:
        return
    news_list = await asyncio.to_thread(db.get_all_news)

    if not news_list:
        text = "üì≠ <b>–ù–û–í–û–°–¢–ò –û–¢–°–£–¢–°–¢–í–£–Æ–¢</b>\n\n–í –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç –Ω–æ–≤–æ—Å—Ç–µ–π."
        keyboard = [[InlineKeyboardButton("‚Ü©Ô∏è –í –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å", callback_data='admin_panel')]]
    else:
        text = "üì∞ <b>–£–ü–†–ê–í–õ–ï–ù–ò–ï –ù–û–í–û–°–¢–Ø–ú–ò</b>\n\n"
        text += f"–í—Å–µ–≥–æ –Ω–æ–≤–æ—Å—Ç–µ–π: <b>{len(news_list)}</b>\n\n"
        for news in news_list[:15]:
            pub_date = convert_utc_to_minsk(news[3])
            text += f"ID: <code>{news[0]}</code>\nüìå <b>{news[1]}</b>\n<i>üìÖ {pub_date}</i>\n{news[2][:100]}{'...' if len(news[2]) > 100 else ''}\n\n"
            text += "‚îÄ" * 20 + "\n\n"
        if len(news_list) > 15:
            text += f"\n<i>–ü–æ–∫–∞–∑–∞–Ω—ã –ø–æ—Å–ª–µ–¥–Ω–∏–µ 15 –Ω–æ–≤–æ—Å—Ç–µ–π –∏–∑ {len(news_list)}.</i>"

        keyboard = []
        for news in news_list[:15]:
            keyboard.append([
                InlineKeyboardButton(f"‚úèÔ∏è –†–µ–¥. {news[0]}", callback_data=f'admin_edit_news_{news[0]}'),
                InlineKeyboardButton(f"üóë –£–¥–∞–ª–∏—Ç—å {news[0]}", callback_data=f'delete_news_{news[0]}')
            ])
        keyboard.append([InlineKeyboardButton("‚Ü©Ô∏è –í –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å", callback_data='admin_panel')])
    reply_markup = InlineKeyboardMarkup(keyboard)
    await safe_edit_message(query, text, reply_markup=reply_markup)

async def confirm_delete_news(query, context, news_id):
    if query.from_user.id not in ADMIN_IDS:
        return
    news = await asyncio.to_thread(db.get_news_by_id, news_id)
    if not news:
        await safe_edit_message(
            query,
            "‚ùå <b>–û—à–∏–±–∫–∞:</b> –ù–æ–≤–æ—Å—Ç—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.",
            reply_markup=InlineKeyboardMarkup([
                [InlineKeyboardButton("‚Ü©Ô∏è –í —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ—Å—Ç—è–º–∏", callback_data='admin_manage_news')],
                [InlineKeyboardButton("üè† –°—Ç–∞—Ä—Ç / –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data='back_to_main')]
            ])
        )
        return

    pub_date = convert_utc_to_minsk(news[3])
    title = news[1]
    keyboard = [
        [
            InlineKeyboardButton("‚úÖ –î–∞, —É–¥–∞–ª–∏—Ç—å", callback_data=f'confirm_delete_news_{news_id}'),
            InlineKeyboardButton("‚ùå –û—Ç–º–µ–Ω–∞", callback_data='admin_manage_news')
        ]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    await safe_edit_message(
        query,
        f"‚ö†Ô∏è <b>–ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ò–ï –£–î–ê–õ–ï–ù–ò–Ø</b>\n\n"
        f"–í—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –Ω–æ–≤–æ—Å—Ç—å?\n\n"
        f"üìå <b>{title}</b>\n"
        f"<i>üìÖ {pub_date}</i>\n\n"
        f"<i>–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ!</i>",
        reply_markup=reply_markup
    )

async def delete_news_handler(query, context, news_id):
    if query.from_user.id not in ADMIN_IDS:
        return
    news = await asyncio.to_thread(db.get_news_by_id, news_id)
    title = news[1] if news else f"ID {news_id}"

    await asyncio.to_thread(db.delete_news, news_id)
    logger.info(f"–ù–æ–≤–æ—Å—Ç—å ID={news_id} —É–¥–∞–ª–µ–Ω–∞ –∞–¥–º–∏–Ω–æ–º {query.from_user.id}")

    await query.answer(f"‚úÖ –ù–æ–≤–æ—Å—Ç—å '{title}' —É–¥–∞–ª–µ–Ω–∞!", show_alert=True)
    await show_all_news_for_admin(query, context)

# ================== –§–£–ù–ö–¶–ò–Ø –§–û–ù–û–í–û–ì–û –õ–û–ì–ò–†–û–í–ê–ù–ò–Ø ==================
async def ensure_user_and_log(user_id, username, first_name, last_name, language_code, action):
    try:
        await asyncio.to_thread(db.update_user_and_log, user_id, action, None, username, first_name, last_name, language_code)
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ —Ñ–æ–Ω–æ–≤–æ–≥–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è: {e}")

# ================== –§–£–ù–ö–¶–ò–Ø –ü–†–û–í–ï–†–ö–ò –¢–ï–•–†–ï–ñ–ò–ú–ê ==================
async def check_maintenance_mode(update: Update, context: CallbackContext) -> bool:
    global _maintenance_cache
    now = datetime.now()
    if (now - _maintenance_cache['last_check']).total_seconds() < MAINTENANCE_CACHE_TTL:
        maintenance = _maintenance_cache
    else:
        maintenance = await asyncio.to_thread(db.get_maintenance_status)
        maintenance['last_check'] = now
        _maintenance_cache = maintenance

    user_id = update.effective_user.id
    if user_id in ADMIN_IDS:
        return False
    if not maintenance['enabled']:
        return False

    msg = "<b>‚ö†Ô∏è –¢–ï–•–ù–ò–ß–ï–°–ö–ò–ï –†–ê–ë–û–¢–´</b>\n\n"
    msg += "–ë–æ—Ç –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.\n"
    if maintenance['until']:
        msg += f"üïó –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–æ—á–Ω–æ: <b>{maintenance['until']}</b>\n"
    if maintenance['message']:
        msg += f"\nüí¨ <i>{maintenance['message']}</i>\n"
    msg += "\n–ü—Ä–∏–Ω–æ—Å–∏–º –∏–∑–≤–∏–Ω–µ–Ω–∏—è –∑–∞ –Ω–µ—É–¥–æ–±—Å—Ç–≤–∞."

    try:
        if update.callback_query:
            await update.callback_query.answer("‚ö†Ô∏è –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ä–∞–±–æ—Ç—ã", show_alert=True)
            await safe_edit_message(
                update.callback_query,
                msg,
                reply_markup=InlineKeyboardMarkup([[
                    InlineKeyboardButton("üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å", callback_data='check_maintenance_status')
                ]])
            )
        else:
            await update.message.reply_text(
                msg,
                parse_mode='HTML',
                reply_markup=InlineKeyboardMarkup([[
                    InlineKeyboardButton("üîÑ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å", callback_data='check_maintenance_status')
                ]])
            )
    except Exception as e:
        logger.warning(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ —Ç–µ—Ö—Ä–µ–∂–∏–º–µ: {e}")
        if update.callback_query:
            await update.callback_query.message.reply_text(msg, parse_mode='HTML')
        else:
            await update.message.reply_text(msg, parse_mode='HTML')

    return True

async def check_maintenance_status(query, context):
    maintenance = await asyncio.to_thread(db.get_maintenance_status)
    if not maintenance['enabled']:
        msg = "üü¢ –ë–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç —à—Ç–∞—Ç–Ω–æ\n\n–í—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–æ—Å—Ç—É–ø–Ω—ã."
        keyboard = [[InlineKeyboardButton("üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data='back_to_main')]]
    else:
        msg = "‚ö†Ô∏è –¢–ï–•–ù–ò–ß–ï–°–ö–ò–ï –†–ê–ë–û–¢–´\n\n–ë–æ—Ç –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω."
        if maintenance['until']:
            msg += f"\nüïó –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ: {maintenance['until']}"
        keyboard = [[InlineKeyboardButton("üîÑ –û–±–Ω–æ–≤–∏—Ç—å", callback_data='check_maintenance_status')]]
    reply_markup = InlineKeyboardMarkup(keyboard)
    try:
        await safe_edit_message(query, msg, reply_markup=reply_markup)
    except:
        await query.answer("–°—Ç–∞—Ç—É—Å –Ω–µ –∏–∑–º–µ–Ω–∏–ª—Å—è", show_alert=False)

# ================== –£–ü–†–û–©–Å–ù–ù–´–ô –¢–ï–•–†–ï–ñ–ò–ú ==================
async def enable_maintenance_mode(query, context):
    if query.from_user.id not in ADMIN_IDS:
        return
    keyboard = [
        [InlineKeyboardButton("üïê –ù–∞ 1 —á–∞—Å", callback_data='maintenance_1h')],
        [InlineKeyboardButton("üïê –ù–∞ 3 —á–∞—Å–∞", callback_data='maintenance_3h')],
        [InlineKeyboardButton("üïê –ù–∞ 5 —á–∞—Å–æ–≤", callback_data='maintenance_5h')],
        [InlineKeyboardButton("üåô –î–æ –∑–∞–≤—Ç—Ä–∞ (08:00)", callback_data='maintenance_tomorrow')],
        [InlineKeyboardButton("‚ôæÔ∏è –ë–µ—Å—Å—Ä–æ—á–Ω–æ", callback_data='maintenance_forever')],
        [InlineKeyboardButton("‚ùå –û—Ç–º–µ–Ω–∞", callback_data='admin_panel')],
        [InlineKeyboardButton("üè† –°—Ç–∞—Ä—Ç / –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data='back_to_main')]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    await safe_edit_message(
        query,
        "<b>üîß –í–ö–õ–Æ–ß–ï–ù–ò–ï –¢–ï–•–†–ï–ñ–ò–ú–ê</b>\n\n"
        "–í—ã–±–µ—Ä–∏—Ç–µ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö —Ä–∞–±–æ—Ç:\n"
        "‚Ä¢ <b>1 —á–∞—Å</b> ‚Äî –¥–æ –æ–∫–æ–Ω—á–∞–Ω–∏—è —Ç–µ–∫—É—â–µ–≥–æ —á–∞—Å–∞\n"
        "‚Ä¢ <b>3 —á–∞—Å–∞</b> ‚Äî —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Ä–∞–±–æ—Ç\n"
        "‚Ä¢ <b>5 —á–∞—Å–æ–≤</b> ‚Äî –ø–æ–ª–Ω—ã–π —Ä–∞–±–æ—á–∏–π –¥–µ–Ω—å\n"
        "‚Ä¢ <b>–î–æ –∑–∞–≤—Ç—Ä–∞</b> ‚Äî –¥–æ 08:00 —Å–ª–µ–¥—É—é—â–µ–≥–æ –¥–Ω—è\n"
        "‚Ä¢ <b>–ë–µ—Å—Å—Ä–æ—á–Ω–æ</b> ‚Äî –¥–æ —Ä—É—á–Ω–æ–≥–æ –æ—Ç–∫–ª—é—á–µ–Ω–∏—è",
        reply_markup=reply_markup
    )

async def set_maintenance_duration(query, context, duration_type):
    tz_minsk = pytz.timezone('Europe/Minsk')
    now = datetime.now(tz_minsk)
    until_str = None
    if duration_type == '1h':
        until_str = (now + timedelta(hours=1)).strftime('%d.%m %H:%M')
    elif duration_type == '3h':
        until_str = (now + timedelta(hours=3)).strftime('%d.%m %H:%M')
    elif duration_type == '5h':
        until_str = (now + timedelta(hours=5)).strftime('%d.%m %H:%M')
    elif duration_type == 'tomorrow':
        tomorrow = now + timedelta(days=1)
        until_str = tomorrow.replace(hour=8, minute=0).strftime('%d.%m %H:%M')
    await asyncio.to_thread(db.set_maintenance_mode, True, until_str, None)
    await asyncio.to_thread(db.log_user_activity, query.from_user.id, f'maintenance_enabled_{duration_type}')
    await confirm_maintenance_activated(query, until_str)

async def confirm_maintenance_activated(query, until_str=None):
    msg = "‚úÖ –¢–ï–•–†–ï–ñ–ò–ú –í–ö–õ–Æ–ß–ï–ù\n\n"
    msg += "‚ö†Ô∏è –ë–æ—Ç —Ç–µ–ø–µ—Ä—å –¥–æ—Å—Ç—É–ø–µ–Ω –¢–û–õ–¨–ö–û –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º.\n"
    if until_str:
        msg += f"üïó –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ: {until_str}\n"
    else:
        msg += "‚ôæÔ∏è –†–µ–∂–∏–º: –±–µ—Å—Å—Ä–æ—á–Ω—ã–π (–¥–æ —Ä—É—á–Ω–æ–≥–æ –æ—Ç–∫–ª—é—á–µ–Ω–∏—è)\n"
    keyboard = [
        [InlineKeyboardButton("‚Ü©Ô∏è –í –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å", callback_data='admin_panel')],
        [InlineKeyboardButton("üè† –°—Ç–∞—Ä—Ç / –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data='back_to_main')]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    await safe_edit_message(query, msg, reply_markup=reply_markup)

async def disable_maintenance_mode(query, context):
    if query.from_user.id not in ADMIN_IDS:
        return
    await asyncio.to_thread(db.set_maintenance_mode, False)
    await asyncio.to_thread(db.log_user_activity, query.from_user.id, 'maintenance_disabled')
    keyboard = [
        [InlineKeyboardButton("‚Ü©Ô∏è –í –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å", callback_data='admin_panel')],
        [InlineKeyboardButton("üè† –°—Ç–∞—Ä—Ç / –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data='back_to_main')]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    await safe_edit_message(
        query,
        "‚úÖ <b>–¢–ï–•–†–ï–ñ–ò–ú –û–¢–ö–õ–Æ–ß–ï–ù</b>\n\n"
        "–ë–æ—Ç —Å–Ω–æ–≤–∞ –¥–æ—Å—Ç—É–ø–µ–Ω –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º.",
        reply_markup=reply_markup
    )

# ================== –£–ü–†–û–©–Å–ù–ù–û–ï –î–û–ë–ê–í–õ–ï–ù–ò–ï –ó–ê–ú–ï–ù ==================
async def show_date_selection(query, context):
    tz_minsk = pytz.timezone('Europe/Minsk')
    today = datetime.now(tz_minsk).date()
    keyboard = []
    current_date = today
    days_shown = 0
    max_calendar_days = 7
    while days_shown < max_calendar_days:
        weekday = current_date.weekday()
        if weekday < 5:
            day_name = DAYS_OF_WEEK[weekday]
            date_str = current_date.strftime('%Y-%m-%d')
            button_text = f"{day_name} ({current_date.strftime('%d.%m')})"
            keyboard.append([InlineKeyboardButton(button_text, callback_data=f'date_{date_str}')])
        current_date += timedelta(days=1)
        days_shown += 1

    if not keyboard:
        keyboard.append([InlineKeyboardButton("‚ùå –ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –¥–∞—Ç", callback_data='admin_panel')])

    keyboard.append([InlineKeyboardButton("‚ùå –û—Ç–º–µ–Ω–∞", callback_data='cancel_adding')])
    keyboard.append([InlineKeyboardButton("üè† –°—Ç–∞—Ä—Ç / –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data='back_to_main')])
    reply_markup = InlineKeyboardMarkup(keyboard)

    context.user_data['adding_substitution'] = True
    context.user_data['step'] = 'date'
    await safe_edit_message(
        query,
        "<b>‚ûï –î–û–ë–ê–í–õ–ï–ù–ò–ï –ó–ê–ú–ï–ù–´ (–®–ê–ì 1/4)</b>\n"
        "<b>üìÖ –í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –∑–∞–º–µ–Ω—ã:</b>\n"
        "<i>–ü–æ–∫–∞–∑–∞–Ω—ã —Ç–æ–ª—å–∫–æ –±—É–¥–Ω–∏–µ –¥–Ω–∏ (–ü–Ω-–ü—Ç) –Ω–∞ –±–ª–∏–∂–∞–π—à—É—é –Ω–µ–¥–µ–ª—é</i>",
        reply_markup=reply_markup
    )

async def show_class_selection_for_substitution(query, context):
    keyboard = []
    row = []
    for i, class_name in enumerate(ALL_CLASSES):
        button_text = class_name.upper()
        callback_data = f'sub_class_{class_name}'
        row.append(InlineKeyboardButton(button_text, callback_data=callback_data))
        if len(row) == 3:
            keyboard.append(row)
            row = []
    if row:
        keyboard.append(row)
    keyboard.append([
        InlineKeyboardButton("‚óÄÔ∏è –ù–∞–∑–∞–¥ –∫ –¥–∞—Ç–µ", callback_data='back_to_date'),
        InlineKeyboardButton("‚ùå –û—Ç–º–µ–Ω–∞", callback_data='cancel_adding')
    ])
    keyboard.append([InlineKeyboardButton("üè† –°—Ç–∞—Ä—Ç / –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data='back_to_main')])
    reply_markup = InlineKeyboardMarkup(keyboard)
    await safe_edit_message(
        query,
        "‚ûï –î–û–ë–ê–í–õ–ï–ù–ò–ï –ó–ê–ú–ï–ù–´ (–®–ê–ì 2/4)\n"
        f"üìÖ –î–∞—Ç–∞: {context.user_data.get('date', '–Ω–µ –≤—ã–±—Ä–∞–Ω')}\n"
        f"üìÖ –î–µ–Ω—å –Ω–µ–¥–µ–ª–∏: {context.user_data.get('day', '–Ω–µ –≤—ã–±—Ä–∞–Ω')}\n"
        "üè´ –í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∞—Å—Å:",
        reply_markup=reply_markup
    )

async def show_lesson_selection(query, context):
    class_name = context.user_data.get('class_name', '')
    day = context.user_data.get('day', '')
    lessons = []
    if class_name in SCHEDULE_STRUCTURED and day in SCHEDULE_STRUCTURED[class_name]:
        lessons = SCHEDULE_STRUCTURED[class_name][day]
        lessons.sort(key=lambda x: x[0])
    keyboard = []
    for lesson_num, subject, teacher in lessons: 
        lesson_time = get_lesson_time(lesson_num)
        teacher_main = teacher.split('/')[0].split('(')[0].strip()
        button_text = f"{lesson_num} —É—Ä–æ–∫: {lesson_time} {subject} - {teacher_main}"
        if len(button_text) > 60:
            button_text = button_text[:57] + "..."
        callback_data = f'lesson_{lesson_num}'
        keyboard.append([InlineKeyboardButton(button_text, callback_data=callback_data)])

    if not lessons:
        keyboard.append([InlineKeyboardButton("‚ùå –í —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–∏ –Ω–µ—Ç —É—Ä–æ–∫–æ–≤", callback_data='back_to_class')])

    keyboard.append([
        InlineKeyboardButton("‚óÄÔ∏è –ù–∞–∑–∞–¥ –∫ –∫–ª–∞—Å—Å—É", callback_data='back_to_class'),
        InlineKeyboardButton("‚ùå –û—Ç–º–µ–Ω–∞", callback_data='cancel_adding')
    ])
    keyboard.append([InlineKeyboardButton("üè† –°—Ç–∞—Ä—Ç / –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data='back_to_main')])
    reply_markup = InlineKeyboardMarkup(keyboard)
    text = (
        f"<b>‚ûï –î–û–ë–ê–í–õ–ï–ù–ò–ï –ó–ê–ú–ï–ù–´ (–®–ê–ì 3/4)</b>\n"
        f"<b>üìÖ –î–∞—Ç–∞:</b> {context.user_data.get('date', '‚Äî')}\n"
        f"<b>üìÖ –î–µ–Ω—å:</b> {day}\n"
        f"<b>üè´ –ö–ª–∞—Å—Å:</b> {class_name.upper()}\n\n"
        f"<b>üî¢ –í—ã–±–µ—Ä–∏—Ç–µ —É—Ä–æ–∫ –¥–ª—è –∑–∞–º–µ–Ω—ã:</b>\n"
        f"<i>–ü–æ–∫–∞–∑–∞–Ω—ã —É—Ä–æ–∫–∏ –∏–∑ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è –∫–ª–∞—Å—Å–∞</i>"
    )
    await safe_edit_message(query, text, reply_markup=reply_markup)

async def show_teacher_selection(query, context):
    teachers = list(TEACHER_IDS.keys())
    keyboard = []
    row = []
    current_teacher = context.user_data.get('old_teacher', '').split()[0] if context.user_data.get('old_teacher') else ''
    for i, teacher in enumerate(teachers):
        if current_teacher and current_teacher.lower() in teacher.lower():
            continue
        button_text = teacher[:20] + "..." if len(teacher) > 20 else teacher
        callback_data = f'teacher_{teacher.replace(" ", "_")}'
        row.append(InlineKeyboardButton(button_text, callback_data=callback_data))
        if len(row) == 2:
            keyboard.append(row)
            row = []
        if i >= 30:
            break
    if row:
        keyboard.append(row)

    keyboard.append([
        InlineKeyboardButton("‚óÄÔ∏è –ù–∞–∑–∞–¥ –∫ —É—Ä–æ–∫—É", callback_data='back_to_lesson'),
        InlineKeyboardButton("‚ùå –û—Ç–º–µ–Ω–∞", callback_data='cancel_adding')
    ])
    keyboard.append([InlineKeyboardButton("üè† –°—Ç–∞—Ä—Ç / –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data='back_to_main')])
    reply_markup = InlineKeyboardMarkup(keyboard)
    text = (
        f"<b>‚ûï –î–û–ë–ê–í–õ–ï–ù–ò–ï –ó–ê–ú–ï–ù–´ (–®–ê–ì 4/4)</b>\n"
        f"<b>üìÖ –î–∞—Ç–∞:</b> {context.user_data.get('date', '‚Äî')}\n"
        f"<b>üìÖ –î–µ–Ω—å:</b> {context.user_data.get('day', '‚Äî')}\n"
        f"<b>üè´ –ö–ª–∞—Å—Å:</b> {context.user_data.get('class_name', '‚Äî').upper()}\n"
        f"<b>üî¢ –£—Ä–æ–∫:</b> {context.user_data.get('lesson', '‚Äî')}\n"
        f"<b>üìö –ü—Ä–µ–¥–º–µ—Ç:</b> {context.user_data.get('subject', '‚Äî')}\n"
        f"<b>üë®‚Äçüè´ –¢–µ–∫—É—â–∏–π —É—á–∏—Ç–µ–ª—å:</b> {context.user_data.get('old_teacher', '‚Äî')}\n\n"
        f"<b>üë®‚Äçüè´ –í—ã–±–µ—Ä–∏—Ç–µ –ù–û–í–û–ì–û —É—á–∏—Ç–µ–ª—è:</b>\n"
        f"<i>–ü—Ä–µ–¥–º–µ—Ç –æ—Å—Ç–∞–Ω–µ—Ç—Å—è —Ç–µ–º –∂–µ</i>"
    )
    await safe_edit_message(query, text, reply_markup=reply_markup)

async def handle_adding_substitution(query, context):
    step = context.user_data.get('step', 'date')
    if query.data == 'cancel_adding':
        context.user_data.clear()
        await show_main_menu(query)
        return
    if query.data == 'back_to_date':
        context.user_data['step'] = 'date'
        await show_date_selection(query, context)
        return
    elif query.data == 'back_to_class':
        context.user_data['step'] = 'class'
        await show_class_selection_for_substitution(query, context)
        return
    elif query.data == 'back_to_lesson':
        context.user_data['step'] = 'lesson'
        await show_lesson_selection(query, context)
        return

    if step == 'date' and query.data.startswith('date_'):
        date_str = query.data.split('_', 1)[1]
        context.user_data['date'] = date_str
        try:
            date_obj = datetime.strptime(date_str, '%Y-%m-%d')
            weekday = date_obj.weekday()
            if weekday < 5:
                day_name = DAYS_OF_WEEK[weekday]
            elif weekday == 5:
                day_name = "–°—É–±–±–æ—Ç–∞"
            else:
                await query.answer("‚ö†Ô∏è –í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ ‚Äî –≤—ã—Ö–æ–¥–Ω–æ–π –¥–µ–Ω—å", show_alert=True)
                return
            context.user_data['day'] = day_name
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –¥–Ω—è –Ω–µ–¥–µ–ª–∏: {e}")
            context.user_data['day'] = "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"
        context.user_data['step'] = 'class'
        await show_class_selection_for_substitution(query, context)
        return

    if step == 'class' and query.data.startswith('sub_class_'):
        class_name = query.data.split('_', 2)[2]
        context.user_data['class_name'] = class_name
        context.user_data['step'] = 'lesson'
        await show_lesson_selection(query, context)
        return

    if step == 'lesson' and query.data.startswith('lesson_'):
        lesson_num = int(query.data.split('_')[1])
        context.user_data['lesson'] = lesson_num
        class_name = context.user_data['class_name']
        day_name = context.user_data['day']
        if class_name in SCHEDULE_STRUCTURED and day_name in SCHEDULE_STRUCTURED[class_name]:
            lessons = SCHEDULE_STRUCTURED[class_name][day_name]
            for lesson in lessons:
                if lesson[0] == lesson_num:
                    context.user_data['subject'] = lesson[1]
                    teachers = lesson[2].split('/')
                    context.user_data['old_teacher'] = teachers[0].split('(')[0].strip()
                    break
        context.user_data['step'] = 'new_teacher'
        await show_teacher_selection(query, context)
        return

    if step == 'new_teacher' and query.data.startswith('teacher_'):
        new_teacher = query.data[8:].replace('_', ' ').strip()
        context.user_data['new_teacher'] = new_teacher
        await save_substitution(query, context)
        return

    await query.answer("‚ö†Ô∏è –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ", show_alert=True)

async def save_substitution(query, context):
    try:
        date = context.user_data['date']
        day = context.user_data['day']
        class_name = context.user_data['class_name']
        lesson_num = context.user_data['lesson']
        subject = context.user_data['subject']
        old_teacher = context.user_data['old_teacher']
        new_teacher = context.user_data['new_teacher']
        await asyncio.to_thread(
            db.add_substitution,
            date, day, lesson_num,
            subject, subject,
            old_teacher, new_teacher,
            class_name
        )
        substitution_data = {
            'date': date,
            'day': day,
            'class_name': class_name,
            'lesson': lesson_num,
            'old_subject': subject,
            'new_subject': subject,
            'old_teacher': old_teacher,
            'new_teacher': new_teacher
        }
        await send_substitution_notification(context, new_teacher, substitution_data)

        context.user_data.clear()
        keyboard = [
            [InlineKeyboardButton("‚ûï –î–æ–±–∞–≤–∏—Ç—å –µ—â—ë –∑–∞–º–µ–Ω—É", callback_data='admin_add_sub')],
            [InlineKeyboardButton("üè† –°—Ç–∞—Ä—Ç / –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data='back_to_main')]
        ]
        reply_markup = InlineKeyboardMarkup(keyboard)

        success_msg = (
            f"‚úÖ <b>–ó–∞–º–µ–Ω–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞!</b>\n\n"
            f"üìÖ <b>–î–∞—Ç–∞:</b> {date} ({day})\n"
            f"üè´ <b>–ö–ª–∞—Å—Å:</b> {class_name.upper()}\n"
            f"üî¢ <b>–£—Ä–æ–∫:</b> {lesson_num}\n"
            f"üìö <b>–ü—Ä–µ–¥–º–µ—Ç:</b> {subject}\n"
            f"üë®‚Äçüè´ <b>–ó–∞–º–µ–Ω–∞:</b> {old_teacher} ‚Üí <code>{new_teacher}</code>\n\n"
            f"<i>–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–æ–≤–æ–º—É —É—á–∏—Ç–µ–ª—é</i>"
        )
        await safe_edit_message(query, success_msg, reply_markup=reply_markup)

    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∑–∞–º–µ–Ω—ã: {e}")
        context.user_data.clear()
        await safe_edit_message(
            query,
            f"‚ùå <b>–û—à–∏–±–∫–∞:</b> {str(e)[:200]}",
            reply_markup=InlineKeyboardMarkup([[InlineKeyboardButton("üè† –°—Ç–∞—Ä—Ç", callback_data='back_to_main')]])
        )

# ================== –ê–ù–ê–õ–ò–¢–ò–ö–ê –î–õ–Ø –ê–î–ú–ò–ù–ê ==================
async def show_analytics(query, context):
    if query.from_user.id not in ADMIN_IDS:
        return
    active_users_24h = await asyncio.to_thread(db.get_active_users_24h)
    popular_classes = await asyncio.to_thread(db.get_popular_classes)
    peak_hours = await asyncio.to_thread(db.get_peak_hours)
    total_users = await asyncio.to_thread(db.get_user_count)
    subs = await asyncio.to_thread(db.get_all_substitutions)
    subs_count = len(subs) if subs else 0

    text = "<b>üìä –ê–ù–ê–õ–ò–¢–ò–ö–ê –ë–û–¢–ê</b>\n\n"
    text += f"üë• <b>–ê–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞ —Å—É—Ç–∫–∏:</b> {active_users_24h}\n"
    text += f"üë• <b>–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:</b> {total_users}\n\n"

    if popular_classes:
        popular_text = ", ".join(popular_classes[:3])
        text += f"üèÜ <b>–ü–æ–ø—É–ª—è—Ä–Ω—ã–µ –∫–ª–∞—Å—Å—ã:</b> {popular_text}\n\n"
    else:
        text += "<b>üèÜ –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ –∫–ª–∞—Å—Å—ã:</b> –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ –ø–æ—Å–ª–µ–¥–Ω—é—é –Ω–µ–¥–µ–ª—é\n\n"

    text += f"‚è∞ <b>–ü–∏–∫–æ–≤—ã–µ —á–∞—Å—ã:</b> {peak_hours}\n\n"
    text += f"üîÑ <b>–í—Å–µ–≥–æ –∑–∞–º–µ–Ω:</b> {subs_count}\n"

    keyboard = [
        [InlineKeyboardButton("üîÑ –û–±–Ω–æ–≤–∏—Ç—å –∞–Ω–∞–ª–∏—Ç–∏–∫—É", callback_data='admin_analytics')],
        [InlineKeyboardButton("üë• –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π", callback_data='admin_users')],
        [InlineKeyboardButton("‚Ü©Ô∏è –í –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å", callback_data='admin_panel')],
        [InlineKeyboardButton("üè† –°—Ç–∞—Ä—Ç / –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data='back_to_main')]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    await safe_edit_message(query, text, reply_markup=reply_markup)

# ================== –§–£–ù–ö–¶–ò–Ø –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø –û –ù–û–í–´–• –ù–û–í–û–°–¢–Ø–• ==================
async def check_new_news_notification(update: Update, context: CallbackContext) -> bool:
    user = update.effective_user
    if not user:
        return False

    if context.user_data.get('news_notification_shown'):
        return False

    new_count = await asyncio.to_thread(db.count_new_news_since, user.id)
    if new_count == 0:
        return False

    text = f"üì¢ <b>–ó–∞ –≤—Ä–µ–º—è –≤–∞—à–µ–≥–æ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–æ {new_count} –Ω–æ–≤—ã—Ö –Ω–æ–≤–æ—Å—Ç–µ–π!</b>"
    keyboard = [
        [InlineKeyboardButton("üì∞ –ù–æ–≤–æ—Å—Ç–∏", callback_data='menu_news')],
        [InlineKeyboardButton("üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data='back_to_main')]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)

    try:
        if update.callback_query:
            await update.callback_query.message.reply_text(text, reply_markup=reply_markup, parse_mode='HTML')
        elif update.message:
            await update.message.reply_text(text, reply_markup=reply_markup, parse_mode='HTML')
        else:
            return False
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –Ω–æ–≤–æ—Å—Ç—è—Ö: {e}")
        return False

    context.user_data['news_notification_shown'] = True
    return True
    # ================== –ö–û–ú–ê–ù–î–ê /start ==================
async def start(update: Update, context: CallbackContext):
    user = update.effective_user
    await asyncio.to_thread(
        db.update_user_and_log,
        user.id,
        'start',
        None,
        user.username,
        user.first_name,
        user.last_name,
        user.language_code
    )

    if await check_maintenance_mode(update, context):
        return

    if await check_new_news_notification(update, context):
        return

    keyboard = [
        [
            InlineKeyboardButton("‚è∞ –°–µ–π—á–∞—Å", callback_data='menu_now'),
            InlineKeyboardButton("üìö –ö–ª–∞—Å—Å—ã", callback_data='menu_schedule')
        ],
        [
            InlineKeyboardButton("üë®‚Äçüè´ –£—á–∏—Ç–µ–ª—è", callback_data='menu_teacher'),
            InlineKeyboardButton("üîç –ü–æ–∏—Å–∫", callback_data='menu_search_teacher')
        ],
        [
            InlineKeyboardButton("üïê –ó–≤–æ–Ω–∫–∏", callback_data='menu_bells'),
            InlineKeyboardButton("üîÑ –ó–∞–º–µ–Ω—ã", callback_data='menu_substitutions')
        ],
        [
            InlineKeyboardButton("üì£ –ù–æ–≤–æ—Å—Ç–∏", callback_data='menu_news'),
            InlineKeyboardButton("üåü –ú–æ—ë", callback_data='menu_my')
        ],
        [
            InlineKeyboardButton("üëë –ê–¥–º–∏–Ω–∫–∞", callback_data='admin_panel'),
            InlineKeyboardButton("üÜò –ü–æ–º–æ—â—å", callback_data='menu_help')
        ],
        [
            InlineKeyboardButton("ü§ñ –ò–ò-–ø–æ–º–æ—â–Ω–∏–∫(—Ç–µ—Å—Ç)", callback_data='menu_ai')
        ]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)

    try:
        await update.message.reply_text(
            'üè´ <b>–®–∫–æ–ª—å–Ω—ã–π –±–æ—Ç</b>\n–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª:',
            reply_markup=reply_markup,
            parse_mode='HTML'
        )
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –≤ –∫–æ–º–∞–Ω–¥–µ start: {e}")
        await update.message.reply_text("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.")

# ================== –§–£–ù–ö–¶–ò–ò –î–õ–Ø "–°–ï–ô–ß–ê–°" ==================
async def show_now_class_selection(query, context):
    keyboard = [
        [InlineKeyboardButton("5–ê", callback_data='now_class_5–∞'), InlineKeyboardButton("5–ë", callback_data='now_class_5–±'), InlineKeyboardButton("5–í", callback_data='now_class_5–≤')],
        [InlineKeyboardButton("6–ê", callback_data='now_class_6–∞'), InlineKeyboardButton("6–ë", callback_data='now_class_6–±'), InlineKeyboardButton("6–í", callback_data='now_class_6–≤')],
        [InlineKeyboardButton("7–ê", callback_data='now_class_7–∞'), InlineKeyboardButton("7–ë", callback_data='now_class_7–±'), InlineKeyboardButton("7–í", callback_data='now_class_7–≤')],
        [InlineKeyboardButton("8–ê", callback_data='now_class_8–∞'), InlineKeyboardButton("8–ë", callback_data='now_class_8–±')],
        [InlineKeyboardButton("9–ê", callback_data='now_class_9–∞'), InlineKeyboardButton("9–ë", callback_data='now_class_9–±')],
        [InlineKeyboardButton("10–ê", callback_data='now_class_10–∞'), InlineKeyboardButton("10–ë", callback_data='now_class_10–±')],
        [InlineKeyboardButton("11", callback_data='now_class_11')],
        [InlineKeyboardButton("‚Ü©Ô∏è –ù–∞–∑–∞–¥", callback_data='back_to_main')]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    await safe_edit_message(
        query,
        "‚è∞ <b>–¢–ï–ö–£–©–ò–ô –£–†–û–ö</b>\n–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—à –∫–ª–∞—Å—Å:",
        reply_markup=reply_markup
    )

async def show_current_lesson(query, context):
    if query.data.startswith('now_class_'):
        class_name = query.data.replace('now_class_', '')
        context.user_data['current_class'] = class_name
    else:
        class_name = context.user_data.get('current_class', '8–∞')

    tz_minsk = pytz.timezone('Europe/Minsk')
    now = datetime.now(tz_minsk)
    weekday = now.weekday()

    if weekday >= 5:
        day_name = "–°—É–±–±–æ—Ç–∞" if weekday == 5 else "–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ"
        keyboard = [
            [InlineKeyboardButton("üîÑ –û–±–Ω–æ–≤–∏—Ç—å", callback_data=f'now_class_{class_name}')],
            [InlineKeyboardButton("‚Ü©Ô∏è –ù–∞–∑–∞–¥ –∫ –≤—ã–±–æ—Ä—É –∫–ª–∞—Å—Å–∞", callback_data='menu_now')],
            [InlineKeyboardButton("üè† –°—Ç–∞—Ä—Ç / –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data='back_to_main')]
        ]
        reply_markup = InlineKeyboardMarkup(keyboard)
        message_text = (
            f"üìÖ <b>{day_name}</b>\n"
            f"üïó –°–µ–≥–æ–¥–Ω—è –Ω–µ—Ç —É—Ä–æ–∫–æ–≤.\n"
            f"–°–ª–µ–¥—É—é—â–∏–µ —É—Ä–æ–∫–∏ –±—É–¥—É—Ç –≤ –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫.\n"
            f"<i>–û–±–Ω–æ–≤–ª–µ–Ω–æ: {now.strftime('%H:%M:%S')}</i>"
        )
        try:
            await safe_edit_message(query, message_text, reply_markup=reply_markup)
        except BadRequest as e:
            if "message is not modified" in str(e).lower():
                await query.answer("‚ÑπÔ∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è —É–∂–µ –∞–∫—Ç—É–∞–ª—å–Ω–∞", show_alert=False)
            else:
                raise
        return

    day_name = DAYS_OF_WEEK[weekday]
    current_info = get_current_lesson_info()

    if current_info['status'] == 'finished': 
        text = f"‚úÖ <b>–£—Ä–æ–∫–∏ –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å!</b>\n"
        text += f"üìÖ –°–µ–≥–æ–¥–Ω—è: <b>{day_name}</b>\n"
        text += f"üïó –í—Å–µ —É—Ä–æ–∫–∏ –∑–∞–≤–µ—Ä—à–µ–Ω—ã –Ω–∞ —Å–µ–≥–æ–¥–Ω—è.\n"
        text += f"<i>–û–±–Ω–æ–≤–ª–µ–Ω–æ: {now.strftime('%H:%M:%S')}</i>"
    elif current_info['status'] == 'break':
        minutes = current_info['minutes_until']
        next_num = current_info['next_number']
        text = f"‚è∏Ô∏è <b>–°–ï–ô–ß–ê–° –ü–ï–†–ï–ú–ï–ù–ê</b>\n"
        text += f"üìÖ –°–µ–≥–æ–¥–Ω—è: <b>{day_name}</b>\n"
        text += f"‚è∞ –°–ª–µ–¥—É—é—â–∏–π —É—Ä–æ–∫ (<b>{next_num}</b>) –Ω–∞—á–Ω—ë—Ç—Å—è —á–µ—Ä–µ–∑ <b>{minutes} –º–∏–Ω</b>\n"
        text += f"üïê –í—Ä–µ–º—è —É—Ä–æ–∫–∞: {current_info['start_time']}‚Äì{current_info['end_time']}\n"

        if class_name in SCHEDULE_STRUCTURED and day_name in SCHEDULE_STRUCTURED[class_name]:
            lessons = SCHEDULE_STRUCTURED[class_name][day_name]
            next_lesson = next((l for l in lessons if l[0] == next_num), None)
            if next_lesson:
                subject, teacher = next_lesson[1], next_lesson[2]
                text += f"üìö <b>–ü—Ä–µ–¥–º–µ—Ç:</b> {subject}\n"
                text += f"üë®‚Äçüè´ <b>–£—á–∏—Ç–µ–ª—å:</b> {teacher}\n"
                today_str = now.strftime('%Y-%m-%d')
                subs = await asyncio.to_thread(db.get_substitutions_for_class_date, class_name, today_str)
                substitution = next((s for s in subs if s[3] == next_num), None)
                if substitution:
                    text += f"‚ö†Ô∏è <b>–ó–ê–ú–ï–ù–ê:</b> {substitution[5]} ({substitution[7]})\n"
        text += f"<i>–û–±–Ω–æ–≤–ª–µ–Ω–æ: {now.strftime('%H:%M:%S')}</i>"
    else:
        lesson_num = current_info['number']
        time_left = current_info['time_left']
        text = f"üîî <b>–°–ï–ô–ß–ê–° –ò–î–Å–¢ –£–†–û–ö ‚Ññ{lesson_num}</b>\n"
        text += f"üìÖ –°–µ–≥–æ–¥–Ω—è: <b>{day_name}</b>\n"
        text += f"‚è∞ –£—Ä–æ–∫ –∑–∞–∫–æ–Ω—á–∏—Ç—Å—è —á–µ—Ä–µ–∑ <b>{time_left} –º–∏–Ω</b>\n"
        text += f"üïê –í—Ä–µ–º—è —É—Ä–æ–∫–∞: {current_info['start_time']}‚Äì{current_info['end_time']}\n"

        if class_name in SCHEDULE_STRUCTURED and day_name in SCHEDULE_STRUCTURED[class_name]:
            lessons = SCHEDULE_STRUCTURED[class_name][day_name]
            current_lesson = next((l for l in lessons if l[0] == lesson_num), None)
            if current_lesson:
                subject, teacher = current_lesson[1], current_lesson[2]
                text += f"üìö <b>–ü—Ä–µ–¥–º–µ—Ç:</b> {subject}\n"
                text += f"üë®‚Äçüè´ <b>–£—á–∏—Ç–µ–ª—å:</b> {teacher}\n"
                today_str = now.strftime('%Y-%m-%d')
                subs = await asyncio.to_thread(db.get_substitutions_for_class_date, class_name, today_str)
                substitution = next((s for s in subs if s[3] == lesson_num), None)
                if substitution:
                    text += f"‚ö†Ô∏è <b>–ó–ê–ú–ï–ù–ê:</b> {substitution[5]} ({substitution[7]})\n"
        text += f"<i>–û–±–Ω–æ–≤–ª–µ–Ω–æ: {now.strftime('%H:%M:%S')}</i>"

    keyboard = [
        [InlineKeyboardButton("üîÑ –û–±–Ω–æ–≤–∏—Ç—å", callback_data=f'now_class_{class_name}')],
        [InlineKeyboardButton("‚Ü©Ô∏è –ù–∞–∑–∞–¥ –∫ –≤—ã–±–æ—Ä—É –∫–ª–∞—Å—Å–∞", callback_data='menu_now')],
        [InlineKeyboardButton("üè† –°—Ç–∞—Ä—Ç / –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data='back_to_main')]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)

    try:
        await safe_edit_message(query, text, reply_markup=reply_markup)
    except BadRequest as e:
        if "message is not modified" in str(e).lower():
            await query.answer("‚úÖ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∞–∫—Ç—É–∞–ª—å–Ω–∞", show_alert=False)
        else:
            raise

# ================== –û–ë–†–ê–ë–û–¢–ß–ò–ö –ö–ù–û–ü–û–ö ==================
async def button_handler(update: Update, context: CallbackContext):
    query = update.callback_query
    if not isinstance(context.user_data, dict):
        context.user_data = {}
    user = query.from_user

    asyncio.create_task(ensure_user_and_log(
        user.id, user.username, user.first_name, user.last_name, user.language_code,
        f'button_{query.data[:50]}'
    ))

    if await check_maintenance_mode(update, context):
        return

    try:
        await query.answer()
    except (TimedOut, Exception) as e:
        logger.warning(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–≤–µ—Ç–µ –Ω–∞ callback: {e}")
        return

    # –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∑–∞–º–µ–Ω
    if context.user_data.get('adding_substitution'):
        try:
            await handle_adding_substitution(query, context)
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∑–∞–º–µ–Ω—ã: {e}")
            await safe_edit_message(query, f"‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: {str(e)[:100]}")
        return

    # –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ—Ö—Ä–µ–∂–∏–º–∞
    if query.data.startswith('maintenance_'):
        duration_type = query.data.split('_', 1)[1]
        await set_maintenance_duration(query, context, duration_type)
        return

    # üîë –û–ë–†–ê–ë–û–¢–ö–ê –ò–ó–ë–†–ê–ù–ù–û–ì–û
    if query.data == 'menu_my':
        await show_my_menu(query, context)
        return
    elif query.data.startswith('my_class_'):
        class_name = query.data.replace('my_class_', '')
        context.user_data['selected_class'] = class_name
        await show_weekly_schedule_for_class(query, context, class_name)
        return
    elif query.data.startswith('my_teacher_'):
        index = int(query.data.replace('my_teacher_', ''))
        teacher_name = ALL_TEACHERS[index]
        await show_teacher_schedule_by_name(query, context, teacher_name)
        return
    elif query.data.startswith('remove_favorite_class_'):
        class_name = query.data.replace('remove_favorite_class_', '')
        user_id = query.from_user.id
        await asyncio.to_thread(db.remove_favorite, user_id, 'class', class_name)
        await query.answer(f"–ö–ª–∞—Å—Å {class_name.upper()} —É–¥–∞–ª–µ–Ω –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ", show_alert=True)
        await show_my_menu(query, context)
        return
    elif query.data.startswith('remove_favorite_teacher_'):
        index = int(query.data.replace('remove_favorite_teacher_', ''))
        teacher_name = ALL_TEACHERS[index]
        user_id = query.from_user.id
        await asyncio.to_thread(db.remove_favorite, user_id, 'teacher', teacher_name)
        await query.answer(f"–£—á–∏—Ç–µ–ª—å {teacher_name} —É–¥–∞–ª–µ–Ω –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ", show_alert=True)
        await show_my_menu(query, context)
        return
    elif query.data.startswith('toggle_favorite_class_'):
        class_name = query.data.replace('toggle_favorite_class_', '')
        user_id = query.from_user.id
        is_fav = await asyncio.to_thread(db.is_favorite, user_id, 'class', class_name)
        if is_fav:
            await asyncio.to_thread(db.remove_favorite, user_id, 'class', class_name)
            await query.answer(f"–ö–ª–∞—Å—Å {class_name.upper()} —É–¥–∞–ª–µ–Ω –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ", show_alert=True)
        else:
            await asyncio.to_thread(db.add_favorite, user_id, 'class', class_name)
            await query.answer(f"–ö–ª–∞—Å—Å {class_name.upper()} –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ", show_alert=True)
        if context.user_data.get('selected_class') == class_name:
            if query.data.startswith('weekly_'):
                await show_weekly_schedule_for_class(query, context, class_name)
            else:
                await show_daily_schedule(query, context)
        else:
            await show_my_menu(query, context)
        return
    elif query.data.startswith('toggle_favorite_teacher_'):
        index = int(query.data.replace('toggle_favorite_teacher_', ''))
        teacher_name = ALL_TEACHERS[index]
        user_id = query.from_user.id
        is_fav = await asyncio.to_thread(db.is_favorite, user_id, 'teacher', teacher_name)
        if is_fav:
            await asyncio.to_thread(db.remove_favorite, user_id, 'teacher', teacher_name)
            await query.answer(f"–£—á–∏—Ç–µ–ª—å {teacher_name} —É–¥–∞–ª–µ–Ω –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ", show_alert=True)
        else:
            await asyncio.to_thread(db.add_favorite, user_id, 'teacher', teacher_name)
            await query.answer(f"–£—á–∏—Ç–µ–ª—å {teacher_name} –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ", show_alert=True)
        await show_teacher_schedule_by_name(query, context, teacher_name)
        return

    # üîë –û–ë–†–ê–ë–û–¢–ö–ê –ù–û–í–û–°–¢–ï–ô
    if query.data == 'menu_news':
        await asyncio.to_thread(db.update_user_last_news_check, user.id)
        context.user_data.pop('news_notification_shown', None)
        await show_news_menu(query, context, page=0)
        return
    elif query.data.startswith('news_page_'):
        page = int(query.data.split('_')[2])
        await show_news_menu(query, context, page)
        return
    elif query.data.startswith('news_detail_'):
        news_id = int(query.data.split('_')[2])
        await show_news_detail(query, context, news_id)
        return
    elif query.data.startswith('admin_edit_news_'):
        news_id = int(query.data.split('_')[3])
        await start_edit_news(query, context, news_id)
        return
    elif query.data == 'cancel_edit_news':
        await cancel_edit_news(query, context)
        return
    elif query.data == 'noop_lesson' or query.data == 'noop_teacher':
    await query.answer()
    return
    elif query.data == 'admin_publish_news':
        await start_publish_news(query, context)
        return
    elif query.data == 'cancel_publish_news':
        context.user_data.clear()
        await show_admin_panel(query)
        return
    elif query.data == 'publish_news_send_all':
        await publish_news(query, context, send_to_all=True)
        return
    elif query.data == 'publish_news_only':
        await publish_news(query, context, send_to_all=False)
        return
    elif query.data == 'admin_manage_news':
        await show_all_news_for_admin(query, context)
        return
    elif query.data.startswith('delete_news_'):
        news_id = int(query.data.split('_')[2])
        await confirm_delete_news(query, context, news_id)
        return
    elif query.data.startswith('confirm_delete_news_'):
        news_id = int(query.data.split('_')[3])
        await delete_news_handler(query, context, news_id)
        return

        # ü§ñ –û–ë–†–ê–ë–û–¢–ö–ê –ò–ò-–ü–û–ú–û–©–ù–ò–ö–ê
    elif query.data == 'menu_ai':
        if not GPT_AVAILABLE:
            await safe_edit_message(
                query,
                "ü§ñ <b>–ò–ò-–ø–æ–º–æ—â–Ω–∏–∫</b>\n\n‚ùå –ò–ò –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.\n"
                "–ü–æ–ø—Ä–æ—Å–∏—Ç–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å HF_TOKEN.",
                reply_markup=InlineKeyboardMarkup([[
                    InlineKeyboardButton("‚óÄÔ∏è –ù–∞–∑–∞–¥", callback_data='back_to_main')
                ]])
            )
            return
        
        await safe_edit_message(
            query,
            "ü§ñ <b>–ò–ò-–ø–æ–º–æ—â–Ω–∏–∫ –¥–ª—è —à–∫–æ–ª—å–Ω–∏–∫–æ–≤</b>\n\n"
            "‚úèÔ∏è <b>–ù–∞–ø–∏—à–∏—Ç–µ –ª—é–±–æ–π –≤–æ–ø—Ä–æ—Å –ø–æ —É—á—ë–±–µ:</b>\n"
            "‚Ä¢ –ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞, —Ñ–∏–∑–∏–∫–∞, —Ö–∏–º–∏—è\n"
            "‚Ä¢ –ò—Å—Ç–æ—Ä–∏—è, –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞, —è–∑—ã–∫–∏\n"
            "‚Ä¢ –û–±—ä—è—Å–Ω–µ–Ω–∏–µ —Ç–µ–º, —Ä–µ—à–µ–Ω–∏–µ –∑–∞–¥–∞—á\n\n"
            "‚ùå <b>–Ø —Ä–∞–±–æ—Ç–∞—é —Ç–æ–ª—å–∫–æ —Å —Ç–µ–∫—Å—Ç–æ–≤—ã–º–∏ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏ (—Ñ–æ—Ç–æ, –≤–∏–¥–µ–æ, –≥–æ–ª–æ—Å–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è —è –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é) </b>\n\n"
            "<i>–ü—Ä–æ—Å—Ç–æ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç ‚Äî —è –æ—Ç–≤–µ—á—É!</i>",
            reply_markup=InlineKeyboardMarkup([[
                InlineKeyboardButton("‚óÄÔ∏è –ù–∞–∑–∞–¥", callback_data='back_to_main')
            ]])
        )
        context.user_data['awaiting_ai'] = True
        return

    # –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –∫–Ω–æ–ø–æ–∫
    if query.data == 'back_to_main':
        await show_main_menu(query)
        return
    elif query.data == 'check_maintenance_status':
        await check_maintenance_status(query, context)
        return
    elif query.data == 'admin_enable_maintenance':
        await enable_maintenance_mode(query, context)
        return
    elif query.data == 'admin_disable_maintenance':
        await disable_maintenance_mode(query, context)
        return
    elif query.data == 'admin_analytics':
        await show_analytics(query, context)
        return
    elif query.data == 'admin_add_sub':
        await show_date_selection(query, context)
        return
    elif query.data == 'menu_now':
        await show_now_class_selection(query, context)
        return
    elif query.data.startswith('now_class_'):
        await show_current_lesson(query, context)
        return
    elif query.data == 'menu_teacher':
        await show_teacher_menu(query, context)
        return
    elif query.data.startswith('teacher_') and not query.data.startswith('teacher_search_'):
        await show_teacher_schedule(query, context)
        return
    elif query.data == 'menu_search_teacher':
        await safe_edit_message(
            query,
            "<b>üîç –ü–û–ò–°–ö –£–ß–ò–¢–ï–õ–Ø</b>\n"
            "–í–≤–µ–¥–∏—Ç–µ —Ñ–∞–º–∏–ª–∏—é –∏–ª–∏ —á–∞—Å—Ç—å —Ñ–∞–º–∏–ª–∏–∏ —É—á–∏—Ç–µ–ª—è –¥–ª—è –ø–æ–∏—Å–∫–∞:\n"
            "<i>–ü—Ä–∏–º–µ—Ä: '–ö–æ—Ä–æ—Ç—á–∏–∫–æ–≤–∞' –∏–ª–∏ '–ì—É–¥'</i>"
        )
        context.user_data['searching_teacher'] = True
        return
    elif query.data == 'menu_bells':
        await show_bells_schedule(query)
        return
    elif query.data == 'menu_schedule':
        await show_class_selection(query)
        return
    elif query.data.startswith('class_'):
        await show_day_selection_for_class(query, context)
        return
    elif query.data.startswith('schedule_'):
        await show_daily_schedule(query, context)
        return
    elif query.data.startswith('weekly_'):
        await show_weekly_schedule(query, context)
        return
    elif query.data == 'menu_substitutions':
        await show_substitutions_menu(query)
        return
    elif query.data in ['subs_yesterday', 'subs_today', 'subs_tomorrow']:
        await show_substitutions_for_date(query)
        return
    elif query.data == 'subs_all':
        await show_all_substitutions(query)
        return
    elif query.data == 'menu_help':
        await show_help(query)
        return
    elif query.data == 'admin_panel':
        await show_admin_panel(query)
        return
    elif query.data == 'admin_view_subs':
        await show_admin_substitutions(query)
        return
    elif query.data == 'admin_delete_sub':
        await request_substitution_deletion(query)
        return
    elif query.data == 'admin_clear_subs':
        await confirm_clear_substitutions(query)
        return
    elif query.data == 'admin_clear_confirm':
        await clear_all_substitutions(query)
        return
    elif query.data == 'admin_broadcast':
        await start_technical_broadcast(query, context)
        return
    elif query.data == 'admin_users':
        await show_users_stats(query, context)
        return
    elif query.data.startswith('teacher_search_'):
        await show_searched_teacher_schedule(query, context)
        return
    elif query.data in ['back_to_date', 'back_to_class', 'back_to_lesson', 'cancel_adding']:
        if 'adding_substitution' in context.user_data:
            await handle_adding_substitution(query, context)
        else:
            await show_main_menu(query)

async def show_main_menu(query):
    """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é (–∫–æ–º–ø–∞–∫—Ç–Ω–æ–µ)."""
    keyboard = [
        [
            InlineKeyboardButton("‚è∞ –°–µ–π—á–∞—Å", callback_data='menu_now'),
            InlineKeyboardButton("üìö –ö–ª–∞—Å—Å—ã", callback_data='menu_schedule')
        ],
        [
            InlineKeyboardButton("üë®‚Äçüè´ –£—á–∏—Ç–µ–ª—è", callback_data='menu_teacher'),
            InlineKeyboardButton("üîç –ü–æ–∏—Å–∫", callback_data='menu_search_teacher')
        ],
        [
            InlineKeyboardButton("üïê –ó–≤–æ–Ω–∫–∏", callback_data='menu_bells'),
            InlineKeyboardButton("üîÑ –ó–∞–º–µ–Ω—ã", callback_data='menu_substitutions')
        ],
        [
            InlineKeyboardButton("üì£ –ù–æ–≤–æ—Å—Ç–∏", callback_data='menu_news'),
            InlineKeyboardButton("üåü –ú–æ—ë", callback_data='menu_my')
        ],
        [
            InlineKeyboardButton("üëë –ê–¥–º–∏–Ω–∫–∞", callback_data='admin_panel'),
            InlineKeyboardButton("üÜò –ü–æ–º–æ—â—å", callback_data='menu_help')
        ],
        [
            InlineKeyboardButton("ü§ñ –ò–ò-–ø–æ–º–æ—â–Ω–∏–∫(—Ç–µ—Å—Ç)", callback_data='menu_ai')
        ]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    await safe_edit_message(
        query,
        'üè´ <b>–®–∫–æ–ª—å–Ω—ã–π –±–æ—Ç</b>\n–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª:',
        reply_markup=reply_markup
    )

async def show_weekly_schedule_for_class(query, context, class_name):
    schedule_text = format_weekly_schedule(class_name)
    user_id = query.from_user.id
    is_fav = await asyncio.to_thread(db.is_favorite, user_id, 'class', class_name)
    fav_button_text = "üóë –£–¥–∞–ª–∏—Ç—å –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ" if is_fav else "‚≠ê –î–æ–±–∞–≤–∏—Ç—å –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ"
    fav_callback = f"toggle_favorite_class_{class_name}"

    keyboard = [
        [InlineKeyboardButton(fav_button_text, callback_data=fav_callback)],
        [InlineKeyboardButton("üåü –ú–û—ë", callback_data='menu_my')],
        [InlineKeyboardButton("‚Ü©Ô∏è –ù–∞–∑–∞–¥ –∫ –≤—ã–±–æ—Ä—É –¥–Ω—è", callback_data=f'class_{class_name}')],
        [InlineKeyboardButton("üè† –°—Ç–∞—Ä—Ç / –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data='back_to_main')]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    await safe_edit_message(query, schedule_text, reply_markup=reply_markup)

async def show_teacher_menu(query, context):
    real_teachers = ALL_TEACHERS
    teachers_per_row = 2
    keyboard = []
    row = []
    for i, teacher in enumerate(real_teachers):
        button_text = teacher
        if len(teacher) > 20:
            button_text = teacher[:18] + "..."
        row.append(InlineKeyboardButton(button_text, callback_data=f'teacher_{i}'))
        if len(row) >= teachers_per_row:
            keyboard.append(row)
            row = []
    if row:
        keyboard.append(row)
    context.user_data['teachers_list'] = real_teachers
    keyboard.append([InlineKeyboardButton("üè† –°—Ç–∞—Ä—Ç / –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data='back_to_main')])
    reply_markup = InlineKeyboardMarkup(keyboard)
    await safe_edit_message(
        query,
        "üë®‚Äçüè´ <b>–†–ê–°–ü–ò–°–ê–ù–ò–ï –£–ß–ò–¢–ï–õ–ï–ô</b>\n"
        "–í—ã–±–µ—Ä–∏—Ç–µ —É—á–∏—Ç–µ–ª—è –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –µ–≥–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è –Ω–∞ –Ω–µ–¥–µ–ª—é:",
        reply_markup=reply_markup
    )

async def show_teacher_schedule(query, context):
    try:
        parts = query.data.split('_')
        teacher_index = int(parts[1])
        teachers_list = context.user_data.get('teachers_list', ALL_TEACHERS)
    except (ValueError, IndexError, KeyError) as e:
        logger.error(f"–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ callback {query.data}, –æ—à–∏–±–∫–∞: {e}")
        keyboard = [[InlineKeyboardButton("üè† –°—Ç–∞—Ä—Ç / –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data='back_to_main')]]
        reply_markup = InlineKeyboardMarkup(keyboard)
        await safe_edit_message(
            query,
            "‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–ø—Ä–æ—Å–∞.\n–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ—Å–ø–æ–ª—å–∑—É–π—Ç–µ—Å—å –º–µ–Ω—é.",
            reply_markup=reply_markup
        )
        return
    if not teachers_list or teacher_index >= len(teachers_list):
        keyboard = [[InlineKeyboardButton("üè† –°—Ç–∞—Ä—Ç / –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data='back_to_main')]]
        reply_markup = InlineKeyboardMarkup(keyboard)
        await safe_edit_message(
            query,
            "<b>‚ùå –û—à–∏–±–∫–∞: —Å–ø–∏—Å–æ–∫ —É—á–∏—Ç–µ–ª–µ–π –Ω–µ –Ω–∞–π–¥–µ–Ω.</b>",
            reply_markup=reply_markup
        )
        return

    teacher_name = teachers_list[teacher_index]
    teacher_schedule = get_cached_teacher_schedule(teacher_name)
    schedule_text = await format_teacher_schedule(teacher_name, teacher_schedule)

    user_id = query.from_user.id
    is_fav = await asyncio.to_thread(db.is_favorite, user_id, 'teacher', teacher_name)
    fav_button_text = "üóë –£–¥–∞–ª–∏—Ç—å –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ" if is_fav else "‚≠ê –î–æ–±–∞–≤–∏—Ç—å –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ"
    fav_callback = f"toggle_favorite_teacher_{ALL_TEACHERS.index(teacher_name)}"

    keyboard = [
        [InlineKeyboardButton(fav_button_text, callback_data=fav_callback)],
        [InlineKeyboardButton("üåü –ú–û—ë", callback_data='menu_my')],
        [InlineKeyboardButton("‚Ü©Ô∏è –ö —Å–ø–∏—Å–∫—É —É—á–∏—Ç–µ–ª–µ–π", callback_data='menu_teacher')],
        [InlineKeyboardButton("üè† –°—Ç–∞—Ä—Ç / –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data='back_to_main')]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    await safe_edit_message(query, schedule_text, reply_markup=reply_markup)

async def format_teacher_schedule(teacher_name, schedule):
    today = datetime.now().date()
    tz_minsk = pytz.timezone('Europe/Minsk')
    now = datetime.now(tz_minsk)
    current_weekday = now.weekday()
    current_day_name = DAYS_OF_WEEK[current_weekday] if current_weekday < 5 else "–ü—è—Ç–Ω–∏—Ü–∞"
    current_lesson_info = get_current_lesson_info()
    current_lesson_number = current_lesson_info['number'] if current_lesson_info['status'] == 'lesson' else None

    start_date = today.strftime('%Y-%m-%d')
    end_date = (today + timedelta(days=30)).strftime('%Y-%m-%d')
    all_subs = await asyncio.to_thread(
        db.get_teacher_substitutions_between,
        teacher_name,
        start_date,
        end_date
    )

    subs_by_date = {}
    for sub in all_subs:
        date_str = sub[1]
        subs_by_date.setdefault(date_str, []).append(sub)

    text = f"<b>üë®‚Äçüè´ {teacher_name}</b>\n"
    text += "=" * 30 + "\n"

    if schedule:
        total_lessons = sum(len(lessons) for lessons in schedule.values())
        classes = set()
        subjects = set()
        for day_lessons in schedule.values():
            for lesson in day_lessons:
                classes.add(lesson['class'])
                subjects.add(lesson['subject'])
        text += f"<b>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:</b>\n"
        text += f"‚Ä¢ –£—Ä–æ–∫–æ–≤: <b>{total_lessons}</b>\n"
        text += f"‚Ä¢ –ö–ª–∞—Å—Å—ã: <b>{', '.join(sorted(classes))}</b>\n"
        text += f"‚Ä¢ –ü—Ä–µ–¥–º–µ—Ç—ã: <b>{', '.join(sorted(subjects))}</b>\n"
    else:
        text += "<i>‚ùå –ù–µ—Ç —É—Ä–æ–∫–æ–≤ –≤ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–∏</i>\n"

    total_subs = len(all_subs)
    if total_subs > 0:
        text += f"‚Ä¢ <b>‚ö†Ô∏è –ó–∞–º–µ–Ω: {total_subs}</b>\n"

    text += "\n" + "=" * 30 + "\n"
    text += "<b>üìÖ –û–°–ù–û–í–ù–û–ï –†–ê–°–ü–ò–°–ê–ù–ò–ï:</b>\n"

    days_order = ["–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫", "–í—Ç–æ—Ä–Ω–∏–∫", "–°—Ä–µ–¥–∞", "–ß–µ—Ç–≤–µ—Ä–≥", "–ü—è—Ç–Ω–∏—Ü–∞"]
    has_main_schedule = False

    for day in days_order:
        if day in schedule and schedule[day]:
            has_main_schedule = True
            text += f"<b>{day.upper()}</b>\n"
            text += "‚îÄ" * 18 + "\n"
            sorted_lessons = sorted(schedule[day], key=lambda x: x['number'])

            for lesson in sorted_lessons:
                if 1 <= lesson['number'] <= 7:
                    emoji = ["1Ô∏è‚É£", "2Ô∏è‚É£", "3Ô∏è‚É£", "4Ô∏è‚É£", "5Ô∏è‚É£", "6Ô∏è‚É£", "7Ô∏è‚É£"][lesson['number'] - 1]
                    lesson_marker = emoji
                else:
                    lesson_marker = f"{lesson['number']}. "

                col1 = f"{lesson_marker} <b>{lesson['time']}</b> "
                col2 = f"<code>{lesson['class'].upper()}</code> ‚û°Ô∏è {lesson['subject']} "
                teachers = lesson['full_teacher'].split('/')
                if len(teachers) > 1:
                    col2 += " <i>(—Å —Å–æ–≤–º.)</i> "

                if day == current_day_name and lesson['number'] == current_lesson_number:
                    text += f"üü¢ {col1}   {col2}\n"
                else:
                    text += f"{col1}   {col2}\n"
            text += "\n"

    if not has_main_schedule:
        text += "<i>–ù–µ—Ç —É—Ä–æ–∫–æ–≤ –Ω–∞ –Ω–µ–¥–µ–ª—é</i>\n"

    text += "=" * 30 + "\n"
    text += "<b>üîÑ –ó–ê–ú–ï–ù–´ (30 –¥–Ω–µ–π):</b>\n"

    if subs_by_date:
        shown_dates = 0
        for i in range(30):
            date_obj = today + timedelta(days=i)
            date_str = date_obj.strftime('%Y-%m-%d')
            if date_str in subs_by_date:
                weekday = date_obj.weekday()
                if weekday < 5:
                    day_name = DAYS_OF_WEEK[weekday]
                else:
                    continue
                text += f"<b>{day_name}</b> <i>({date_obj.strftime('%d.%m')})</i>\n"
                text += "‚îÄ" * 18 + "\n"
                for sub in subs_by_date[date_str]:
                    lesson_num = sub[3]
                    lesson_time = get_lesson_time(lesson_num)
                    if 1 <= lesson_num <= 7:
                        emoji = ["1Ô∏è‚É£", "2Ô∏è‚É£", "3Ô∏è‚É£", "4Ô∏è‚É£", "5Ô∏è‚É£", "6Ô∏è‚É£", "7Ô∏è‚É£"][lesson_num - 1]
                        lesson_marker = emoji
                    else:
                        lesson_marker = f"{lesson_num}. "
                    if sub[7] == teacher_name:
                        text += f"{lesson_marker} <b>{lesson_time}</b> <code>{sub[8]}</code> ‚û°Ô∏è {sub[5]}\n"
                        text += f"   üîÑ –≤–º–µ—Å—Ç–æ {sub[4]} ({sub[6]})\n"
                    elif sub[6] == teacher_name:
                        text += f"{lesson_marker} <b>{lesson_time}</b> <code>{sub[8]}</code> ‚û°Ô∏è {sub[4]}\n"
                        text += f"   üîÑ –∑–∞–º–µ–Ω—ë–Ω –Ω–∞ {sub[7]} ({sub[5]})\n"
                shown_dates += 1
                if shown_dates >= 7:
                    break
        if shown_dates == 0:
            text += "<i>–ù–∞ –±–ª–∏–∂–∞–π—à–∏–µ 30 –¥–Ω–µ–π –∑–∞–º–µ–Ω –Ω–µ—Ç</i>\n"
    else:
        text += "<i>–ù–∞ –±–ª–∏–∂–∞–π—à–∏–µ 30 –¥–Ω–µ–π –∑–∞–º–µ–Ω –Ω–µ—Ç</i>\n"

    text += "\n" + "=" * 30 + "\n"
    text += "<i>‚ÑπÔ∏è üü¢ ‚Äî —Ç–µ–∫—É—â–∏–π —É—Ä–æ–∫ | –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –∏ –∑–∞–º–µ–Ω—ã –Ω–∞ 30 –¥–Ω–µ–π</i>"
    return text

async def show_bells_schedule(query):
    keyboard = [[InlineKeyboardButton("üè† –°—Ç–∞—Ä—Ç / –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data='back_to_main')]]
    reply_markup = InlineKeyboardMarkup(keyboard)
    await safe_edit_message(query, BELLS_SCHEDULE_HTML, reply_markup=reply_markup)

async def show_class_selection(query):
    keyboard = [
        [InlineKeyboardButton("5–ê", callback_data='class_5–∞'), InlineKeyboardButton("5–ë", callback_data='class_5–±'), InlineKeyboardButton("5–í", callback_data='class_5–≤')],
        [InlineKeyboardButton("6–ê", callback_data='class_6–∞'), InlineKeyboardButton("6–ë", callback_data='class_6–±'), InlineKeyboardButton("6–í", callback_data='class_6–≤')],
        [InlineKeyboardButton("7–ê", callback_data='class_7–∞'), InlineKeyboardButton("7–ë", callback_data='class_7–±'), InlineKeyboardButton("7–í", callback_data='class_7–≤')],
        [InlineKeyboardButton("8–ê", callback_data='class_8–∞'), InlineKeyboardButton("8–ë", callback_data='class_8–±')],
        [InlineKeyboardButton("9–ê", callback_data='class_9–∞'), InlineKeyboardButton("9–ë", callback_data='class_9–±')],
        [InlineKeyboardButton("10–ê", callback_data='class_10–∞'), InlineKeyboardButton("10–ë", callback_data='class_10–±')],
        [InlineKeyboardButton("11", callback_data='class_11')],
        [InlineKeyboardButton("üè† –°—Ç–∞—Ä—Ç / –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data='back_to_main')]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    await safe_edit_message(
        query,
        "üìö <b>–†–ê–°–ü–ò–°–ê–ù–ò–ï –£–†–û–ö–û–í</b>\n–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∞—Å—Å:",
        reply_markup=reply_markup
    )

async def show_day_selection_for_class(query, context):
    class_name = query.data.replace('class_', '')
    context.user_data['selected_class'] = class_name
    keyboard = []
    for day in DAYS_OF_WEEK:
        keyboard.append([InlineKeyboardButton(day, callback_data=f'schedule_{day.lower()}')])
    keyboard.append([InlineKeyboardButton("üìÖ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –Ω–∞ –≤—Å—é –Ω–µ–¥–µ–ª—é", callback_data=f'weekly_{class_name}')])
    keyboard.append([InlineKeyboardButton("‚Ü©Ô∏è –ù–∞–∑–∞–¥ –∫ –∫–ª–∞—Å—Å–∞–º", callback_data='menu_schedule')])
    keyboard.append([InlineKeyboardButton("üè† –°—Ç–∞—Ä—Ç / –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data='back_to_main')])
    reply_markup = InlineKeyboardMarkup(keyboard)
    await safe_edit_message(
        query,
        f"üìö –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è {class_name.upper()}\n–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–Ω—å –Ω–µ–¥–µ–ª–∏ –∏–ª–∏ –ø—Ä–æ—Å–º–æ—Ç—Ä–∏—Ç–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –Ω–∞ –≤—Å—é –Ω–µ–¥–µ–ª—é:",
        reply_markup=reply_markup
    )

async def show_daily_schedule(query, context):
    day = query.data.replace('schedule_', '').capitalize()
    class_name = context.user_data.get('selected_class', '')
    target_date_str = None
    if day in day_mapping:
        current_weekday = today.weekday()
        target_weekday = day_mapping[day]
        days_ahead = target_weekday - current_weekday
        if days_ahead < 0:
            days_ahead += 7
        target_date = today + timedelta(days=days_ahead)
        target_date_str = target_date.strftime('%Y-%m-%d')

     if class_name and class_name in SCHEDULE_STRUCTURED and day in SCHEDULE_STRUCTURED[class_name]:
        structured_lessons = SCHEDULE_STRUCTURED[class_name][day]
        schedule_text, schedule_keyboard = await format_schedule_day(
            class_name, 
            day, 
            structured_lessons, 
            target_date_str
        )
    else:
        schedule_text = f"–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è –∫–ª–∞—Å—Å–∞ {class_name} –Ω–∞ {day} –Ω–µ –Ω–∞–π–¥–µ–Ω–æ."
        schedule_keyboard = None

    user_id = query.from_user.id
    is_fav = await asyncio.to_thread(db.is_favorite, user_id, 'class', class_name)
    fav_button_text = "üóë –£–¥–∞–ª–∏—Ç—å –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ" if is_fav else "‚≠ê –î–æ–±–∞–≤–∏—Ç—å –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ"
    fav_callback = f"toggle_favorite_class_{class_name}"

     keyboard = [
        [InlineKeyboardButton(fav_button_text, callback_data=fav_callback)],
        [InlineKeyboardButton("üìÖ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –Ω–∞ –≤—Å—é –Ω–µ–¥–µ–ª—é", callback_data=f'weekly_{class_name}')],
        [InlineKeyboardButton("üåü –ú–û—ë", callback_data='menu_my')],
        [InlineKeyboardButton("‚Ü©Ô∏è –ù–∞–∑–∞–¥ –∫ –¥–Ω—è–º", callback_data=f'class_{class_name}')],
        [InlineKeyboardButton("üè† –°—Ç–∞—Ä—Ç / –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data='back_to_main')]
    ]
    
    # –ï—Å–ª–∏ –µ—Å—Ç—å –∫–Ω–æ–ø–∫–∏ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è, –¥–æ–±–∞–≤–ª—è–µ–º –∏—Ö
    if schedule_keyboard:
        keyboard = schedule_keyboard.inline_keyboard + keyboard
    
    reply_markup = InlineKeyboardMarkup(keyboard)
    await safe_edit_message(query, schedule_text, reply_markup=reply_markup)

async def show_weekly_schedule(query, context):
    class_name = query.data.replace('weekly_', '')
    context.user_data['selected_class'] = class_name
    
    schedule_text, schedule_keyboard = format_weekly_schedule(class_name)
    user_id = query.from_user.id
    is_fav = await asyncio.to_thread(db.is_favorite, user_id, 'class', class_name)
    fav_button_text = "üóë –£–¥–∞–ª–∏—Ç—å –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ" if is_fav else "‚≠ê –î–æ–±–∞–≤–∏—Ç—å –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ"
    fav_callback = f"toggle_favorite_class_{class_name}"

    keyboard = [
        [InlineKeyboardButton(fav_button_text, callback_data=fav_callback)],
        [InlineKeyboardButton("üåü –ú–û—ë", callback_data='menu_my')],
        [InlineKeyboardButton("‚Ü©Ô∏è –ù–∞–∑–∞–¥ –∫ –≤—ã–±–æ—Ä—É –¥–Ω—è", callback_data=f'class_{class_name}')],
        [InlineKeyboardButton("üè† –°—Ç–∞—Ä—Ç / –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data='back_to_main')]
    ]
    
    # –ï—Å–ª–∏ –µ—Å—Ç—å –∫–Ω–æ–ø–∫–∏ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è, –¥–æ–±–∞–≤–ª—è–µ–º –∏—Ö
    if schedule_keyboard:
        keyboard = schedule_keyboard.inline_keyboard + keyboard
    
    reply_markup = InlineKeyboardMarkup(keyboard)
    await safe_edit_message(query, schedule_text, reply_markup=reply_markup)

async def show_substitutions_menu(query):
    keyboard = [
        [InlineKeyboardButton("üîÑ –í—á–µ—Ä–∞", callback_data='subs_yesterday')],
        [InlineKeyboardButton("üîÑ –°–µ–≥–æ–¥–Ω—è", callback_data='subs_today')],
        [InlineKeyboardButton("üîÑ –ó–∞–≤—Ç—Ä–∞", callback_data='subs_tomorrow')],
        [InlineKeyboardButton("üìã –í—Å–µ –∑–∞–º–µ–Ω—ã", callback_data='subs_all')],
        [InlineKeyboardButton("üè† –°—Ç–∞—Ä—Ç / –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data='back_to_main')]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    await safe_edit_message(
        query,
        "üîÑ <b>–ó–ê–ú–ï–ù–´ –£–†–û–ö–û–í</b>\n–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–Ω—å:",
        reply_markup=reply_markup
    )

async def show_substitutions_for_date(query):
    today = datetime.now().date()
    if query.data == 'subs_yesterday':
        target_date = today - timedelta(days=1)
    elif query.data == 'subs_today':
        target_date = today
    else:
        target_date = today + timedelta(days=1)

    subs = await asyncio.to_thread(db.get_substitutions_for_date, target_date.strftime('%Y-%m-%d'))

    if subs:
        text = f"<b>üîÑ –ó–∞–º–µ–Ω—ã –Ω–∞ {target_date.strftime('%d.%m.%Y')} ({DAYS_OF_WEEK[target_date.weekday()] if target_date.weekday() < 5 else '–í—ã—Ö–æ–¥–Ω–æ–π'}):</b>\n"
        for sub in subs:
            text += format_substitution(sub) + "\n"
    else:
        text = f"<b>–ù–∞ {target_date.strftime('%d.%m.%Y')} ({DAYS_OF_WEEK[target_date.weekday()] if target_date.weekday() < 5 else '–í—ã—Ö–æ–¥–Ω–æ–π'}) –∑–∞–º–µ–Ω –Ω–µ—Ç.</b>"

    keyboard = [
        [InlineKeyboardButton("‚Ü©Ô∏è –ù–∞–∑–∞–¥ –∫ –∑–∞–º–µ–Ω–∞–º", callback_data='menu_substitutions')],
        [InlineKeyboardButton("üè† –°—Ç–∞—Ä—Ç / –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data='back_to_main')]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    await safe_edit_message(query, text, reply_markup=reply_markup)

async def show_all_substitutions(query):
    subs = await asyncio.to_thread(db.get_all_substitutions)
    if subs:
        text = "<b>üìã –í–°–ï –ó–ê–ú–ï–ù–´:</b>\n"
        current_date = None
        for sub in subs:
            if sub[1] != current_date:
                current_date = sub[1]
                text += f"\nüìÖ {current_date}:\n"
            text += format_substitution(sub) + "\n"
    else:
        text = "–ó–∞–º–µ–Ω—ã –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç."

    keyboard = [
        [InlineKeyboardButton("‚Ü©Ô∏è –ù–∞–∑–∞–¥ –∫ –∑–∞–º–µ–Ω–∞–º", callback_data='menu_substitutions')],
        [InlineKeyboardButton("üè† –°—Ç–∞—Ä—Ç / –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data='back_to_main')]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    await safe_edit_message(query, text, reply_markup=reply_markup)

async def show_help(query):
    help_text = (
        "üÜò <b>–ü–û–ú–û–©–¨ –ò –ü–û–î–î–ï–†–ñ–ö–ê</b>\n\n"
        "–ï—Å–ª–∏ –≤—ã –æ–±–Ω–∞—Ä—É–∂–∏–ª–∏ –æ—à–∏–±–∫—É –≤ —Ä–∞–±–æ—Ç–µ –±–æ—Ç–∞ –∏–ª–∏ —É –≤–∞—Å –µ—Å—Ç—å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –ø–æ —É–ª—É—á—à–µ–Ω–∏—é, –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å:\n\n"
        "üë®‚Äçüíº <b>–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä:</b>\n"
        "‚Ä¢ –§–ò–û: –ì—É–¥ –Æ—Ä–∏–π –ü–µ—Ç—Ä–æ–≤–∏—á (@Yury_hud)\n"
        "‚Ä¢ üìß Email: uragud.2020@gmail.com\n\n"
        "üïê <b>–í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞:</b>\n"
        "–ü–Ω-–ü—Ç: 9:00-18:00\n"
        "–°–±,–í—Å: –≤—ã—Ö–æ–¥–Ω–æ–π\n\n"
        "–î–ª—è –±—ã—Å—Ç—Ä–æ–π –ø–æ–º–æ—â–∏ —É–∫–∞–∂–∏—Ç–µ:\n"
        "‚Ä¢ –í–∞—à–µ –∏–º—è –∏ –∫–ª–∞—Å—Å\n"
        "‚Ä¢ –í—Ä–µ–º—è –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏—è –æ—à–∏–±–∫–∏\n"
        "‚Ä¢ –°–∫—Ä–∏–Ω—à–æ—Ç –ø—Ä–æ–±–ª–µ–º—ã (–µ—Å–ª–∏ –µ—Å—Ç—å)"
    )
    keyboard = [[InlineKeyboardButton("üè† –°—Ç–∞—Ä—Ç / –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data='back_to_main')]]
    reply_markup = InlineKeyboardMarkup(keyboard)
    await safe_edit_message(query, help_text, reply_markup=reply_markup)

async def show_admin_panel(query):
    if query.from_user.id not in ADMIN_IDS:
        await safe_edit_message(query, "‚õî –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω!")
        return

    maintenance = await asyncio.to_thread(db.get_maintenance_status)
    keyboard = []

    if maintenance['enabled']:
        status_text = f"‚úÖ –¢–µ—Ö—Ä–µ–∂–∏–º –í–ö–õ–Æ–ß–ï–ù"
        if maintenance['until']:
            status_text += f" –¥–æ {maintenance['until']}"
        keyboard.append([InlineKeyboardButton(f"üõë {status_text}", callback_data='admin_disable_maintenance')])
    else:
        keyboard.append([InlineKeyboardButton("üîß –í–∫–ª—é—á–∏—Ç—å —Ç–µ—Ö—Ä–µ–∂–∏–º", callback_data='admin_enable_maintenance')])

    keyboard += [
        [InlineKeyboardButton("üì£ –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –Ω–æ–≤–æ—Å—Ç—å", callback_data='admin_publish_news')],
        [InlineKeyboardButton("üóë –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ—Å—Ç—è–º–∏", callback_data='admin_manage_news')],
        [InlineKeyboardButton("‚ûï –î–æ–±–∞–≤–∏—Ç—å –∑–∞–º–µ–Ω—É", callback_data='admin_add_sub')],
        [InlineKeyboardButton("üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞", callback_data='admin_analytics')],
        [InlineKeyboardButton("üë• –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π", callback_data='admin_users')],
        [InlineKeyboardButton("üìã –ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ –∑–∞–º–µ–Ω—ã", callback_data='admin_view_subs')],
        [InlineKeyboardButton("üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –∑–∞–º–µ–Ω—É", callback_data='admin_delete_sub')],
        [InlineKeyboardButton("üßπ –û—á–∏—Å—Ç–∫–∞ –∑–∞–º–µ–Ω", callback_data='admin_clear_subs')],
        [InlineKeyboardButton("üè† –°—Ç–∞—Ä—Ç / –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data='back_to_main')]
    ]

    reply_markup = InlineKeyboardMarkup(keyboard)
    await safe_edit_message(
        query,
        "<b>üëë –ê–î–ú–ò–ù-–ü–ê–ù–ï–õ–¨</b>\n–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:",
        reply_markup=reply_markup
    )

async def show_admin_substitutions(query):
    if query.from_user.id not in ADMIN_IDS:
        return

    subs = await asyncio.to_thread(db.get_all_substitutions)
    if subs:
        text = "üìã <b>–í–°–ï –ó–ê–ú–ï–ù–´ –í –ë–ê–ó–ï:</b>\n"
        for sub in subs:
            text += f"ID:{sub[0]} | {sub[1]} ({sub[2]}) | –ö–ª–∞—Å—Å: {sub[8]}\n"
            text += format_substitution(sub) + "\n"
    else:
        text = "–í –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –∑–∞–º–µ–Ω –Ω–µ—Ç."

    keyboard = [
        [InlineKeyboardButton("‚Ü©Ô∏è –í –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å", callback_data='admin_panel')],
        [InlineKeyboardButton("üè† –°—Ç–∞—Ä—Ç / –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data='back_to_main')]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    await safe_edit_message(query, text, reply_markup=reply_markup)

async def request_substitution_deletion(query):
    if query.from_user.id not in ADMIN_IDS:
        return
    await safe_edit_message(
        query,
        "üóëÔ∏è <b>–£–î–ê–õ–ï–ù–ò–ï –ó–ê–ú–ï–ù–´</b>\n"
        "–í–≤–µ–¥–∏—Ç–µ ID –∑–∞–º–µ–Ω—ã –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è (–ø–æ—Å–º–æ—Ç—Ä–∏—Ç–µ ID –≤ —Å–ø–∏—Å–∫–µ –≤—Å–µ—Ö –∑–∞–º–µ–Ω):"
    )

async def confirm_clear_substitutions(query):
    if query.from_user.id not in ADMIN_IDS:
        return

    subs = await asyncio.to_thread(db.get_all_substitutions)
    sub_count = len(subs) if subs else 0

    keyboard = [
        [
            InlineKeyboardButton("‚úÖ –î–∞, —É–¥–∞–ª–∏—Ç—å –≤—Å–µ", callback_data='admin_clear_confirm'),
            InlineKeyboardButton("‚ùå –ù–µ—Ç, –æ—Ç–º–µ–Ω–∏—Ç—å", callback_data='admin_panel')
        ],
        [InlineKeyboardButton("üè† –°—Ç–∞—Ä—Ç / –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data='back_to_main')]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    await safe_edit_message(
        query,
        f"‚ö†Ô∏è <b>–ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ò–ï –û–ß–ò–°–¢–ö–ò –ó–ê–ú–ï–ù</b>\n\n"
        f"–í—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –í–°–ï –∑–∞–º–µ–Ω—ã –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö?\n\n"
        f"üìä <b>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:</b>\n"
        f"‚Ä¢ –í—Å–µ–≥–æ –∑–∞–º–µ–Ω –≤ –±–∞–∑–µ: {sub_count}\n\n"
        f"‚ö†Ô∏è –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ!\n"
        f"–í—Å–µ –¥–∞–Ω–Ω—ã–µ –æ –∑–∞–º–µ–Ω–∞—Ö –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã –±–µ–∑ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è.",
        reply_markup=reply_markup
    )

async def clear_all_substitutions(query):
    if query.from_user.id not in ADMIN_IDS:
        return

    subs_before = await asyncio.to_thread(db.get_all_substitutions)
    sub_count = len(subs_before) if subs_before else 0

    try:
        await asyncio.to_thread(db.clear_all_substitutions)
        keyboard = [
            [InlineKeyboardButton("‚Ü©Ô∏è –í –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å", callback_data='admin_panel')],
            [InlineKeyboardButton("üè† –°—Ç–∞—Ä—Ç / –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data='back_to_main')]
        ]
        reply_markup = InlineKeyboardMarkup(keyboard)
        await safe_edit_message(
            query,
            f"‚úÖ <b>–û–ß–ò–°–¢–ö–ê –ó–ê–ú–ï–ù –í–´–ü–û–õ–ù–ï–ù–ê</b>\n\n"
            f"–£–¥–∞–ª–µ–Ω–æ –∑–∞–º–µ–Ω: {sub_count}\n"
            f"–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∑–∞–º–µ–Ω —Ç–µ–ø–µ—Ä—å –ø—É—Å—Ç–∞.",
            reply_markup=reply_markup
        )
        logger.info(f"–ê–¥–º–∏–Ω {query.from_user.id} –æ—á–∏—Å—Ç–∏–ª –≤—Å–µ –∑–∞–º–µ–Ω—ã. –£–¥–∞–ª–µ–Ω–æ: {sub_count}")
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ –∑–∞–º–µ–Ω: {e}")
        keyboard = [
            [InlineKeyboardButton("‚Ü©Ô∏è –í –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å", callback_data='admin_panel')],
            [InlineKeyboardButton("üè† –°—Ç–∞—Ä—Ç / –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data='back_to_main')]
        ]
        reply_markup = InlineKeyboardMarkup(keyboard)
        await safe_edit_message(
            query,
            f"‚ùå <b>–û–®–ò–ë–ö–ê –ü–†–ò –û–ß–ò–°–¢–ö–ï</b>\n\n"
            f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—á–∏—Å—Ç–∏—Ç—å –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö –∑–∞–º–µ–Ω.\n"
            f"–û—à–∏–±–∫–∞: {str(e)[:100]}",
            reply_markup=reply_markup
        )

async def show_searched_teacher_schedule(query, context):
    try:
        teacher_index = int(query.data.split('_')[2])
        found_teachers = context.user_data.get('found_teachers', [])

        if not found_teachers or teacher_index >= len(found_teachers):
            keyboard = [[InlineKeyboardButton("üè† –°—Ç–∞—Ä—Ç / –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data='back_to_main')]]
            reply_markup = InlineKeyboardMarkup(keyboard)
            await safe_edit_message(
                query,
                "‚ùå –û—à–∏–±–∫–∞: —Å–ø–∏—Å–æ–∫ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö —É—á–∏—Ç–µ–ª–µ–π –Ω–µ –Ω–∞–π–¥–µ–Ω.",
                reply_markup=reply_markup
            )
            return

        teacher_name = found_teachers[teacher_index]
        teacher_schedule = get_cached_teacher_schedule(teacher_name)
        schedule_text = await format_teacher_schedule(teacher_name, teacher_schedule)

        user_id = query.from_user.id
        is_fav = await asyncio.to_thread(db.is_favorite, user_id, 'teacher', teacher_name)
        fav_button_text = "üóë –£–¥–∞–ª–∏—Ç—å –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ" if is_fav else "‚≠ê –î–æ–±–∞–≤–∏—Ç—å –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ"
        fav_callback = f"toggle_favorite_teacher_{ALL_TEACHERS.index(teacher_name)}"

        keyboard = [
            [InlineKeyboardButton(fav_button_text, callback_data=fav_callback)],
            [InlineKeyboardButton("üîç –ù–æ–≤—ã–π –ø–æ–∏—Å–∫", callback_data='menu_search_teacher')],
            [InlineKeyboardButton("üë®‚Äçüè´ –í—Å–µ —É—á–∏—Ç–µ–ª—è", callback_data='menu_teacher')],
            [InlineKeyboardButton("üè† –°—Ç–∞—Ä—Ç / –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data='back_to_main')]
        ]
        reply_markup = InlineKeyboardMarkup(keyboard)
        await safe_edit_message(query, schedule_text, reply_markup=reply_markup)
        context.user_data['searching_teacher'] = False
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –≤ show_searched_teacher_schedule: {e}")
        keyboard = [[InlineKeyboardButton("üè† –°—Ç–∞—Ä—Ç / –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data='back_to_main')]]
        reply_markup = InlineKeyboardMarkup(keyboard)
        await safe_edit_message(
            query,
            f"‚ùå –û—à–∏–±–∫–∞: {str(e)[:100]}",
            reply_markup=reply_markup
        )

# ================== –§–£–ù–ö–¶–ò–ò –†–ê–°–°–´–õ–ö–ò –¢–ï–•–ù–ò–ß–ï–°–ö–ò–• –£–í–ï–î–û–ú–õ–ï–ù–ò–ô ==================
async def show_users_stats(query, context):
    if query.from_user.id not in ADMIN_IDS:
        return

    user_count = await asyncio.to_thread(db.get_user_count)
    users = await asyncio.to_thread(db.get_all_users)

    text = f"üë• <b>–°–¢–ê–¢–ò–°–¢–ò–ö–ê –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï–ô</b>\n"
    text += f"‚Ä¢ –í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: {user_count}\n\n"

    if users:
        text += "–ü–æ—Å–ª–µ–¥–Ω–∏–µ 10 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:\n"
        for user in users[-10:]:
            user_id, username, first_name, last_name = user
            name = f"{first_name or ''} {last_name or ''}".strip() or "–ë–µ–∑ –∏–º–µ–Ω–∏"
            if username:
                name += f" (@{username})"
            text += f"‚Ä¢ ID: `{user_id}` ‚Äî {name}\n"
    else:
        text += "–ù–µ—Ç –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π"

    keyboard = [
        [InlineKeyboardButton("‚Ü©Ô∏è –í –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å", callback_data='admin_panel')],
        [InlineKeyboardButton("üè† –°—Ç–∞—Ä—Ç / –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data='back_to_main')]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    await safe_edit_message(query, text, reply_markup=reply_markup)

async def start_technical_broadcast(query, context):
    if query.from_user.id not in ADMIN_IDS:
        return

    context.user_data['broadcasting'] = True
    context.user_data['broadcast_step'] = 'time'

    keyboard = [
        [InlineKeyboardButton("‚ùå –û—Ç–º–µ–Ω–∞", callback_data='cancel_broadcast')],
        [InlineKeyboardButton("üè† –°—Ç–∞—Ä—Ç / –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data='back_to_main')]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    await safe_edit_message(
        query,
        "üì¢ <b>–†–ê–°–°–´–õ–ö–ê –¢–ï–•–ù–ò–ß–ï–°–ö–û–ì–û –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø</b>\n\n"
        "–í–≤–µ–¥–∏—Ç–µ –≤—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö —Ä–∞–±–æ—Ç –≤ —Ñ–æ—Ä–º–∞—Ç–µ:\n"
        "`–î–î.–ú–ú –ß–ß:–ú–ú`\n"
        "–ü—Ä–∏–º–µ—Ä: `05.02 18:30`\n\n"
        "–≠—Ç–æ –≤—Ä–µ–º—è –±—É–¥–µ—Ç —É–∫–∞–∑–∞–Ω–æ –≤ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–∏ –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º.",
        reply_markup=reply_markup
    )

async def handle_broadcast_time(update: Update, context: CallbackContext):
    if not context.user_data.get('broadcasting') or context.user_data.get('broadcast_step') != 'time':
        return

    time_input = update.message.text.strip()
    if not re.match(r'^\d{2}\.\d{2} \d{2}:\d{2}$', time_input):
        await update.message.reply_text(
            "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –≤—Ä–µ–º–µ–Ω–∏!\n"
            "–í–≤–µ–¥–∏—Ç–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ: `–î–î.–ú–ú –ß–ß:–ú–ú`\n"
            "–ü—Ä–∏–º–µ—Ä: `05.02 18:30`",
            parse_mode='HTML'
        )
        return

    context.user_data['broadcast_time'] = time_input
    context.user_data['broadcast_step'] = 'confirm'

    broadcast_message = (
        f"‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï! –¢–ï–•–ù–ò–ß–ï–°–ö–ò–ï –†–ê–ë–û–¢–´ ‚ö†Ô∏è\n"
        f"–°–µ—Ä–≤–∏—Å –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –≤ —Å–≤—è–∑–∏ —Å —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–º–∏ —Ä–∞–±–æ—Ç–∞–º–∏.\n"
        f"üïó –†–∞–±–æ—Ç—ã –∑–∞–≤–µ—Ä—à–∞—Ç—Å—è: {time_input}\n"
        f"–ü—Ä–∏–Ω–æ—Å–∏–º –∏–∑–≤–∏–Ω–µ–Ω–∏—è –∑–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –Ω–µ—É–¥–æ–±—Å—Ç–≤–∞.\n"
        f"–ë–æ—Ç –≤–æ–∑–æ–±–Ω–æ–≤–∏—Ç —Ä–∞–±–æ—Ç—É —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –æ–∫–æ–Ω—á–∞–Ω–∏—è —Ä–∞–±–æ—Ç."
    )

    keyboard = [
        [InlineKeyboardButton("‚úÖ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤—Å–µ–º", callback_data='confirm_broadcast')],
        [InlineKeyboardButton("‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å –≤—Ä–µ–º—è", callback_data='edit_broadcast_time')],
        [InlineKeyboardButton("‚ùå –û—Ç–º–µ–Ω–∞", callback_data='cancel_broadcast')],
        [InlineKeyboardButton("üè† –°—Ç–∞—Ä—Ç / –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data='back_to_main')]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    await update.message.reply_text(
        "üîç <b>–ü–†–ï–î–ü–†–û–°–ú–û–¢–† –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø:</b>\n" + broadcast_message,
        reply_markup=reply_markup,
        parse_mode='HTML'
    )

async def confirm_broadcast(query, context):
    if query.from_user.id not in ADMIN_IDS:
        return

    broadcast_time = context.user_data.get('broadcast_time')
    if not broadcast_time:
        await safe_edit_message(query, "‚ùå –û—à–∏–±–∫–∞: –≤—Ä–µ–º—è –Ω–µ —É–∫–∞–∑–∞–Ω–æ.")
        context.user_data.clear()
        return

    broadcast_message = (
        f"‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï! –¢–ï–•–ù–ò–ß–ï–°–ö–ò–ï –†–ê–ë–û–¢–´ ‚ö†Ô∏è\n"
        f"–°–µ—Ä–≤–∏—Å –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –≤ —Å–≤—è–∑–∏ —Å —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–º–∏ —Ä–∞–±–æ—Ç–∞–º–∏.\n"
        f"üïó –†–∞–±–æ—Ç—ã –∑–∞–≤–µ—Ä—à–∞—Ç—Å—è: {broadcast_time}\n"
        f"–ü—Ä–∏–Ω–æ—Å–∏–º –∏–∑–≤–∏–Ω–µ–Ω–∏—è –∑–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –Ω–µ—É–¥–æ–±—Å—Ç–≤–∞.\n"
        f"–ë–æ—Ç –≤–æ–∑–æ–±–Ω–æ–≤–∏—Ç —Ä–∞–±–æ—Ç—É —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –æ–∫–æ–Ω—á–∞–Ω–∏—è —Ä–∞–±–æ—Ç."
    )

    users = await asyncio.to_thread(db.get_all_users)
    total = len(users)
    sent = 0
    failed = 0

    status_message = await query.edit_message_text(
        f"üì§ <b>–ù–ê–ß–ê–¢–ê –†–ê–°–°–´–õ–ö–ê</b>\n\n"
        f"–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: {total}\n"
        f"–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: 0\n"
        f"–û—à–∏–±–æ–∫: 0\n"
        f"–°—Ç–∞—Ç—É—Å: ‚è≥ –ù–∞—á–∏–Ω–∞–µ–º...",
        parse_mode='HTML'
    )

    for i, (user_id, username, first_name, last_name) in enumerate(users):
        try:
            await context.bot.send_message(chat_id=user_id, text=broadcast_message, parse_mode='HTML')
            sent += 1
        except Forbidden:
            failed += 1
            logger.warning(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª –±–æ—Ç–∞")
        except Exception as e:
            failed += 1
            logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user_id}: {e}")

        if i % 5 == 0 or i == total - 1:
            try:
                await status_message.edit_text(
                    f"üì§ <b>–†–ê–°–°–´–õ–ö–ê –í –ü–†–û–¶–ï–°–°–ï</b>\n\n"
                    f"–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: {total}\n"
                    f"–£—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: {sent}\n"
                    f"–û—à–∏–±–æ–∫: {failed}\n"
                    f"–°—Ç–∞—Ç—É—Å: {'‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–æ' if i == total - 1 else '‚è≥ –í –ø—Ä–æ—Ü–µ—Å—Å–µ...'}",
                    parse_mode='HTML'
                )
            except Exception as e:
                logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å —Ä–∞—Å—Å—ã–ª–∫–∏: {e}")

    keyboard = [
        [InlineKeyboardButton("‚Ü©Ô∏è –í –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å", callback_data='admin_panel')],
        [InlineKeyboardButton("üè† –°—Ç–∞—Ä—Ç / –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data='back_to_main')]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    await status_message.edit_text(
        f"‚úÖ <b>–†–ê–°–°–´–õ–ö–ê –ó–ê–í–ï–†–®–ï–ù–ê</b>\n\n"
        f"–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: {total}\n"
        f"–£—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: {sent}\n"
        f"–û—à–∏–±–æ–∫: {failed}\n\n"
        f"<b>–¢–µ–∫—Å—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:</b>\n{broadcast_message}",
        reply_markup=reply_markup,
        parse_mode='HTML'
    )
    context.user_data.clear()
    logger.info(f"–†–∞—Å—Å—ã–ª–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞: –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ {sent}/{total}, –æ—à–∏–±–æ–∫ {failed}")

async def edit_broadcast_time(query, context):
    context.user_data['broadcast_step'] = 'time'
    keyboard = [
        [InlineKeyboardButton("‚ùå –û—Ç–º–µ–Ω–∞", callback_data='cancel_broadcast')],
        [InlineKeyboardButton("üè† –°—Ç–∞—Ä—Ç / –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data='back_to_main')]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    await safe_edit_message(
        query,
        "‚úèÔ∏è <b>–ò–ó–ú–ï–ù–ï–ù–ò–ï –í–†–ï–ú–ï–ù–ò</b>\n\n"
        "–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –≤—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö —Ä–∞–±–æ—Ç –≤ —Ñ–æ—Ä–º–∞—Ç–µ:\n"
        "`–î–î.–ú–ú –ß–ß:–ú–ú`\n"
        "–ü—Ä–∏–º–µ—Ä: `05.02 18:30`",
        reply_markup=reply_markup
    )

async def cancel_broadcast(query, context):
    context.user_data.clear()
    keyboard = [
        [InlineKeyboardButton("‚Ü©Ô∏è –í –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å", callback_data='admin_panel')],
        [InlineKeyboardButton("üè† –°—Ç–∞—Ä—Ç / –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data='back_to_main')]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    await safe_edit_message(
        query,
        "‚ùå <b>–†–ê–°–°–´–õ–ö–ê –û–¢–ú–ï–ù–ï–ù–ê</b>\n\n"
        "–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –Ω–µ –±—ã–ª–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∏–∫–æ–º—É.",
        reply_markup=reply_markup
    )

# ================== –û–ë–†–ê–ë–û–¢–ö–ê –°–û–û–ë–©–ï–ù–ò–ô ==================
async def handle_message(update: Update, context: CallbackContext):
    if not update.message or not update.message.text:
        return
    user = update.effective_user
    await asyncio.to_thread(
        db.update_user_and_log,
        user.id,
        'message',
        None,
        user.username,
        user.first_name,
        user.last_name,
        user.language_code
    )

    if await check_maintenance_mode(update, context):
        return

    if not isinstance(context.user_data, dict):
        context.user_data = {}

   # –û–±—Ä–∞–±–æ—Ç–∫–∞ –ò–ò-–ø–æ–º–æ—â–Ω–∏–∫–∞
    if context.user_data.get('awaiting_ai'):
        question = update.message.text
        thinking = await update.message.reply_text("ü§î –î—É–º–∞—é...")
        answer = await ask_gpt(question, update.effective_user.id)
        await thinking.edit_text(answer, parse_mode='HTML')
        # –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ –∏ –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º –∑–∞–¥–∞—Ç—å –µ—â—ë –≤–æ–ø—Ä–æ—Å
        keyboard = [
            [InlineKeyboardButton("‚ùì –ó–∞–¥–∞—Ç—å –µ—â—ë –≤–æ–ø—Ä–æ—Å", callback_data='menu_ai')],
            [InlineKeyboardButton("üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data='back_to_main')]
        ]
        await update.message.reply_text(
            "–ß—Ç–æ –¥–∞–ª—å—à–µ?",
            reply_markup=InlineKeyboardMarkup(keyboard)
        )
        context.user_data['awaiting_ai'] = False
        return

    if context.user_data.get('publishing_news') and update.effective_user.id in ADMIN_IDS:
        await handle_news_input(update, context)
        return

    if context.user_data.get('editing_news') and update.effective_user.id in ADMIN_IDS:
        await handle_edit_news_input(update, context)
        return

    if context.user_data.get('broadcasting') and context.user_data.get('broadcast_step') == 'time':
        await handle_broadcast_time(update, context)
        return

    if context.user_data.get('searching_teacher'):
        search_query = update.message.text.strip()
        if not search_query:
            await update.message.reply_text(
                "<b>‚ùå –ü—É—Å—Ç–æ–π –∑–∞–ø—Ä–æ—Å.</b>\n–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ —Ñ–∞–º–∏–ª–∏—é —É—á–∏—Ç–µ–ª—è –¥–ª—è –ø–æ–∏—Å–∫–∞.",
                parse_mode='HTML'
            )
            return

        all_teachers = ALL_TEACHERS
        found_teachers = []
        for teacher in all_teachers:
            if search_query.lower() in teacher.lower():
                found_teachers.append(teacher)

        if found_teachers:
            text = f"<b>üîç –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ –ø–æ –∑–∞–ø—Ä–æ—Å—É '{search_query}':</b>\n"
            keyboard = []
            for i, teacher in enumerate(found_teachers[:10]):
                button_text = teacher
                if len(teacher) > 20:
                    button_text = teacher[:18] + "..."
                keyboard.append([InlineKeyboardButton(button_text, callback_data=f'teacher_search_{i}')])

            context.user_data['found_teachers'] = found_teachers
            keyboard.append([InlineKeyboardButton("üîç –ù–æ–≤—ã–π –ø–æ–∏—Å–∫", callback_data='menu_search_teacher')])
            keyboard.append([InlineKeyboardButton("üè† –°—Ç–∞—Ä—Ç / –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data='back_to_main')])
            reply_markup = InlineKeyboardMarkup(keyboard)
            text += f"–ù–∞–π–¥–µ–Ω–æ —É—á–∏—Ç–µ–ª–µ–π: <b>{len(found_teachers)}</b>\n–í—ã–±–µ—Ä–∏—Ç–µ —É—á–∏—Ç–µ–ª—è –∏–∑ —Å–ø–∏—Å–∫–∞:"
            await update.message.reply_text(text, reply_markup=reply_markup, parse_mode='HTML')
        else:
            keyboard = [
                [InlineKeyboardButton("üîç –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞", callback_data='menu_search_teacher')],
                [InlineKeyboardButton("üë®‚Äçüè´ –í—Å–µ —É—á–∏—Ç–µ–ª—è", callback_data='menu_teacher')],
                [InlineKeyboardButton("üè† –°—Ç–∞—Ä—Ç / –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data='back_to_main')]
            ]
            reply_markup = InlineKeyboardMarkup(keyboard)
            await update.message.reply_text(
                f"<b>‚ùå –£—á–∏—Ç–µ–ª—è –ø–æ –∑–∞–ø—Ä–æ—Å—É '{search_query}' –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.</b>\n"
                f"–ü–æ–ø—Ä–æ–±—É–π—Ç–µ:\n"
                f"‚Ä¢ –£–∫–∞–∑–∞—Ç—å —Ç–æ–ª—å–∫–æ —Ñ–∞–º–∏–ª–∏—é\n"
                f"‚Ä¢ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å –Ω–∞–ø–∏—Å–∞–Ω–∏—è\n"
                f"‚Ä¢ –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ—Ö —É—á–∏—Ç–µ–ª–µ–π",
                reply_markup=reply_markup,
                parse_mode='HTML'
            )
            context.user_data['searching_teacher'] = False
    else:
        await handle_teacher_mentions(update, context)

async def handle_teacher_mentions(update: Update, context: CallbackContext):
    if not update.message or not update.message.text:
        return

    message_text = update.message.text
    user = update.message.from_user
    found_mentions = []

    for teacher_name, teacher_id in TEACHER_IDS.items():
        if not teacher_id or teacher_id == 0:
            continue
        surname = teacher_name.split()[0]
        pattern = r'\b' + re.escape(surname) + r'\b'
        if re.search(pattern, message_text, re.IGNORECASE):
            found_mentions.append((teacher_name, teacher_id))

    if not found_mentions:
        return

    for teacher_name, teacher_id in found_mentions:
        try:
            notification = (
                f"üîî –í–∞—Å —É–ø–æ–º—è–Ω—É–ª–∏ –≤ —à–∫–æ–ª—å–Ω–æ–º –±–æ—Ç–µ!\n"
                f"üë§ –û—Ç: {user.full_name}\n"
                f"üìÖ –í—Ä–µ–º—è: {datetime.now().strftime('%H:%M %d.%m.%Y')}\n"
                f"üí¨ –°–æ–æ–±—â–µ–Ω–∏–µ:\n"
                f"`{message_text[:300]}`\n"
                f"–ß—Ç–æ–±—ã –æ—Ç–≤–µ—Ç–∏—Ç—å, –Ω–∞–∂–º–∏—Ç–µ ¬´–û—Ç–≤–µ—Ç–∏—Ç—å¬ª –Ω–∞ —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ."
            )
            await context.bot.send_message(chat_id=teacher_id, text=notification, parse_mode='HTML')

            keyboard = [[InlineKeyboardButton("üè† –°—Ç–∞—Ä—Ç / –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data='back_to_main')]]
            reply_markup = InlineKeyboardMarkup(keyboard)
            await update.message.reply_text(
                f"‚úÖ –£—á–∏—Ç–µ–ª—å {teacher_name} –ø–æ–ª—É—á–∏–ª(–∞) —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –≤–∞—à–µ–º —Å–æ–æ–±—â–µ–Ω–∏–∏.",
                reply_markup=reply_markup,
                parse_mode='HTML'
            )
        except Exception as e:
            error_msg = str(e)
            logger.error(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è {teacher_name}: {error_msg}")
            keyboard = [[InlineKeyboardButton("üè† –°—Ç–∞—Ä—Ç / –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data='back_to_main')]]
            reply_markup = InlineKeyboardMarkup(keyboard)
            if "chat not found" in error_msg.lower():
                await update.message.reply_text(
                    f"‚ö†Ô∏è –£—á–∏—Ç–µ–ª—å {teacher_name} –Ω–µ –Ω–∞—á–∞–ª –¥–∏–∞–ª–æ–≥ —Å –±–æ—Ç–æ–º. "
                    f"–ü–æ–ø—Ä–æ—Å–∏—Ç–µ –µ–≥–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å /start –±–æ—Ç—É.",
                    reply_markup=reply_markup,
                    parse_mode='HTML'
                )
            elif "blocked" in error_msg.lower():
                await update.message.reply_text(
                    f"‚ö†Ô∏è –£—á–∏—Ç–µ–ª—å {teacher_name} –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª –±–æ—Ç–∞.",
                    reply_markup=reply_markup,
                    parse_mode='HTML'
                )
            else:
                await update.message.reply_text(
                    f"‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ {teacher_name}: {error_msg[:100]}",
                    reply_markup=reply_markup,
                    parse_mode='HTML'
                )

async def test_notification(update: Update, context: CallbackContext):
    if update.effective_user.id not in ADMIN_IDS:
        await update.message.reply_text("‚ùå –¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã –º–æ–≥—É—Ç —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è.", parse_mode='HTML')
        return

    if not context.args:
        teachers_list = "\n".join([f"‚Ä¢ {teacher}" for teacher in TEACHER_IDS.keys()])
        await update.message.reply_text(
            f"–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: /test [—Ñ–∞–º–∏–ª–∏—è —É—á–∏—Ç–µ–ª—è]\n"
            f"–î–æ—Å—Ç—É–ø–Ω—ã–µ —É—á–∏—Ç–µ–ª—è:\n{teachers_list}",
            parse_mode='HTML'
        )
        return

    teacher_name = context.args[0]
    found_teacher = None
    for teacher in TEACHER_IDS.keys():
        if teacher_name.lower() in teacher.lower():
            found_teacher = teacher
            break

    if not found_teacher:
        await update.message.reply_text(f"‚ùå –£—á–∏—Ç–µ–ª—å '{teacher_name}' –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Å–ø–∏—Å–∫–µ.", parse_mode='HTML')
        return

    teacher_id = TEACHER_IDS[found_teacher]
    if not teacher_id or teacher_id == 0:
        await update.message.reply_text(f"‚ùå –î–ª—è —É—á–∏—Ç–µ–ª—è '{found_teacher}' –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω ID.", parse_mode='HTML')
        return

    try:
        test_message = (
            f"üîî –¢–ï–°–¢–û–í–û–ï –£–í–ï–î–û–ú–õ–ï–ù–ò–ï\n"
            f"üë®‚Äçüíª –û—Ç: –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –±–æ—Ç–∞\n"
            f"üïê –í—Ä–µ–º—è: {datetime.now().strftime('%H:%M %d.%m.%Y')}\n"
            f"‚úÖ –°–∏—Å—Ç–µ–º–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ!\n"
            f"–≠—Ç–æ —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–±–æ—Ç—ã –±–æ—Ç–∞."
        )
        await context.bot.send_message(chat_id=teacher_id, text=test_message, parse_mode='HTML')
        keyboard = [[InlineKeyboardButton("üè† –°—Ç–∞—Ä—Ç / –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data='back_to_main')]]
        reply_markup = InlineKeyboardMarkup(keyboard)
        await update.message.reply_text(
            f"‚úÖ –¢–µ—Å—Ç–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —É—á–∏—Ç–µ–ª—é {found_teacher} (ID: {teacher_id})",
            reply_markup=reply_markup,
            parse_mode='HTML'
        )
    except Exception as e:
        error_msg = str(e)
        logger.error(f"–û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏: {error_msg}")
        keyboard = [[InlineKeyboardButton("üè† –°—Ç–∞—Ä—Ç / –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data='back_to_main')]]
        reply_markup = InlineKeyboardMarkup(keyboard)
        if "chat not found" in error_msg.lower():
            await update.message.reply_text(
                f"‚ùå –£—á–∏—Ç–µ–ª—å {found_teacher} –Ω–µ –Ω–∞—á–∞–ª –¥–∏–∞–ª–æ–≥ —Å –±–æ—Ç–æ–º.\n"
                f"–ü–æ–ø—Ä–æ—Å–∏—Ç–µ –µ–≥–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–º–∞–Ω–¥—É /start –±–æ—Ç—É.",
                reply_markup=reply_markup,
                parse_mode='HTML'
            )
        else:
            await update.message.reply_text(
                f"‚ùå –û—à–∏–±–∫–∞: {error_msg[:100]}",
                reply_markup=reply_markup,
                parse_mode='HTML'
            )

async def teachers_list(update: Update, context: CallbackContext):
    all_teachers = ALL_TEACHERS
    if not all_teachers:
        await update.message.reply_text(
            "‚ùå –°–ø–∏—Å–æ–∫ —É—á–∏—Ç–µ–ª–µ–π –ø—É—Å—Ç.",
            parse_mode='HTML'
        )
        return

    teachers_text = "üë®‚Äçüè´ <b>–°–ü–ò–°–û–ö –£–ß–ò–¢–ï–õ–ï–ô:</b>\n"
    for i, teacher in enumerate(all_teachers, 1):
        teachers_text += f"{i}. {teacher}\n"
        if i % 10 == 0:
            teachers_text += "\n"

    keyboard = [
        [InlineKeyboardButton("üîç –ü–æ–∏—Å–∫ —É—á–∏—Ç–µ–ª—è", callback_data='menu_search_teacher')],
        [InlineKeyboardButton("üìã –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ —É—á–∏—Ç–µ–ª–µ–π", callback_data='menu_teacher')],
        [InlineKeyboardButton("üè† –°—Ç–∞—Ä—Ç / –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data='back_to_main')]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    await update.message.reply_text(
        teachers_text,
        reply_markup=reply_markup,
        parse_mode='HTML'
    )

# ================== –ì–õ–ê–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø ==================
def main():
    try:
        db.init_db()
        db.init_pool()
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ë–î: {e}")
        print(f"‚ùå –û—à–∏–±–∫–∞ –ë–î: {e}")
        exit(1)

    application = (
        Application.builder()
        .token(TOKEN)
        .read_timeout(REQUEST_TIMEOUT)
        .write_timeout(REQUEST_TIMEOUT)
        .connect_timeout(REQUEST_TIMEOUT)
        .pool_timeout(REQUEST_TIMEOUT)
        .build()
    )

    application.add_handler(CommandHandler("start", start))
    application.add_handler(CommandHandler("test", test_notification))
    application.add_handler(CommandHandler("teachers", teachers_list))
    application.add_handler(CallbackQueryHandler(button_handler))
    application.add_handler(
        MessageHandler(
            filters.TEXT & ~filters.COMMAND,
            handle_message
        )
    )

    print("ü§ñ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω...")
    print(f"üìä –í—Å–µ–≥–æ —É—á–∏—Ç–µ–ª–µ–π –≤ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–∏: {len(ALL_TEACHERS)}")
    print(f"üëë –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã: {ADMIN_IDS}")
    print(f"‚è±Ô∏è –¢–∞–π–º–∞—É—Ç—ã —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –Ω–∞: {REQUEST_TIMEOUT} —Å–µ–∫")
    print(f"üåç –ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å: Europe/Minsk (UTC+3)")
    print(f"üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ –±–∞–∑–µ: {db.get_user_count()}")
    print(f"‚úÖ –§—É–Ω–∫—Ü–∏–∏: –Ω–æ–≤–æ—Å—Ç–∏, –∏–∑–±—Ä–∞–Ω–Ω–æ–µ, –∑–∞–º–µ–Ω—ã, —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è, –ò–ò-–ø–æ–º–æ—â–Ω–∏–∫")
    
    # ‚úÖ –ü–†–û–í–ï–†–ö–ê API-–ö–õ–Æ–ß–ê (—Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º –æ—Ç—Å—Ç—É–ø–æ–º!)
    if not GROQ_API_KEY:
        print("‚ö†Ô∏è –ò–ò-–ø–æ–º–æ—â–Ω–∏–∫ –æ—Ç–∫–ª—é—á—ë–Ω (–Ω–µ –∑–∞–¥–∞–Ω GROQ_API_KEY)")
    else:
        print(f"‚úÖ –ò–ò-–ø–æ–º–æ—â–Ω–∏–∫ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω (Groq: {GROQ_MODEL})")

    try:
        application.run_polling(
            allowed_updates=Update.ALL_TYPES,
            drop_pending_updates=True
        )
    except KeyboardInterrupt:
        print("\nüõë –ë–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º")
    except Exception as e:
        print(f"‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: {e}")
        logger.critical(f"–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: {e}")

if __name__ == '__main__':
    main()
